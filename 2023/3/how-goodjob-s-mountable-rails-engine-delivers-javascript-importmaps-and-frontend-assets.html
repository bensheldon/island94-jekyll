<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>How GoodJob&amp;#39;s mountable Rails Engine delivers Javascript importmaps and frontend assets | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="i9EI2JIQDVIAcblMq5VvnuxrabNAxDH7gI5hLIoTL2u8HzUfyYD0j6mV3GcpKx8gzYY10DLFPVvLmobfGY6n9Q" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-3c56ab95cf55e7f461f0ea9391c2b1391a5c64b74433224fe76ad58b7fa20c07.css" data-turbo-track="reload" />
  <script src="/assets/main-57967bd29e3a27ba3099fee5997ee6ec8c59ef209085f949b6eac799b21915b0.js"></script>

  <script>
    let theme = localStorage.getItem('theme');
    if (!["light", "dark"].includes(theme)) {
      theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    document.documentElement.setAttribute('data-bs-theme', theme);
  </script>

  
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown">
          <button id="bs-theme" class="btn btn-link nav-link dropdown-toggle" type="button" aria-expanded="false" data-bs-toggle="dropdown"  aria-label="Theme (Auto)">
            <i data-bs-theme-active-icon class="bi bi-circle-half"></i>
            <span data-bs-theme-label>Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bs-theme-text">
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="light" aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="dark" aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="auto" aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <input id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
        <button class="visually-hidden" type="submit">Search</button>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/A-Commonplace-Book.html">commonplace book</a>.
    </div>
  </div>
</nav>


  <div class="container container-body">
    
<div class="container container-body">
  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2023/3/how-goodjob-s-mountable-rails-engine-delivers-javascript-importmaps-and-frontend-assets"><p>How GoodJob’s mountable Rails Engine delivers Javascript importmaps and frontend assets</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2023-03-20T08:27:00-07:00" itemprop="datePublished">March 20, 2023</time>

        • Tagged GoodJob
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="https://github.com/bensheldon/good_job">GoodJob</a> is a multithreaded, Postgres-based ActiveJob backend for Ruby on Rails.</p>

<p>GoodJob includes a full-featured (though optional) web dashboard to monitor and administer background jobs. The web dashboard is included in the <code>good_job</code> gem as a mountable Rails Engine.</p>

<p>As the maintainer of GoodJob, I want to make gem development easier for myself by innovating as little as possible. That’s why GoodJob builds on top of Active Record and Concurrent::Ruby.</p>

<p>But, the frontend can be a beast. When thinking about how to build a full-featured web dashboard <em>packaged within a Rails Engine within a gem</em>, I had three goals:</p>

<ol>
  <li><strong>Be asset pipeline agnostic with zero dependencies.</strong> As of Rails ~7.0, a Rails developer can choose between several different asset pipeline tools (Sprockets, Webpacker/Shakapacker, esbuild/jsbundling, etc.). That’s too many! I want to ensure what I package with GoodJob is compatible with all of them. I also don’t want to affect the parent application at all; everything must be independent and self-contained.</li>
  <li><strong>Allow easy patching/debugging.</strong> I want the GoodJob web dashboard to work when using the Git repo directly in a project’s Gemfile or simply <code>bundle open good_job</code> to debug a problem.</li>
  <li><strong>Write contemporary frontend code.</strong> I want to use Bootstrap UI, Stimulus, Rails UJS, and write modular JavaScript with imports. Maybe even Turbo!</li>
</ol>

<p>And of course, I want GoodJob to be secure, performant, and a joy to develop and use for myself and the developer community.</p>

<p>Read on for how I achieved it all (mostly!) with GoodJob.</p>

<h2 id="what-i-didnt-do">What I didn’t do</h2>

<p>Here’s all the things I considered, but decided not to do:</p>

<ul>
  <li><strong>Nope: Manually construct/inline a small number of javascript files</strong>: I did not want to manually build a javascript file, copy-pasting various various 3rd-party libraries into a single file, and then writing my code at the bottom. This seemed laborious and prone to error, especially when I would need to update a library; and my IDE doesn’t work well with large files so writing my own code would be difficult.</li>
  <li><strong>Nope: Precompile javascript in the repository or on gem build:</strong> I did not want to force a pre-commit step to build javascript, or to only package built javascript into the gem because that would make patching and debugging difficult. Over my career I’ve struggled contributing to a number of otherwise fantastic gems that use this workflow pattern.</li>
  <li><strong>Nope: Compile javascript in the application:</strong> Rails has too many different asset pipeline patterns right now for me to consider supporting them all. I consider this more a result of a highly fragmented frontend ecosystem than an indictment of Rails. I can’t imagine supporting all of the different options and whatever else shows up in the future at the same time. (I’m in awe of the gems that do; nice work <code>rails_admin</code>!)</li>
</ul>

<h2 id="what-i-did-do">What I did do</h2>

<p>As I wrote earlier: “innovate as little as possible”:</p>

<p><strong>Serve vanilla JS and CSS out of vanilla Routes/Controller</strong></p>

<p>GoodJob has explicit routes for frontend assets that wire up to a controller that serves those assets statically with <code>render :file</code>. Let’s break that down…</p>

<p>In my Rails Engine’s router, I define a namescape, <code>frontend</code>, and two <code>get</code> routes. The first route, <code>modules</code> , is for Javascript modules that will go into the importmap. The second route, <code>static</code> , is for Javascript and CSS that I’ll link/script directly in the HTML head.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>
<span class="n">scope</span> <span class="ss">:frontend</span><span class="p">,</span> <span class="ss">controller: :frontends</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"modules/:name"</span><span class="p">,</span> <span class="ss">action: :module</span><span class="p">,</span> <span class="ss">as: :frontend_module</span><span class="p">,</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">format: </span><span class="s1">'js'</span> <span class="p">}</span>
  <span class="n">get</span> <span class="s2">"static/:name"</span><span class="p">,</span> <span class="ss">action: :static</span><span class="p">,</span> <span class="ss">as: :frontend_static</span><span class="p">,</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">format: </span><span class="sx">%w[css js]</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In the matching controller, I create static constants that define hashes of files that are matched and served, which I store in a <code>app/frontend</code> directory in my Rails Engine. <em>I want paths to be explicit for security reasons because passing any sort of dynamic file path through the URL could be a path traversal vulnerability.</em> All of the frontend assets are stored in  <code>app/frontend</code> and served out of this controller:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/good_job/frontends_controller.rb</span>

<span class="k">module</span> <span class="nn">GoodJob</span>
  <span class="k">class</span> <span class="nc">FrontendsController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span> <span class="c1"># rubocop:disable Rails/ApplicationController</span>
    <span class="no">STATIC_ASSETS</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">css: </span><span class="p">{</span>
        <span class="ss">bootstrap: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"vendor"</span><span class="p">,</span> <span class="s2">"bootstrap"</span><span class="p">,</span> <span class="s2">"bootstrap.min.css"</span><span class="p">),</span>
        <span class="ss">style: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"style.css"</span><span class="p">),</span>
      <span class="p">},</span>
      <span class="ss">js: </span><span class="p">{</span>
        <span class="ss">bootstrap: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"vendor"</span><span class="p">,</span> <span class="s2">"bootstrap"</span><span class="p">,</span> <span class="s2">"bootstrap.bundle.min.js"</span><span class="p">),</span>
        <span class="ss">chartjs: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"vendor"</span><span class="p">,</span> <span class="s2">"chartjs"</span><span class="p">,</span> <span class="s2">"chart.min.js"</span><span class="p">),</span>
        <span class="ss">es_module_shims: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"vendor"</span><span class="p">,</span> <span class="s2">"es_module_shims.js"</span><span class="p">),</span>
        <span class="ss">rails_ujs: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"vendor"</span><span class="p">,</span> <span class="s2">"rails_ujs.js"</span><span class="p">),</span>
      <span class="p">},</span>
    <span class="p">}.</span><span class="nf">freeze</span>

		<span class="c1"># Additional JS modules that don't live in app/frontend/good_job/modules</span>
    <span class="no">MODULE_OVERRIDES</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">application: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"application.js"</span><span class="p">),</span>
      <span class="ss">stimulus: </span><span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"vendor"</span><span class="p">,</span> <span class="s2">"stimulus.js"</span><span class="p">),</span>
    <span class="p">}.</span><span class="nf">freeze</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">js_modules</span>
      <span class="vi">@_js_modules</span> <span class="o">||=</span> <span class="no">GoodJob</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"frontend"</span><span class="p">,</span> <span class="s2">"good_job"</span><span class="p">,</span> <span class="s2">"modules"</span><span class="p">).</span><span class="nf">children</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:file?</span><span class="p">).</span><span class="nf">each_with_object</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="p">,</span> <span class="n">modules</span><span class="o">|</span>
        <span class="n">key</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">basename</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="s2">".js"</span><span class="p">).</span><span class="nf">to_sym</span>
        <span class="n">modules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>
      <span class="k">end</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="no">MODULE_OVERRIDES</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Necessarly to serve Javascript to the browser</span>
		<span class="n">skip_after_action</span> <span class="ss">:verify_same_origin_request</span><span class="p">,</span> <span class="ss">raise: </span><span class="kp">false</span>
    <span class="n">before_action</span> <span class="p">{</span> <span class="n">expires_in</span> <span class="mi">1</span><span class="p">.</span><span class="nf">year</span><span class="p">,</span> <span class="ss">public: </span><span class="kp">true</span> <span class="p">}</span>

    <span class="k">def</span> <span class="nf">static</span>
      <span class="n">render</span> <span class="ss">file: </span><span class="no">STATIC_ASSETS</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:format</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">)</span> <span class="o">||</span> <span class="k">raise</span><span class="p">(</span><span class="no">ActionController</span><span class="o">::</span><span class="no">RoutingError</span><span class="p">,</span> <span class="s1">'Not Found'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">module</span>
      <span class="k">raise</span><span class="p">(</span><span class="no">ActionController</span><span class="o">::</span><span class="no">RoutingError</span><span class="p">,</span> <span class="s1">'Not Found'</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:format</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"js"</span>

      <span class="n">render</span> <span class="ss">file: </span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">js_modules</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">||</span> <span class="k">raise</span><span class="p">(</span><span class="no">ActionController</span><span class="o">::</span><span class="no">RoutingError</span><span class="p">,</span> <span class="s1">'Not Found'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>One downside of this is that I’m unable to use Sass or Typescript or anything that isn’t vanilla CSS or Javascript. So far I haven’t missed that too much; Bootstrap brings a very comprehensive design system and Rubymine is pretty good at hinting Javscript on its own.</p>

<p>Another downside is that I package several hundred kilobytes of frontend code within my gem. This increases the gem size, which is a real bummer if an application isn’t mounting the dashboard. I’ve considered separating the optional dashboard into a separate gem, but I’m deferring that until anyone notices that it’s problematic (so far so good!).</p>

<p><strong>Manually link assets and construct a JS importmaps in my Engine’s layout <code>&lt;head&gt;</code></strong></p>

<p>Having created the routes and controller actions, I can simply link the static files in the layout html header:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/layouts/good_job/application.html.erg --&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;</span><span class="err">%</span><span class="na">#</span> <span class="na">Note:</span> <span class="na">Do</span> <span class="na">not</span> <span class="na">use</span> <span class="na">asset</span> <span class="na">tag</span> <span class="na">helpers</span> <span class="na">to</span> <span class="na">avoid</span> <span class="na">paths</span> <span class="na">being</span> <span class="na">overriden</span> <span class="na">by</span> <span class="na">config.asset_host</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.link</span> <span class="na">rel:</span> <span class="err">"</span><span class="na">stylesheet</span><span class="err">",</span> <span class="na">href:</span> <span class="na">frontend_static_path</span><span class="err">(</span><span class="na">:bootstrap</span><span class="err">,</span> <span class="na">format:</span> <span class="na">:css</span><span class="err">,</span> <span class="na">v:</span> <span class="na">GoodJob::VERSION</span><span class="err">,</span> <span class="na">locale:</span> <span class="na">nil</span><span class="err">),</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.link</span> <span class="na">rel:</span> <span class="err">"</span><span class="na">stylesheet</span><span class="err">",</span> <span class="na">href:</span> <span class="na">frontend_static_path</span><span class="err">(</span><span class="na">:style</span><span class="err">,</span> <span class="na">format:</span> <span class="na">:css</span><span class="err">,</span> <span class="na">v:</span> <span class="na">GoodJob::VERSION</span><span class="err">,</span> <span class="na">locale:</span> <span class="na">nil</span><span class="err">),</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span> <span class="err">%</span><span class="nt">&gt;</span>
	
  <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.script</span> <span class="err">"",</span> <span class="na">src:</span> <span class="na">frontend_static_path</span><span class="err">(</span><span class="na">:bootstrap</span><span class="err">,</span> <span class="na">format:</span> <span class="na">:js</span><span class="err">,</span> <span class="na">v:</span> <span class="na">GoodJob::VERSION</span><span class="err">,</span> <span class="na">locale:</span> <span class="na">nil</span><span class="err">),</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.script</span> <span class="err">"",</span> <span class="na">src:</span> <span class="na">frontend_static_path</span><span class="err">(</span><span class="na">:chartjs</span><span class="err">,</span> <span class="na">format:</span> <span class="na">:js</span><span class="err">,</span> <span class="na">v:</span> <span class="na">GoodJob::VERSION</span><span class="err">,</span> <span class="na">locale:</span> <span class="na">nil</span><span class="err">),</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.script</span> <span class="err">"",</span> <span class="na">src:</span> <span class="na">frontend_static_path</span><span class="err">(</span><span class="na">:rails_ujs</span><span class="err">,</span> <span class="na">format:</span> <span class="na">:js</span><span class="err">,</span> <span class="na">v:</span> <span class="na">GoodJob::VERSION</span><span class="err">,</span> <span class="na">locale:</span> <span class="na">nil</span><span class="err">),</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span> <span class="err">%</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Beneath this, I manually construct the JSON the browser expects for importmaps:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Link es_module_shims --&gt;</span>
<span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.script</span> <span class="err">"",</span> <span class="na">src:</span> <span class="na">frontend_static_path</span><span class="err">(</span><span class="na">:es_module_shims</span><span class="err">,</span> <span class="na">format:</span> <span class="na">:js</span><span class="err">,</span> <span class="na">v:</span> <span class="na">GoodJob::VERSION</span><span class="err">,</span> <span class="na">locale:</span> <span class="na">nil</span><span class="err">),</span> <span class="na">async:</span> <span class="na">true</span><span class="err">,</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span> <span class="err">%</span><span class="nt">&gt;</span>

<span class="c">&lt;!-- Construct the importmaps JSON object --&gt;</span>
<span class="nt">&lt;</span><span class="err">%</span> <span class="na">importmaps = </span><span class="s">GoodJob::FrontendsController.js_modules.keys.index_with</span> <span class="err">{</span> <span class="err">|</span><span class="na">module_name</span><span class="err">|</span> <span class="na">frontend_module_path</span><span class="err">(</span><span class="na">module_name</span><span class="err">,</span> <span class="na">format:</span> <span class="na">:js</span><span class="err">,</span> <span class="na">locale:</span> <span class="na">nil</span><span class="err">,</span> <span class="na">v:</span> <span class="na">GoodJob::VERSION</span><span class="err">)</span> <span class="err">}</span> <span class="err">%</span><span class="nt">&gt;</span>
<span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.script</span><span class="err">({</span> <span class="na">imports:</span> <span class="na">importmaps</span> <span class="err">}.</span><span class="na">to_json.html_safe</span><span class="err">,</span> <span class="na">type:</span> <span class="err">"</span><span class="na">importmap</span><span class="err">",</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span><span class="err">)</span> <span class="err">%</span><span class="nt">&gt;</span>

<span class="c">&lt;!-- Import the entrypoint: application.js --&gt;</span>
<span class="nt">&lt;</span><span class="err">%=</span> <span class="na">tag.script</span> <span class="err">"",</span> <span class="na">type:</span> <span class="err">"</span><span class="na">module</span><span class="err">",</span> <span class="na">nonce:</span> <span class="na">content_security_policy_nonce</span> <span class="na">do</span> <span class="err">%</span><span class="nt">&gt;</span> import "application"; <span class="nt">&lt;</span><span class="err">%</span> <span class="na">end</span> <span class="err">%</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h3 id="thats-it">That’s it!</h3>

<p>I’ll admit, serving frontend assets using <code>render file:</code> is boring, but I experienced a thrill the first time I wired up the importmaps and <em>it just worked</em>. Writing small Javascript modules and using <code>import</code> directives is really nice. I recently added Stimulus and I’m feeling optimistic that I could reliably implement Turbo in my gem’s Rails Engine fully decoupled from the parent application.</p>

<p>I hope this post about GoodJob inspires you to build full-featured web frontends for your own gems and libraries.</p>

  </div>
</article>


  <div class="card my-4">
    <div class="card-body">
      Discuss this with me on <a href="https://twitter.com/bensheldon"><i class="bi bi-twitter"></i> Twitter</a>
      or suggest a
      <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2023-03-20-how-goodjob-s-mountable-rails-engine-delivers-javascript-importmaps-and-frontend-assets.md"><i class="bi bi-github"></i>
        change</a>.
    </div>
      <hr>
      <div class="card-body">
        <h5>Related Posts</h5>
        <ul>
            <li><a href="/2024/7/introducing-goodjob-v4">Introducing GoodJob v4</a></li>
            <li><a href="/2023/12/solid-queue-first-impressions">Solid Queue first impressions: Nice!</a></li>
            <li><a href="/2023/10/reflections-on-good-job-for-solid-queue">Reflections on GoodJob for Solid Queue</a></li>
            <li><a href="/2023/8/how-to-isolate-i18n-configuration-in-a-rails-engine">How to isolate I18n configuration in a Rails Engine</a></li>
            <li><a href="/2023/5/rebuilding-concurrent-ruby-scheduledtask-event-and-timerset">Rebuilding Concurrent Ruby: ScheduledTask, Event, and TimerSet</a></li>
        </ul>
    </div>
  </div>
</div>

  </div>

</body>
</html>
