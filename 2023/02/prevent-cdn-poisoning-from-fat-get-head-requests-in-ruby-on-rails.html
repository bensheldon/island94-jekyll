<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script>
    let theme = localStorage.getItem('theme');
    if (!["light", "dark"].includes(theme)) {
      theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    document.documentElement.setAttribute('data-bs-theme', theme);
  </script>

  <link rel="stylesheet" href="/assets/stylesheets/main.css">
  <script src="/assets/javascripts/main.js"></script>

  <title>Prevent CDN poisoning from Fat GET/HEAD Requests in Ruby on Rails</title>
  <meta name="description" content="There are many different flavors of web cache poisoning discovered by Security Researcher James Kettle. Read on for an explanation of one I’ve run across…">

  <link rel="canonical" href="https://island94.org/2023/02/prevent-cdn-poisoning-from-fat-get-head-requests-in-ruby-on-rails">

  <link rel="alternate" type="application/rss+xml" title="Island94.org Posts" href="https://island94.org/feed.xml">
  <link rel="alternate" type="application/rss+xml" title="Island94.org Book Reviews" href="https://island94.org/books.xml">

  
</head>


  <body>

    <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link " href="/about/">About</a></li>
        <li class="nav-item"><a class="nav-link " href="/archives/">Archives</a></li>
        <li class="nav-item"><a class="nav-link " href="/books/">Books</a></li>
        <li class="nav-item"><a class="nav-link " href="/tags/">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown">
          <button id="bs-theme" class="btn btn-link nav-link dropdown-toggle" type="button" aria-expanded="false" data-bs-toggle="dropdown"  aria-label="Theme (Auto)">
            <i data-bs-theme-active-icon class="bi bi-circle-half"></i>
            <span data-bs-theme-label>Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bs-theme-text">
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="light" aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="dark" aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="auto" aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <input id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
        <button class="visually-hidden" type="submit">Search</button>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/A-Commonplace-Book.html">commonplace book</a>.
    </div>
  </div>
</nav>


    <div class="container container-body">
      



<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2023/02/prevent-cdn-poisoning-from-fat-get-head-requests-in-ruby-on-rails"><p>Prevent CDN poisoning from Fat GET/HEAD Requests in Ruby on Rails</p>
</a>
    </h1>
    <p class="post-meta text-muted">
      <time datetime="2023-02-12T20:32:00+00:00" itemprop="datePublished">February 12, 2023</time>
      
      


  

  

  • Tagged <a href="/tags/#rails">rails</a>


    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>There are many different flavors of <a href="https://portswigger.net/research/web-cache-entanglement">web cache poisoning discovered by Security Researcher James Kettle</a>. Read on for an explanation of one I’ve run across…</p>

<p><strong>What is a Fat GET/HEAD Request?</strong> A GET or HEAD request is “fat” when it has a request body. It’s unexpected! Typically one sees a request body with a POST or PUT request because the body contains form data. The HTTP specification says that including a request body with GET or HEAD requests is <a href="https://stackoverflow.com/a/983458"><em>undefined</em></a>. You can do it, and it’s up to the application to figure out what that means. Sometimes it’s bad!</p>

<p>You can get a sense of the applications that intentionally support Fat Requests (and how grumpy it makes some people) by reading through this <a href="https://github.com/postmanlabs/postman-app-support/issues/131">Postman issue</a>.</p>

<p><strong>Fat Requests can lead to CDN and cache poisoning in Rails.</strong> CDNs and caching web proxies (like Varnish) are frequently configured to cache the response from a GET or HEAD request based solely on the request’s URL and not the contents of the request body (they don’t cache POSTs or PUTs at all). If an application isn’t deliberately handling the request body, it may cause unexpected content to be cached and served.</p>

<p>For example, you have a <code class="language-plaintext highlighter-rouge">/search</code> endpoint:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">GET /search</code> shows a landing page with some explanatory content</li>
  <li><code class="language-plaintext highlighter-rouge">GET /search?q=foo</code> shows the search results for “foo”.</li>
  <li>
    <p>Here’s what a Fat Request looks like:</p>

    <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /search     &lt;== the url for the landing page

q=verybadstuff  &lt;== oh, but with a request body
</code></pre></div>    </div>
  </li>
</ul>

<p>In a Rails Controller, <code class="language-plaintext highlighter-rouge">parameters</code> (alias <code class="language-plaintext highlighter-rouge">params</code>) merges query parameters (that’s the URL values) with request parameters (that’s the body values) into a single data structure. If your controller uses the presence of <code class="language-plaintext highlighter-rouge">params[:q]</code> to determine whether to show the landing page or the search results, it’s possible that when someone sends that Fat Request, your CDN may cache and subsequently serve the results for <code class="language-plaintext highlighter-rouge">verybadstuff</code> every time someone visits the <code class="language-plaintext highlighter-rouge">/search</code> landing page. That’s bad!</p>

<p>Here’s how to Curl it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-XGET</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded"</span> <span class="nt">-d</span> <span class="s2">"q=verybadstuff"</span> http://localhost:3000/search
</code></pre></div></div>

<p>Here are 3 ways to fix it…</p>

<h2 id="solution-1-fix-at-the-cdn">Solution #1: Fix at the CDN</h2>

<p>The most straightforward place to fix this should be at the caching layer, but it’s not always easy.</p>

<p>With Cloudflare, you could rewrite the GET request’s <code class="language-plaintext highlighter-rouge">Content-Type</code> header if it is <code class="language-plaintext highlighter-rouge">application/x-www-form-urlencoded</code> or <code class="language-plaintext highlighter-rouge">multipart/form-data</code>. Or use a Cloudflare Worker to drop the request body.</p>

<p>Varnish makes it easy to drop the request body for any GET request.</p>

<p>Other CDNs or proxies may be easier or more difficult. It depends!</p>

<p>Update via <a href="https://github.com/Mr0grog">Mr0grog</a>: AWS Cloudfront returns a <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/RequestAndResponseBehaviorCustomOrigin.html#RequestCustom-get-body">403 by default</a>.</p>

<h2 id="solution-2-deliberately-use-query_parameters">Solution #2: Deliberately use <code class="language-plaintext highlighter-rouge">query_parameters</code></h2>

<p>Rails provides three different methods for accessing parameters:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">query_parameters</code> for the values in the request URL</li>
  <li><code class="language-plaintext highlighter-rouge">request_parameters</code> ) for the values in the request body</li>
  <li><code class="language-plaintext highlighter-rouge">parameters</code> (alias <code class="language-plaintext highlighter-rouge">params</code>) for the problematic combination of them both. Values in <code class="language-plaintext highlighter-rouge">query_parameters</code> take precedence over values in <code class="language-plaintext highlighter-rouge">request_parameters</code> when they are merged together.</li>
</ul>

<p>Developers could be diligent and make sure to only use <code class="language-plaintext highlighter-rouge">query_parameters</code> in <code class="language-plaintext highlighter-rouge">#index</code> or <code class="language-plaintext highlighter-rouge">#show</code> , or <code class="language-plaintext highlighter-rouge">get</code> routed actions. Here’s an example from the <a href="https://github.com/git/git-scm.com/issues/1551"><code class="language-plaintext highlighter-rouge">git-scm</code> project</a>.</p>

<h2 id="solution-3-patch-rails">Solution #3: Patch Rails</h2>

<p>Changes were <a href="https://github.com/rails/rails/issues/39974">proposed in Rails</a> to not have <code class="language-plaintext highlighter-rouge">parameters</code> merge in the body values for GET and HEAD requests; it was rejected because it’s more a problem with the upstream cache than it is with Rails.</p>

<p>You can patch your own version of Rails. Here’s an example that patches the method in <a href="https://github.com/rails/rails/blob/21a3b52ba0b7d94b4903e02b6ac537a7d1d1c817/actionpack/lib/action_dispatch/http/parameters.rb#L49-L63"><code class="language-plaintext highlighter-rouge">ActionDispatch::Request</code></a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/sanitize_fat_requests.rb</span>
<span class="k">module</span> <span class="nn">SanitizeFatRequests</span>
  <span class="k">def</span> <span class="nf">parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">get_header</span><span class="p">(</span><span class="s2">"action_dispatch.request.parameters"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span> <span class="k">if</span> <span class="n">params</span>

    <span class="k">if</span> <span class="n">get?</span> <span class="o">||</span> <span class="n">head?</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">query_parameters</span><span class="p">.</span><span class="nf">dup</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">path_parameters</span><span class="p">)</span>
      <span class="n">set_header</span><span class="p">(</span><span class="s2">"action_dispatch.request.parameters"</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
      <span class="n">params</span>
    <span class="k">else</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">alias</span> <span class="ss">:params</span> <span class="ss">:parameters</span>
<span class="k">end</span>

<span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">include</span><span class="p">(</span><span class="no">SanitizeFatRequests</span><span class="p">)</span>

<span class="c1"># Some RSpec tests to verify this</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">SanitizeFatRequests</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'does not merge body params in GET requests'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s2">"/search"</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span><span class="s1">'CONTENT_TYPE'</span> <span class="o">=&gt;</span> <span class="s1">'application/x-www-form-urlencoded'</span><span class="p">},</span> <span class="ss">env: </span><span class="p">{</span><span class="s1">'rack.input'</span><span class="p">:</span> <span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'q=verybadstuff'</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># verify that the request is correctly shaped because</span>
    <span class="c1"># the test helpers don't expect this kind of request</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">request_parameters</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"q"</span> <span class="o">=&gt;</span> <span class="s2">"verybadstuff"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">parameters</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">({</span><span class="s2">"action"</span><span class="o">=&gt;</span><span class="s2">"panlexicon"</span><span class="p">,</span> <span class="s2">"controller"</span><span class="o">=&gt;</span><span class="s2">"search"</span><span class="p">})</span>

    <span class="c1"># the behavioral expectation</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">not_to</span> <span class="kp">include</span> <span class="s2">"verybadstuff"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>


  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    <p>
      Discuss this with me on <a href="https://twitter.com/bensheldon"><i class="bi bi-twitter"></i> Twitter</a>
      or suggest a <a href="https://github.com/bensheldon/island94-jekyll/blob/main/_posts/2023-02-12-prevent-cdn-poisoning-from-fat-get-head-requests-in-ruby-on-rails.md"><i class="bi bi-github"></i> change</a>.
    </p>

    <p>Related Posts:</p>
    <ul>
      
        <li><a href="/2024/10/technical-reflection-on-disaster-relief-assistance-for-immigrants">A mostly technical reflection on Disaster Relief Assistance for Immigrants</a></li>
      
        <li><a href="/2024/09/spectator-sport-a-brief-introduction-to-an-upcoming-rails-plugin">Spectator Sport, a brief introduction to an upcoming Rails plugin</a></li>
      
        <li><a href="/2024/09/seeing-like-a-rails-and-ruby-platform-team">Seeing like a Rails and Ruby platform team</a></li>
      
        <li><a href="/2024/09/secret-to-rails-database-connection-pool-size">The secret to perfectly calculate Rails database connection pool size</a></li>
      
        <li><a href="/2024/09/the-novice-problem">The Novice Problem</a></li>
      
    </ul>
  </div>
</div>


    </div>

    <footer class="site-footer">

</footer>


  </body>

</html>
