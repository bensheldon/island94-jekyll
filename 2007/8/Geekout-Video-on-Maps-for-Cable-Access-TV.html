<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Geekout: Video on Maps for Cable Access TV | Island94.org</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="8kDS0atEQ2LNZcYY3Isarw9OC0bESO9GxaX-ta8BIjXFju8W8NS6v2SBozNeNWoRLqNXJbZJ4-aOsRlGPJyqqw" />
  

  <link rel="alternate" type="application/rss+xml" title="Island94.org" href="https://island94.org/feed.xml">

  <link rel="stylesheet" href="/assets/application-3c56ab95cf55e7f461f0ea9391c2b1391a5c64b74433224fe76ad58b7fa20c07.css" data-turbo-track="reload" />
  <script src="/assets/main-57967bd29e3a27ba3099fee5997ee6ec8c59ef209085f949b6eac799b21915b0.js"></script>

  <script>
    let theme = localStorage.getItem('theme');
    if (!["light", "dark"].includes(theme)) {
      theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    document.documentElement.setAttribute('data-bs-theme', theme);
  </script>

  
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
        <li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown">
          <button id="bs-theme" class="btn btn-link nav-link dropdown-toggle" type="button" aria-expanded="false" data-bs-toggle="dropdown"  aria-label="Theme (Auto)">
            <i data-bs-theme-active-icon class="bi bi-circle-half"></i>
            <span data-bs-theme-label>Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bs-theme-text">
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="light" aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="dark" aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="auto" aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <input id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
        <button class="visually-hidden" type="submit">Search</button>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      — Ben Sheldon's personal blog and <a href="/2012/04/A-Commonplace-Book.html">commonplace book</a>.
    </div>
  </div>
</nav>


  <div class="container container-body">
    
<div class="container container-body">
  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2007/8/Geekout-Video-on-Maps-for-Cable-Access-TV"><p>Geekout: Video on Maps for Cable Access TV</p>
</a>
    </h1>
    <p class="post-meta text-muted">
        <time datetime="2007-08-02T00:00:00+00:00" itemprop="datePublished">August 2, 2007</time>

        • Tagged Cable Access, coding, development, Drupal, geekout, navigation, portfolio, and video
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><img src="/uploads/2007-08/mediamap-600x448.jpg" alt="" title="mediamap" /></p>

<p>I recently did some <a href="http://drupal.org">Drupal</a> development work for <a href="http://cctvcambridge.org">Cambridge Community Television</a>. As part of the really amazing work they are doing combining new media with traditional <a href="http://alliancecm.org">Cable Access Television</a>, CCTV has been mapping videos their members produce. They call this project the <a href="http://cctvcambridge.org/mediamap">Mediamap</a>.</p>

<p>I was really excited to work on the Mediamap with CCTV because of my long <a href="http://island94.org/articles/future-cable-access">involvement</a> with Cable Access Television, most notably the now-defunct <a href="https://web.archive.org/web/20070712053537/http://digitalbicycle.org/">DigitalBicycle Project</a> and the community maintained directory of Cable Access Stations I built and administer: <a href="https://web.archive.org/web/20070819093518/http://www.mappingaccess.com/">MappingAccess.com</a>.</p>

<p>Despite CCTV running their website on Drupal, their first proof-of-concept version of the Mediamap was created manually, using the very capable <a href="http://mapbuilder.net">Mapbuilder.net</a> service and copy-and-pasted embedded flash video. While simple from a technological standpoint, they were running to problems optimizing the workflow of updating the map; changes had to be made via the Mapbuilder.net interface, with a single username and password, then manually parsed to remove some coding irregularities, and finally copy and pasted whole into a page on their website.</p>

<p>I was asked to improve the workflow and ultimately take fuller advantage of Drupal’s built-in user management and content management features. For instance, taking advantage of CCTV’s current member submitted video capabilities and flowing them into the map as an integrated report, not a separate and parallel system.</p>

<p>In my discussions with them, a couple of issues came up. Foremost was that CCTV was running an older version of Drupal: 4.7. While still quite powerful, many newer features and contributed modules were not available for this earlier release. The current version of Drupal, 5.1, has many rich, well-developed utilities for creating reports and mapping them: <a href="http://drupal.org/project/cck">Content Construction Kit (CCK)</a> + <a href="http://drupal.org/project/views">Views</a> + <a href="http://drupal.org/project/gmap">Gmap</a> + <a href="http://drupal.org/project/location">Location</a>. As it was though, with the older version, I would have to develop the additional functionality manually.</p>

<p>The following is a description, with code examples, of the functionality I created for the Mediamap. Additionally, following this initial development, CCTV upgraded their Drupal installation to 5.1, giving me the opportunity to demonstrate the ease and power of Drupal’s most recent release—rendering blissfully obsolete most of the custom coding I had done.</p>

<p>Location and Gmap was used in both versions for storing geographic data and hooking into the Google Map API. One of Drupal’s great strengths is the both the diversity of contributed modules, and the flexibility with which a developer can use them.</p>

<h3 id="adding-additional-content-fields">Adding additional content fields</h3>

<p>CCTV already has a process in which member’s can submit content nodes. In 4.7, the easiest way to add additional data fields to these was with a custom <a href="http://api.drupal.org/api/file/nodeapi_example.module/4.7">NodeAPI module</a>. CCTV was interested in using embedded flash video, primarily from <a href="http://blip.tv">Blip.tv</a>, but also Google Video or YouTube if the flexibility was needed. To simplify the process, we decided on just adding the cut-and-paste embed code to a custom content field in existing nodes.</p>

<p>To do this, I created a new module that invoked hook_nodeapi:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">Implementation</span> <span class="n">of</span> <span class="n">hook_nodeapi</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_nodeapi</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$teaser</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nv">$op</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'validate'</span><span class="o">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_'</span><span class="mf">.</span><span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">type</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">user_access</span><span class="p">(</span><span class="s1">'modify node data'</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">form_set_error</span><span class="p">(</span><span class="s1">'cambridge_mediamap'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Media Map: You must enter embed code or disable display of this node on the map'</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'load'</span><span class="o">:</span>
      <span class="nv">$object</span> <span class="o">=</span> <span class="nf">db_fetch_object</span><span class="p">(</span><span class="nf">db_query</span><span class="p">(</span><span class="s1">'SELECT display, embed FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">));</span>
      <span class="nv">$embed</span> <span class="o">=</span> <span class="nv">$object</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">embed</span><span class="p">;</span>
      <span class="nv">$embed_resize</span> <span class="o">=</span> <span class="nf">cambridge_mediamap_resize</span><span class="p">(</span><span class="nv">$embed</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'cambridge_mediamap'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nv">$object</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">display</span><span class="p">,</span> <span class="s1">'embed'</span> <span class="o">=&gt;</span> <span class="nv">$embed</span><span class="p">,</span> <span class="s1">'embed_resize'</span> <span class="o">=&gt;</span> <span class="nv">$embed_resize</span><span class="p">,</span> <span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'insert'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s2">"INSERT INTO </span><span class="si">{</span><span class="nv">cambridge_mediamap</span><span class="si">}</span><span class="s2"> (nid, display, embed) VALUES (%d, %d, '%s')"</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">],</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s1">'DELETE FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">);</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s2">"INSERT INTO </span><span class="si">{</span><span class="nv">cambridge_mediamap</span><span class="si">}</span><span class="s2"> (nid, display, embed) VALUES (%d, %d, '%s')"</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">],</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s1">'DELETE FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span><span class="err">  </span>
    <span class="k">case</span> <span class="s1">'view'</span><span class="o">:</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, there is a considerable amount of coding required, from defining the form, validating input and configuring database storage and retrieval calls.</p>

<p>Now that we have the glue for the custom field, we have to configure what node types that custom field appears on. Additionally, we need to set up administrative settings to configure where that custom field will appear, and lastly insert that field into the node edit screen:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="err">\</span><span class="o">**</span>
 <span class="o">*</span> <span class="nc">Implementation</span> <span class="n">of</span> <span class="n">hook_form_alter</span>
 <span class="o">*/</span>
<span class="k">function</span> <span class="n">cambridge_mediamap_nodeapi</span><span class="p">(</span> <span class="o">&amp;</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$teaser</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nv">$op</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'validate'</span><span class="o">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_'</span><span class="mf">.</span><span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">type</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">user_access</span><span class="p">(</span><span class="s1">'modify node data'</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">form_set_error</span><span class="p">(</span><span class="s1">'cambridge_mediamap'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Media Map: You must enter embed code or disable display of this node on the map'</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'load'</span><span class="o">:</span>
      <span class="nv">$object</span> <span class="o">=</span> <span class="nf">db_fetch_object</span><span class="p">(</span><span class="nf">db_query</span><span class="p">(</span><span class="s1">'SELECT display, embed FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">));</span>
      <span class="nv">$embed</span> <span class="o">=</span> <span class="nv">$object</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">embed</span><span class="p">;</span>
      <span class="nv">$embed_resize</span> <span class="o">=</span> <span class="nf">cambridge_mediamap_resize</span><span class="p">(</span><span class="nv">$embed</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'cambridge_mediamap'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
          <span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nv">$object</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">display</span><span class="p">,</span>
          <span class="s1">'embed'</span> <span class="o">=&gt;</span> <span class="nv">$embed</span><span class="p">,</span>
          <span class="s1">'embed_resize'</span> <span class="o">=&gt;</span> <span class="nv">$embed_resize</span><span class="p">,</span>
        <span class="p">)</span>
      <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'insert'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s2">"INSERT INTO </span><span class="si">{</span><span class="nv">cambridge_mediamap</span><span class="si">}</span><span class="s2"> (nid, display, embed) VALUES (%d, %d, '%s')"</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">],</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s1">'DELETE FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">);</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s2">"INSERT INTO </span><span class="si">{</span><span class="nv">cambridge_mediamap</span><span class="si">}</span><span class="s2"> (nid, display, embed) VALUES (%d, %d, '%s')"</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">],</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s1">'DELETE FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'view'</span><span class="o">:</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, that’s a lot of lines of code for what we essentially can do, in Drupal 5.1 with CCK. CCK allows you, graphically through the Drupal web-interface, to create a new content field and add it to a node type; it takes about a minute.</p>

<h3 id="building-the-map">Building the Map</h3>

<p>The primary goal of rebuilding the Mediamap using native Drupal was workflow optimization: it was frustrating to submit information both within Drupal and then recreate it within Mapbuilder. In essence, the map should be just another report of Drupal content: you may have a short bulleted list of the top five articles, a paginated history with teasers and author information, or a full-blown map, but most importantly, all of it is flowing dynamically out of the Drupal database.</p>

<p>The Gmap module provides many powerful ways to integrate the Google Map API with Drupal. While Gmap for 4.7 provides a default map of content it would not provide the features or customizability we desired with the Mediamap. Instead, one of the most powerful ways to use Gmap is to hook directly into the module’s own API-like functions:</p>

<pre><code>\**
 * A page callback to draw the map
 */

function cambridge_mediamap_map() {
  $output = '';
  //Collect the nodes to be displayed
  $results = db_query('SELECT embed, nid FROM {cambridge_mediamap} WHERE display = 1');
  //Initialize our marker array
  $markers = array();
  //check to see what modules are enabled
  $location_enabled = module_exist('location');
  $gmap_location_enabled = module_exist('gmap_location');
  //load each node and set it's attributes in the marker array
  while ($item = db_fetch_object($results)) {
    $latitude = 0;
    $longitude = 0;
    //load the node
    $node = node_load(array('nid' =&gt; $item - &gt; nid));
    //set the latitude and longitude
    //give location module data preference over gmap module data
    if ($location_enabled) {
      $latitude = $node - &gt; location['latitude'];
      $longitude = $node - &gt; location['longitude'];
    }
    elseif($gmap_location_enabled) {
      $latitude = $node - &gt; gmap_location_latitude;
      $longitude = $node - &gt; gmap_location_longitude;
    }
    if ($latitude &amp;&amp; $longitude) {
      $markers[] = array(
        'label' =&gt; theme('cambridge_mediamap_marker', $node),
        'latitude' =&gt; $latitude,
        'longitude' =&gt; $longitude,
        'markername' =&gt; variable_get('cambridge_mediamap_default_marker', 'marker'),
      );
    }
  }
  $latlon = explode(',', variable_get('cambridge_mediamap_default_latlong', '42.369452,-71.100426'));
  $map = array(
    'id' =&gt; 'cambridge_mediamap',
    'latitude' =&gt; trim($latlon[0]),
    'longitude' =&gt; trim($latlon[1]),
    'width' =&gt; variable_get('cambridge_mediamap_default_width', '100%'),
    'height' =&gt; variable_get('cambridge_mediamap_default_height', '500px'),
    'zoom' =&gt; variable_get('cambridge_mediamap_default_zoom', 13),
    'control' =&gt; variable_get('cambridge_mediamap_default_control', 'Large'),
    'type' =&gt; variable_get('cambridge_mediamap_default_type', 'Satellite'),
    'markers' =&gt; $markers,
  );
   
  return gmap_draw_map($map);
}
</code></pre>

<p>As you can see, this is quite complicated. Drupal 5.1 offers the powerful Views module, which allows one to define custom reports, once again graphically from the Drupal web-interface, in just a couple minutes of configuration. The gmap_views module, which ships with Gmap, allows one to add those custom reports to a Google Map, which is incredibly useful and renders obsolete much of the development work I did.</p>

<h3 id="on-displaying-video-in-maps">On displaying video in maps</h3>

<p>In my discussions with CCTV, we felt it most pragmatic to use the embedded video code provided by video hosting services such as Blip.tv. While we could have used one of the Drupal video modules, we wanted the ability to host video offsite due to storage constraints. While I was concerned about the danger of code injection via minimally validated inputs, we felt that this would be of small danger because the content would be maintained by CCTV staff and select members.</p>

<p>The markers were themed using the embedded video field pulled from the Drupal database, along with the title and a snippet of the description, all linking back to the full content node.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * A theme function for our markers
 */</span>
<span class="k">function</span> <span class="n">theme_cambridge_mediamap_marker</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$output</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nv">$output</span><span class="mf">.</span> <span class="o">=</span> <span class="s1">''</span> <span class="mf">.</span> <span class="nf">l</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="n">title</span><span class="p">,</span> <span class="s1">'node / '</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nv">$output</span><span class="mf">.</span> <span class="o">=</span> <span class="s1">''</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">' . embed_resize '</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nv">$output</span><span class="mf">.</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With Drupal 5.1 and Views, we still had to override the standard marker themes, but this was simple and done through the standard methods.</p>

<p>One of the most helpful pieces was some code developed by <a href="http://circuitous.org">Rebecca White</a>, who I previously worked with on <a href="http://panlexicon.com">Panlexicon</a>. She provided the critical pieces of code that parsed the embedded video code and resized it for display on small marker windows.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**

\* Returns a resized embed code

\*/</span>
<span class="k">function</span> <span class="n">cambridge_mediamap_resize</span><span class="p">(</span><span class="nv">$embed</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$embed</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">list</span><span class="p">(</span><span class="nv">$width</span><span class="p">,</span> <span class="nv">$height</span><span class="p">)</span> <span class="o">=</span> <span class="nf">cambridge_mediamap_get_embed_size</span><span class="p">(</span><span class="nv">$embed</span><span class="p">);</span>
  <span class="c1">//width/height ratio</span>
  <span class="nv">$width_to_height</span> <span class="o">=</span> <span class="nv">$width</span> <span class="o">/</span> <span class="nv">$height</span><span class="p">;</span>
  <span class="nv">$max_width</span> <span class="o">=</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_embed_width'</span><span class="p">,</span> <span class="s1">'320'</span><span class="p">);</span>
  <span class="nv">$max_height</span> <span class="o">=</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_embed_height'</span><span class="p">,</span> <span class="s1">'240'</span><span class="p">);</span>
  <span class="c1">//shrink down widths while maintaining proportion</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$width</span> <span class="o">&gt;=</span> <span class="nv">$height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$width</span> <span class="o">&gt;</span> <span class="nv">$max_width</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="nv">$max_width</span><span class="p">;</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$width</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$height</span> <span class="o">&gt;</span> <span class="nv">$max_height</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="nv">$max_height</span><span class="p">;</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$height</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$height</span> <span class="o">&gt;</span> <span class="nv">$max_height</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="nv">$max_height</span><span class="p">;</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$height</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$width</span> <span class="o">&gt;</span> <span class="nv">$max_width</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="nv">$max_width</span><span class="p">;</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$width</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nf">cambridge_mediamap_set_embed_size</span><span class="p">(</span><span class="nv">$embed</span><span class="p">,</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$width</span><span class="p">),</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$height</span><span class="p">));</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="n">find</span> <span class="n">out</span> <span class="n">what</span> <span class="n">size</span> <span class="n">the</span> <span class="n">embedded</span> <span class="n">thing</span> <span class="n">is</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_get_embed_size</span><span class="p">(</span><span class="nv">$html</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/]\*width(\s\*=\s\*"|:\s\*)(\d+)/i'</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$match_width</span><span class="p">);</span>
  <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/]\*height(\s\*=\s\*"|:\s\*)(\d+)/i'</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$match_height</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$match_width</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nv">$match_height</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="n">set</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">embeded</span> <span class="n">thing</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_set_embed_size</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="nv">$width</span><span class="p">,</span> <span class="nv">$height</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$html</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&lt;(embed|object)\s[^&gt;]\*width(\s\*=\s\*"|:\s\*))(\d+)/i'</span><span class="p">,</span> <span class="s1">'${1}'</span><span class="mf">.</span><span class="nv">$width</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
  <span class="nv">$html</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&lt;(embed|object)\s[^&gt;]\*height(\s\*=\s\*"|:\s\*))(\d+)/i'</span><span class="p">,</span> <span class="s1">'${1}'</span><span class="mf">.</span><span class="nv">$height</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$html</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">base</span> <span class="n">url</span> <span class="n">of</span> <span class="n">the</span> <span class="n">src</span> <span class="n">attribute</span><span class="mf">.</span><span class="err">\</span><span class="o">*</span><span class="n">youtube</span> <span class="o">=</span> <span class="n">www</span><span class="mf">.</span><span class="n">youtube</span><span class="mf">.</span><span class="n">com</span><span class="err">\</span> <span class="o">*</span> <span class="n">blip</span> <span class="o">=</span> <span class="n">blip</span><span class="mf">.</span><span class="n">tv</span><span class="err">\</span> <span class="o">*</span> <span class="n">google</span> <span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="mf">.</span><span class="n">google</span><span class="mf">.</span><span class="n">com</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_get_embed_source</span><span class="p">(</span><span class="nv">$html</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/]\*src="http:\/\/([^\/"]+)/i'</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$match_src</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$match_src</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="the-wrap-up">The Wrap-Up</h3>

<p>While it may not seem so from the lines of code above, developing for Drupal is still relatively easy. Drupal provides a rich set of features for developers, <a href="http://api.drupal.org">well documented features</a>, and strong <a href="http://drupal.org/coding-standards">coding standards</a>—making reading other people’s code and learning from it incredibly productive.</p>

<p>Below is the entirety of the custom module I developed for the 4.7 version of the CCTV Media Map. Because it was custom and intended to be used in-house, many important, release worthy functions were omitted, such as richer administrative options and module/function verifications.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'cambridge_mediamap'</span><span class="p">,</span> <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Mediamap'</span><span class="p">),</span> <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'cambridge_mediamap_map'</span><span class="p">,</span> <span class="s1">'access'</span> <span class="o">=&gt;</span> <span class="nf">user_access</span><span class="p">(</span><span class="s1">'access mediamap'</span><span class="p">),</span> <span class="p">);</span>
<span class="p">}</span>
<span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">Implementation</span> <span class="n">of</span> <span class="n">hook_nodeapi</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_nodeapi</span><span class="p">(</span> <span class="o">&amp;</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$teaser</span><span class="p">,</span> <span class="nv">$page</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nv">$op</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'validate'</span><span class="o">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_'</span><span class="mf">.</span><span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">type</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">user_access</span><span class="p">(</span><span class="s1">'modify node data'</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">form_set_error</span><span class="p">(</span><span class="s1">'cambridge_mediamap'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Media Map: You must enter embed code or disable display of this node on the map'</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'load'</span><span class="o">:</span>
      <span class="nv">$object</span> <span class="o">=</span> <span class="nf">db_fetch_object</span><span class="p">(</span><span class="nf">db_query</span><span class="p">(</span><span class="s1">'SELECT display, embed FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">));</span>
      <span class="nv">$embed</span> <span class="o">=</span> <span class="nv">$object</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">embed</span><span class="p">;</span>
      <span class="nv">$embed_resize</span> <span class="o">=</span> <span class="nf">cambridge_mediamap_resize</span><span class="p">(</span><span class="nv">$embed</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'cambridge_mediamap'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'display'</span> <span class="o">=&gt;</span> <span class="nv">$object</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">display</span><span class="p">,</span> <span class="s1">'embed'</span> <span class="o">=&gt;</span> <span class="nv">$embed</span><span class="p">,</span> <span class="s1">'embed_resize'</span> <span class="o">=&gt;</span> <span class="nv">$embed_resize</span><span class="p">,</span> <span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'insert'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s2">"INSERT INTO </span><span class="si">{</span><span class="nv">cambridge_mediamap</span><span class="si">}</span><span class="s2"> (nid, display, embed) VALUES (%d, %d, '%s')"</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">],</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s1">'DELETE FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">);</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s2">"INSERT INTO </span><span class="si">{</span><span class="nv">cambridge_mediamap</span><span class="si">}</span><span class="s2"> (nid, display, embed) VALUES (%d, %d, '%s')"</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">],</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
      <span class="nf">db_query</span><span class="p">(</span><span class="s1">'DELETE FROM {cambridge_mediamap} WHERE nid = %d'</span><span class="p">,</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'view'</span><span class="o">:</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">Returns</span> <span class="n">a</span> <span class="n">resized</span> <span class="n">embed</span> <span class="n">code</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_resize</span><span class="p">(</span><span class="nv">$embed</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$embed</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">list</span><span class="p">(</span><span class="nv">$width</span><span class="p">,</span> <span class="nv">$height</span><span class="p">)</span> <span class="o">=</span> <span class="nf">cambridge_mediamap_get_embed_size</span><span class="p">(</span><span class="nv">$embed</span><span class="p">);</span>
  <span class="c1">//width/height ratio</span>
  <span class="nv">$width_to_height</span> <span class="o">=</span> <span class="nv">$width</span> <span class="o">/</span> <span class="nv">$height</span><span class="p">;</span>
  <span class="nv">$max_width</span> <span class="o">=</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_embed_width'</span><span class="p">,</span> <span class="s1">'320'</span><span class="p">);</span>
  <span class="nv">$max_height</span> <span class="o">=</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_embed_height'</span><span class="p">,</span> <span class="s1">'240'</span><span class="p">);</span>
  <span class="c1">//shrink down widths while maintaining proportion</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$width</span> <span class="o">&gt;=</span> <span class="nv">$height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$width</span> <span class="o">&gt;</span> <span class="nv">$max_width</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="nv">$max_width</span><span class="p">;</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$width</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$height</span> <span class="o">&gt;</span> <span class="nv">$max_height</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="nv">$max_height</span><span class="p">;</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$height</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$height</span> <span class="o">&gt;</span> <span class="nv">$max_height</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="nv">$max_height</span><span class="p">;</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$height</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$width</span> <span class="o">&gt;</span> <span class="nv">$max_width</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$width</span> <span class="o">=</span> <span class="nv">$max_width</span><span class="p">;</span>
      <span class="nv">$height</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nv">$width_to_height</span><span class="p">)</span><span class="err">\</span> <span class="o">*</span> <span class="nv">$width</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nf">cambridge_mediamap_set_embed_size</span><span class="p">(</span><span class="nv">$embed</span><span class="p">,</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$width</span><span class="p">),</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$height</span><span class="p">));</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="n">find</span> <span class="n">out</span> <span class="n">what</span> <span class="n">size</span> <span class="n">the</span> <span class="n">embedded</span> <span class="n">thing</span> <span class="n">is</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_get_embed_size</span><span class="p">(</span><span class="nv">$html</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/]\*width(\s\*=\s\*"|:\s\*)(\d+)/i'</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$match_width</span><span class="p">);</span>
  <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/]\*height(\s\*=\s\*"|:\s\*)(\d+)/i'</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$match_height</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$match_width</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nv">$match_height</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="n">set</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">embeded</span> <span class="n">thing</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_set_embed_size</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="nv">$width</span><span class="p">,</span> <span class="nv">$height</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$html</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&lt;(embed|object)\s[^&gt;]\*width(\s\*=\s\*"|:\s\*))(\d+)/i'</span><span class="p">,</span> <span class="s1">'${1}'</span><span class="mf">.</span><span class="nv">$width</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
  <span class="nv">$html</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/(&lt;(embed|object)\s[^&gt;]\*height(\s\*=\s\*"|:\s\*))(\d+)/i'</span><span class="p">,</span> <span class="s1">'${1}'</span><span class="mf">.</span><span class="nv">$height</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$html</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">base</span> <span class="n">url</span> <span class="n">of</span> <span class="n">the</span> <span class="n">src</span> <span class="n">attribute</span><span class="mf">.</span><span class="err">\</span><span class="o">*</span><span class="n">youtube</span> <span class="o">=</span> <span class="n">www</span><span class="mf">.</span><span class="n">youtube</span><span class="mf">.</span><span class="n">com</span><span class="err">\</span> <span class="o">*</span> <span class="n">blip</span> <span class="o">=</span> <span class="n">blip</span><span class="mf">.</span><span class="n">tv</span><span class="err">\</span> <span class="o">*</span> <span class="n">google</span> <span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="mf">.</span><span class="n">google</span><span class="mf">.</span><span class="n">com</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_get_embed_source</span><span class="p">(</span><span class="nv">$html</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/]\*src="http:\/\/([^\/"]+)/i'</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$match_src</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$match_src</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">Implementation</span> <span class="n">of</span> <span class="n">hook_form_alter</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_form_alter</span><span class="p">(</span><span class="nv">$form_id</span><span class="p">,</span> <span class="o">&amp;</span> <span class="nv">$form</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// We're only modifying node forms, if the type field isn't set we don't need</span>
  <span class="c1">// to bother.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">//disable the Gmap module's location map for unauthorized users</span>
  <span class="c1">//unfortunately Gmap.module doesn't have this setting</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">'coordinates'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">user_access</span><span class="p">(</span><span class="s1">'modify node data'</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">unset</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">'coordinates'</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Make a copy of the type to shorten up the code</span>
  <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'type'</span><span class="p">][</span><span class="s1">'#value'</span><span class="p">];</span>
  <span class="c1">// Is the map enabled for this content type?</span>
  <span class="nv">$enabled</span> <span class="o">=</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_'</span><span class="mf">.</span><span class="nv">$type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We need to have a way for administrators to indicate which content</span>
    <span class="c1">// types should have the additional media map information added.</span>
    <span class="k">case</span> <span class="nv">$type</span><span class="mf">.</span>
    <span class="s1">'_node_settings'</span><span class="o">:</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'workflow'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_'</span><span class="mf">.</span><span class="nv">$type</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'radios'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Cambridge Mediamap setting'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$enabled</span><span class="p">,</span> <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Disabled'</span><span class="p">),</span> <span class="mi">1</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Enabled'</span><span class="p">)),</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Allow the attaching of externally hosted imbedded video to be displayed in a map?'</span><span class="p">),</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nv">$type</span><span class="mf">.</span>
    <span class="s1">'_node_form'</span><span class="o">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$enabled</span> <span class="o">&amp;&amp;</span> <span class="nf">user_access</span><span class="p">(</span><span class="s1">'modify node data'</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">//create the fieldset</span>
        <span class="nv">$form</span><span class="p">[</span><span class="s1">'cambridge_mediamap'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Media Map'</span><span class="p">),</span> <span class="s1">'#collapsible'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="s1">'#collapsed'</span> <span class="o">=&gt;</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="s1">'#tree'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="p">);</span>
        <span class="c1">//insert the embed code</span>
        <span class="nv">$form</span><span class="p">[</span><span class="s1">'cambridge_mediamap'</span><span class="p">][</span><span class="s1">'embed'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textarea'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Video Embed Code'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'#node'</span><span class="p">]</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">],</span> <span class="s1">'#cols'</span> <span class="o">=&gt;</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">'#rows'</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Copy and paste the embed code from an external video or media hosting service'</span><span class="p">),</span> <span class="p">);</span>
        <span class="c1">//enable or disable on map</span>
        <span class="nv">$form</span><span class="p">[</span><span class="s1">'cambridge_mediamap'</span><span class="p">][</span><span class="s1">'display'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Display this node'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'#node'</span><span class="p">]</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'display'</span><span class="p">],</span> <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'0'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Disable display'</span><span class="p">),</span> <span class="s1">'1'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Enable display'</span><span class="p">),</span> <span class="p">),</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">A</span> <span class="n">page</span> <span class="n">callback</span> <span class="n">to</span> <span class="n">draw</span> <span class="n">the</span> <span class="n">map</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_map</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$output</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="c1">//Collect the nodes to be displayed</span>
  <span class="nv">$results</span> <span class="o">=</span> <span class="nf">db_query</span><span class="p">(</span><span class="s1">'SELECT embed, nid FROM {cambridge_mediamap} WHERE display = 1'</span><span class="p">);</span>
  <span class="c1">//Initialize our marker array</span>
  <span class="nv">$markers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="c1">//check to see what modules are enabled</span>
  <span class="nv">$location_enabled</span> <span class="o">=</span> <span class="nf">module_exist</span><span class="p">(</span><span class="s1">'location'</span><span class="p">);</span>
  <span class="nv">$gmap_location_enabled</span> <span class="o">=</span> <span class="nf">module_exist</span><span class="p">(</span><span class="s1">'gmap_location'</span><span class="p">);</span>
  <span class="c1">//load each node and set it's attributes in the marker array</span>
  <span class="k">while</span> <span class="p">(</span><span class="nv">$item</span> <span class="o">=</span> <span class="nf">db_fetch_object</span><span class="p">(</span><span class="nv">$results</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$latitude</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$longitude</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">//load the node</span>
    <span class="nv">$node</span> <span class="o">=</span> <span class="nf">node_load</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'nid'</span> <span class="o">=&gt;</span> <span class="nv">$item</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">nid</span><span class="p">));</span>
    <span class="c1">//set the latitude and longitude</span>
    <span class="c1">//give location module data preference over gmap module data</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$location_enabled</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$latitude</span> <span class="o">=</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">location</span><span class="p">[</span><span class="s1">'latitude'</span><span class="p">];</span>
      <span class="nv">$longitude</span> <span class="o">=</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">location</span><span class="p">[</span><span class="s1">'longitude'</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">elseif</span><span class="p">(</span><span class="nv">$gmap_location_enabled</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$latitude</span> <span class="o">=</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">gmap_location_latitude</span><span class="p">;</span>
      <span class="nv">$longitude</span> <span class="o">=</span> <span class="nv">$node</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">gmap_location_longitude</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$latitude</span> <span class="o">&amp;&amp;</span> <span class="nv">$longitude</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$markers</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nf">theme</span><span class="p">(</span><span class="s1">'cambridge_mediamap_marker'</span><span class="p">,</span> <span class="nv">$node</span><span class="p">),</span> <span class="s1">'latitude'</span> <span class="o">=&gt;</span> <span class="nv">$latitude</span><span class="p">,</span> <span class="s1">'longitude'</span> <span class="o">=&gt;</span> <span class="nv">$longitude</span><span class="p">,</span> <span class="s1">'markername'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_marker'</span><span class="p">,</span> <span class="s1">'marker'</span><span class="p">),</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$latlon</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_latlong'</span><span class="p">,</span> <span class="s1">'42.369452,-71.100426'</span><span class="p">));</span>
  <span class="nv">$map</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'cambridge_mediamap'</span><span class="p">,</span> <span class="s1">'latitude'</span> <span class="o">=&gt;</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$latlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">'longitude'</span> <span class="o">=&gt;</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$latlon</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">'width'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_width'</span><span class="p">,</span> <span class="s1">'100%'</span><span class="p">),</span> <span class="s1">'height'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_height'</span><span class="p">,</span> <span class="s1">'500px'</span><span class="p">),</span> <span class="s1">'zoom'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_zoom'</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="s1">'control'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_control'</span><span class="p">,</span> <span class="s1">'Large'</span><span class="p">),</span> <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_type'</span><span class="p">,</span> <span class="s1">'Satellite'</span><span class="p">),</span> <span class="s1">'markers'</span> <span class="o">=&gt;</span> <span class="nv">$markers</span><span class="p">,</span> <span class="p">);</span>
  <span class="k">return</span> <span class="nf">gmap_draw_map</span><span class="p">(</span><span class="nv">$map</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">A</span> <span class="n">theme</span>
<span class="k">function</span>
<span class="n">for</span> <span class="n">our</span> <span class="n">markers</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">theme_cambridge_mediamap_marker</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$output</span> <span class="o">=</span> <span class="s1">'
  '</span><span class="p">;</span>
  <span class="nv">$output</span><span class="mf">.</span> <span class="o">=</span> <span class="s1">'
  '</span> <span class="mf">.</span> <span class="nf">l</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="n">title</span><span class="p">,</span> <span class="s1">'
  node / '</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">nid</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'
  '</span><span class="p">;</span>
  <span class="nv">$output</span><span class="mf">.</span> <span class="o">=</span> <span class="s1">'
  '</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">cambridge_mediamap</span><span class="p">[</span><span class="s1">'
  embed_resize '</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'
  '</span><span class="p">;</span>
  <span class="nv">$output</span><span class="mf">.</span> <span class="o">=</span> <span class="s1">'
  '</span><span class="p">;</span>
  <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">Settings</span> <span class="n">page</span><span class="err">\</span> <span class="o">*</span> <span class="o">/</span>

<span class="k">function</span> <span class="n">cambridge_mediamap_settings</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Cambridge data</span>
  <span class="c1">// latitude = 42.369452</span>
  <span class="c1">// longitude = -71.100426</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default map settings'</span><span class="p">),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_default_width'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default width'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_width'</span><span class="p">,</span> <span class="s1">'100%'</span><span class="p">),</span> <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">'#maxlength'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The default width of a Google map. Either px or %'</span><span class="p">),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_default_height'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default height'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_height'</span><span class="p">,</span> <span class="s1">'500px'</span><span class="p">),</span> <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">'#maxlength'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The default height of Mediamap. In px.'</span><span class="p">),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_default_latlong'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default center'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_latlong'</span><span class="p">,</span> <span class="s1">'42.369452,-71.100426'</span><span class="p">),</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="s1">'The decimal latitude,longitude of the centre of the map. The "." is used for decimal, and "," is used to separate latitude and longitude.'</span><span class="p">,</span> <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">'#maxlength'</span> <span class="o">=&gt;</span> <span class="mi">255</span><span class="p">,</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The default longitude, latitude of Mediamap.'</span><span class="p">),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_default_zoom'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default zoom'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_zoom'</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nf">drupal_map_assoc</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">)),</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The default zoom level of Mediamap.'</span><span class="p">),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_default_control'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default control type'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_control'</span><span class="p">,</span> <span class="s1">'Large'</span><span class="p">),</span> <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'None'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'None'</span><span class="p">),</span> <span class="s1">'Small'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Small'</span><span class="p">),</span> <span class="s1">'Large'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Large'</span><span class="p">)),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_default_type'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default map type'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_type'</span><span class="p">,</span> <span class="s1">'Satellite'</span><span class="p">),</span> <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'Map'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Map'</span><span class="p">),</span> <span class="s1">'Satellite'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Satellite'</span><span class="p">),</span> <span class="s1">'Hybrid'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Hybrid'</span><span class="p">)),</span> <span class="p">);</span>
  <span class="nv">$markers</span> <span class="o">=</span> <span class="nf">gmap_get_markers</span><span class="p">();</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'defaults'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_default_marker'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Marker'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_default_marker'</span><span class="p">,</span> <span class="s1">'marker'</span><span class="p">),</span> <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nv">$markers</span><span class="p">,</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default embedded video settings'</span><span class="p">),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_embed_width'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default width'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_embed_width'</span><span class="p">,</span> <span class="s1">'320'</span><span class="p">),</span> <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">'#maxlength'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The maximum width of embedded video'</span><span class="p">),</span> <span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'embed'</span><span class="p">][</span><span class="s1">'cambridge_mediamap_embed_height'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span> <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Default height'</span><span class="p">),</span> <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nf">variable_get</span><span class="p">(</span><span class="s1">'cambridge_mediamap_embed_height'</span><span class="p">,</span> <span class="s1">'240'</span><span class="p">),</span> <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">'#maxlength'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The maximum height of embedded video.'</span><span class="p">),</span> <span class="p">);</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">/</span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="err">\</span> <span class="o">*</span> <span class="nc">Prints</span> <span class="n">human</span> <span class="o">-</span> <span class="nf">readable</span><span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="n">information</span> <span class="n">about</span> <span class="n">a</span> <span class="n">variable</span><span class="mf">.</span><span class="err">\</span><span class="o">*</span><span class="kn">Use</span><span class="o">:</span> <span class="k">print</span> <span class="nf">debug</span><span class="p">(</span><span class="nv">$variable_name</span><span class="p">);</span><span class="err">\</span> <span class="o">*</span> <span class="k">Or</span> <span class="n">assign</span> <span class="n">output</span> <span class="n">to</span> <span class="n">a</span> <span class="n">variable</span><span class="mf">.</span><span class="err">\</span><span class="o">*/</span>

<span class="k">function</span> <span class="n">debug</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/\s/"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/</span><span class="se">\n</span><span class="s2">/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nb">print_r</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="kc">true</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre></div></div>

  </div>
</article>


  <div class="card my-4">
    <div class="card-body">
      Discuss this with me on <a href="https://twitter.com/bensheldon"><i class="bi bi-twitter"></i> Twitter</a>
      or suggest a
      <a href="https://github.com/bensheldon/island94.org/blob/main/_posts/2007-08-02-Geekout-Video-on-Maps-for-Cable-Access-TV.md"><i class="bi bi-github"></i>
        change</a>.
    </div>
      <hr>
      <div class="card-body">
        <h5>Related Posts</h5>
        <ul>
            <li><a href="/2012/9/Reimagining-Chicagos-311-activity-with-Super-Mayor-Emanuel">Reimagining Chicago&#39;s 311 activity with Super Mayor Emanuel</a></li>
            <li><a href="/2012/8/Put-Your-Civics-Where-Your-Houseplant-Is">Put Your Civics Where Your Houseplant Is</a></li>
            <li><a href="/2012/7/Hard-data-on-the-status-of-Open311">Hard data on the status of Open311</a></li>
            <li><a href="/2011/7/DonorsChoose-Contest-Update-Consolation-Prize-Edition">DonorsChoose Contest Update: Consolation Prize Edition</a></li>
            <li><a href="/2011/7/A-modest-web-app-proposal">A modest web-app proposal</a></li>
        </ul>
    </div>
  </div>
</div>

  </div>

</body>
</html>
