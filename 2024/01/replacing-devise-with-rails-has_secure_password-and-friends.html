<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script>
    let theme = localStorage.getItem('theme');
    if (!["light", "dark"].includes(theme)) {
      theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    document.documentElement.setAttribute('data-bs-theme', theme);
  </script>

  <link rel="stylesheet" href="/assets/stylesheets/main.css">
  <script src="/assets/javascripts/main.js"></script>

  <title>Replacing Devise with Rails `has_secure_password` and friends</title>
  <meta name="description" content="I love the Devise user-authentication gem. I‚Äôve used it for years, and I recently moved off of it in one of my personal apps and replaced it with Rails‚Äôs bui...">

  <link rel="canonical" href="https://island94.org/2024/01/replacing-devise-with-rails-has_secure_password-and-friends">

  <link rel="alternate" type="application/rss+xml" title="Island94.org Posts" href="https://island94.org/feed.xml">
  <link rel="alternate" type="application/rss+xml" title="Island94.org Book Reviews" href="https://island94.org/books.xml">

  
</head>


  <body>

    <nav class="navbar navbar-expand-lg navbar-light mb-2 flex-column">
  <div class="container">
    <a class="navbar-brand" href="/">Island94.org</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link " href="/about/">About</a></li>
        <li class="nav-item"><a class="nav-link " href="/archives/">Archives</a></li>
        <li class="nav-item"><a class="nav-link " href="/books/">Books</a></li>
        <li class="nav-item"><a class="nav-link " href="/tags/">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS Feed <i class="bi bi-rss-fill"></i></a></li>

        <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
          <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-light-500"></div>
          <hr class="d-lg-none my-0 text-light-500">
        </li>

        <li class="nav-item dropdown">
          <button id="bs-theme" class="btn btn-link nav-link dropdown-toggle" type="button" aria-expanded="false" data-bs-toggle="dropdown"  aria-label="Theme (Auto)">
            <i data-bs-theme-active-icon class="bi bi-circle-half"></i>
            <span data-bs-theme-label>Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bs-theme-text">
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="light" aria-pressed="false">
                <i class="bi bi-sun"></i> Light
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="dark" aria-pressed="false">
                <i class="bi bi-moon-stars-fill"></i> Dark
              </button>
            </li>
            <li>
              <button type="button" class="dropdown-item" data-bs-theme-value="auto" aria-pressed="true">
                <i class="bi bi-circle-half"></i> Auto
              </button>
            </li>
          </ul>
        </li>

      </ul>

      <form id="search" class="d-flex" action="/search" method="get">
        <input id="search-box" class="form-control search" role="search" name="q" placeholder="Search" aria-label="Search" results="0" type="text">
        <button class="visually-hidden" type="submit">Search</button>
      </form>
    </div>
  </div>
  <div class="container">
    <div class="text-muted fst-italic">
      ‚Äî Ben Sheldon's personal blog and <a href="/2012/04/A-Commonplace-Book.html">commonplace book</a>.
    </div>
  </div>
</nav>


    <div class="container container-body">
      



<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      <a class="post-link" href="/2024/01/replacing-devise-with-rails-has_secure_password-and-friends"><p>Replacing Devise with Rails <code class="language-plaintext highlighter-rouge">has_secure_password</code> and friends</p>
</a>
    </h1>
    <p class="post-meta text-muted">
      <time datetime="2024-01-27T15:43:00+00:00" itemprop="datePublished">January 27, 2024</time>
      
      


  

  

  ‚Ä¢ Tagged <a href="/tags/#rails">rails</a> and <a href="/tags/#ruby">ruby</a>


    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I love the <a href="https://github.com/heartcombo/devise">Devise user-authentication gem</a>. I‚Äôve used it for years, and I recently moved off of it in one of my personal apps and replaced it with Rails‚Äôs built-in <code class="language-plaintext highlighter-rouge">has_secure_password</code> and <code class="language-plaintext highlighter-rouge">generates_secure_token</code> and a whole bunch of custom controllers and helpers and code that I now maintain myself. <strong>I do not recommend this! User authentication is hard! Security is hard!</strong></p>

<p><strong>And‚Ä¶</strong> maybe you need to walk the same path too. So I want to share what I learned through the process.</p>

<p>Ok, so to back up, why did I do this?</p>
<ul>
  <li>Greater compatibility with Rails <code class="language-plaintext highlighter-rouge">main</code>. My <a href="https://github.blog/2023-04-06-building-github-with-ruby-and-rails/">day job runs Rails <code class="language-plaintext highlighter-rouge">main</code></a>, and I‚Äôm more frequently contributing to Rails development; I‚Äôd like to run my personal projects on Rails <code class="language-plaintext highlighter-rouge">main</code> too. When I looked back on upgrade-blocking gems, Devise (and its dependencies, like Responders) topped my list.</li>
  <li>More creative onboarding flows. I‚Äôve twisted Devise quite a bit (it‚Äôs great!) to handle the different ways I want users to be able to register (elaborate onboarding flows, email-only subscriptions, optional passwords, magic logins). I‚Äôve already customized or overloaded nearly every Devise controller and many model methods, so it didn‚Äôt seem like such a big change anyway.</li>
  <li>Hubris. I‚Äôve built enterprise auth systems from scratch, managed the Bug Bounty program, and worked with security researchers. I have seen and caused and fixed some shit. (Fun fact: I have been paid for reporting auth vulnerabilities on the bug bounty platforms themselves.) I know that even if it‚Äôs not a bad idea <em>for me</em>, it‚Äôs not a great idea either. Go read <a href="https://github.com/advisories?query=devise+ecosystem%3Arubygems">all of the Devise-related CVEs</a>; seriously, it‚Äôs a responsibility.</li>
</ul>

<p>That last bit is why this blog post will not be like, ‚ÄúHere‚Äôs everything you need to know and do to ditch Devise.‚Äù Don‚Äôt do it! Instead, here‚Äôs some stuff I learned that I want to remember for the next app I work on.</p>

<h3 id="a-test-regime">A test regime</h3>

<p>I went back through all of my system tests for auth, and here is a cleaned-up, though not exhaustive list of my scenarios and assertions. It seems like a lot. It is! There are also unit tests for models and controllers and mailers and separate API tests for the iOS and Android apps. Don‚Äôt take this lightly! (Remember, many of these are specific to my custom onboarding flows).</p>

<ul>
  <li>When a new user signs up for an account
    <ul>
      <li>Their email is valid, present and stored; password is nil.</li>
      <li>They are not confirmed</li>
      <li>They receive a confirmation email</li>
      <li>If not confirmed, registering again with the same email resends the confirmation email but does not leak account presence</li>
      <li>If the email associated account already exists and is confirmed, sends a ‚Äúyou already have an account‚Äù email and does not leak account presence.</li>
      <li>Following the link in the confirmation email confirms the new account and redirects to the account setup page.</li>
    </ul>
  </li>
  <li>When a user sets up their account
    <ul>
      <li>They can assign a username and password</li>
      <li>A password cannot be assigned if a password already exists</li>
      <li>A username cannot be assigned if a username already exists</li>
      <li>If a username and password already exist, the setup page redirects to the account update page</li>
      <li>The account update page redirects to the setup page if a username or password does not yet exist</li>
      <li>Signing in with an unsetup account redirects to setup page</li>
      <li>Resetting password with an unsetup account redirects to setup page</li>
      <li>Adding a password invalidates reset-password links.</li>
    </ul>
  </li>
  <li>When a user updates their account
    <ul>
      <li>The current password is required to update email, username, or password.</li>
      <li>When the email address is changed, a new confirmation email is sent out to that email address.</li>
      <li>An email change confirmation can be confirmed with or without an active session.</li>
      <li>If the email address is already confirmed by a different account, send the ‚Äúyou already have an account‚Äù email and do not leak account presence.</li>
      <li>Multiple accounts can have the same unconfirmed email address.</li>
    </ul>
  </li>
  <li>When a user performs a password reset
    <ul>
      <li>Can‚Äôt be accessed with an active session</li>
      <li>Link is invalidated after 20 minutes, or when email, or password changes.</li>
      <li>Can be performed on an unsetup account</li>
      <li>Confirms an email but not an email change</li>
      <li>Signs in the user</li>
      <li>Does not leak account presence</li>
      <li>Is throttled to only send once a minute.</li>
    </ul>
  </li>
  <li>When a user performs or resends an email confirmation
    <ul>
      <li>Can be accessed with an active session.</li>
      <li>Cannot resend confirmation of an email change without an active session.</li>
      <li>Link is invalidated after 20 minutes, or when email, unconfirmed email, confirmed at, or password changes.</li>
      <li>Signs in the user</li>
      <li>Does not leak account presence</li>
      <li>Is throttled to only send once a minute.</li>
      <li>When user is already confirmed, send them an email with a link to reset their password</li>
    </ul>
  </li>
  <li>When a user signs into a session
    <ul>
      <li>Requires a valid email or username, and password</li>
      <li>Cannot sign in with a nil, blank, or absent password param (unsetup account)</li>
      <li>Session is invalidated when email or password changes.</li>
      <li>Does not leak account presence with missing or invalid credentials</li>
      <li>Redirects to the <code class="language-plaintext highlighter-rouge">session[:return_to]</code> path if present, otherwise the root path.</li>
    </ul>
  </li>
</ul>

<h3 id="using-has_secure_password">Using <code class="language-plaintext highlighter-rouge">has_secure_password</code></h3>

<p>This was a fairly simple change. I had to explicitly add <code class="language-plaintext highlighter-rouge">bcrypt</code> to the gemfile, and then add to my <code class="language-plaintext highlighter-rouge">User</code> model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/user.rb</span>
<span class="n">alias_attribute</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:encrypted_password</span>
<span class="n">has_secure_password</span> <span class="ss">:password</span>
</code></pre></div></div>

<p>I‚Äôll eventually rename the database column, but this was a zero-migration change.</p>

<p>Also, you might need to use <code class="language-plaintext highlighter-rouge">validations: false</code>  on <code class="language-plaintext highlighter-rouge">has_secure_password</code> and implement your own validations if you have custom onboarding flows like me. Read <a href="https://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html">the docs</a> and the <a href="https://github.com/rails/rails/blob/68eade83c87ae309191add6dfa4959d7d7e07464/activemodel/lib/active_model/secure_password.rb#L114">Rails code</a>.</p>

<p>When authenticating on sign in, you‚Äôll want to use <code class="language-plaintext highlighter-rouge">User.authenticate_by(email:, password:)</code>, which is intended to avoid timing attacks.</p>

<h3 id="using-generates_token_for">Using <code class="language-plaintext highlighter-rouge">generates_token_for</code></h3>

<p>The <code class="language-plaintext highlighter-rouge">generates_token_for</code> methods are new in Rails 7.1 and <a href="https://github.com/rails/rails/pull/44189">really nice</a>. They create a signed token containing the user id and additional matching attributes and it doesn‚Äôt need to be stored in the database:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/user.rb</span>
<span class="n">generates_token_for</span> <span class="ss">:email_confirmation</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">30</span><span class="p">.</span><span class="nf">minutes</span> <span class="k">do</span>
  <span class="p">[</span><span class="n">confirmed_at</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">unconfirmed_email</span><span class="p">,</span> <span class="n">password_salt</span><span class="p">]</span>
<span class="k">end</span>

<span class="n">generates_token_for</span> <span class="ss">:password_reset</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">30</span><span class="p">.</span><span class="nf">minutes</span> <span class="k">do</span>
  <span class="p">[</span><span class="n">email</span><span class="p">,</span> <span class="n">password_salt</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I‚Äôll explain that <code class="language-plaintext highlighter-rouge">password_salt</code> in a bit.</p>

<p>To verify this, you want to do use something like this: <code class="language-plaintext highlighter-rouge">User.find_by_token_for(:email_confirmation, value_from_the_link)</code>.</p>

<p>btw security: when you put a link in an email message, you can only use a <code class="language-plaintext highlighter-rouge">GET</code> , because emails can‚Äôt reliably submit web forms (some clients can, but it‚Äôs weird and unreliable). So your link is going to look like <code class="language-plaintext highlighter-rouge">https://example.com/account/reset_password?token=blahblahblahblahblah</code>. If there is any links to 3rd party resources like script tags or off-domain images, you will <a href="https://portswigger.net/kb/issues/00500400_cross-domain-referer-leakage">leak the token through the <code class="language-plaintext highlighter-rouge">referrer</code></a>  when the page is loaded with the <code class="language-plaintext highlighter-rouge">?token=</code> in the URL. <a href="https://github.com/heartcombo/devise/pull/4366">Devise never fixed it (üò±)</a> . What you should do is take value out of the query param and put it in the session and redirect back to the same page without the query parameter and use the session value instead. (Fun fact: this is a bug bounty that got me paid.)</p>
<h3 id="authenticatable-salts">Authenticatable salts</h3>

<p>Here‚Äôs where I explain that <code class="language-plaintext highlighter-rouge">password_salt</code> value.</p>

<p>There‚Äôs several places I‚Äôve mentioned where tokens and sessions should be invalidated when the account password changes. When <code class="language-plaintext highlighter-rouge">bcrypt</code> stores the password digest in the database, it also generates and includes a random ‚Äúsalt‚Äù value that changes every time the password changes. Comparing that salt is a proxy for ‚Äúdid the password change?‚Äù and it‚Äôs safer to embed that random salt in cookies and tokens instead of the user‚Äôs hashed password.</p>

<p><a href="https://github.com/heartcombo/devise/blob/e2242a95f3bb2e68ec0e9a064238ff7af6429545/lib/devise/models/database_authenticatable.rb#L15C6-L158C1">Devise uses the first 29 characters</a> of the encrypted password (which is technically the <a href="https://en.wikipedia.org/wiki/Bcrypt#Description">algorithm, cost and salt</a>):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/user.rb</span>
<span class="k">def</span> <span class="nf">authenticatable_salt</span>
  <span class="n">encrypted_password</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">29</span><span class="p">]</span> <span class="k">if</span> <span class="n">encrypted_password</span>
<span class="k">end</span>
</code></pre></div></div>

<p>But it‚Äôs also possible to simply get the salt. I dunno if the difference matters (tell me!):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/user.rb</span>
<span class="k">def</span> <span class="nf">password_salt</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">password_digest</span><span class="p">).</span><span class="nf">salt</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="o">..</span><span class="p">]</span> <span class="k">if</span> <span class="n">password_digest</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="a-nice-session">A nice session</h3>

<p>There‚Äôs a lot to write about creating sessions and remember-me cookies, that I won‚Äôt be writing here. The main thing to note is that I‚Äôm storing and verifying both the user id <em>and</em> their password salt in the session; that means all of their session are invalidated when they change their password:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/application_controller.rb</span>
<span class="no">UNASSIGNED</span> <span class="o">=</span> <span class="no">Module</span><span class="p">.</span><span class="nf">new</span>
<span class="no">USER_SESSION_KEY</span> <span class="o">=</span> <span class="s2">"_yoursite_user"</span><span class="p">.</span><span class="nf">freeze</span>

<span class="k">def</span> <span class="nf">initialize</span>
  <span class="k">super</span>
  <span class="vi">@_current_user</span> <span class="o">=</span> <span class="no">UNASSIGNED</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">session</span><span class="p">[</span><span class="no">USER_SESSION_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">password_salt</span><span class="p">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">current_user</span>
  <span class="k">return</span> <span class="vi">@_current_user</span> <span class="k">unless</span> <span class="vi">@_current_user</span> <span class="o">==</span> <span class="no">UNASSIGNED</span>

  <span class="c1"># Check if the user was already loaded by route helpers</span>
  <span class="vi">@_current_user</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="s2">"current_user"</span><span class="p">)</span>
                     <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"current_user"</span><span class="p">]</span>
                   <span class="k">else</span>
                     <span class="n">user_id</span><span class="p">,</span> <span class="n">password_salt</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="no">USER_SESSION_KEY</span><span class="p">]</span>
                     <span class="no">User</span><span class="p">.</span><span class="nf">find_by_id_and_password_salt</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">password_salt</span><span class="p">)</span> <span class="k">if</span> <span class="n">user_id</span> <span class="o">&amp;&amp;</span> <span class="n">password_salt</span>
                   <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<p>In doing this project I learned that Rail‚Äôs cookies will magically serialize/deserialize arrays and hashes. I‚Äôve been manually and laboriously converting them into JSON strings <em>for years</em> ü•µ</p>

<p>btw, if that <code class="language-plaintext highlighter-rouge">UNASSIGNED</code> stuff is new to you, go read my <a href="https://island94.org/2023/10/writing-object-shape-friendly-code-in-ruby">Writing Object Shape friendly code in Ruby</a>.</p>

<h3 id="rotating-active-sessions">Rotating active sessions</h3>

<p>This is a little <em>extra</em> but I wanted the switchover to be transparent to users. To do so, I read from Devise‚Äôs active sessions and then create a session cookie using the new format. It looks something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># controllers/application_controller.rb</span>
<span class="n">before_action</span> <span class="ss">:upgrade_devise_session</span>

<span class="k">def</span> <span class="nf">upgrade_devise_session</span>
  <span class="c1"># Devise session structure: [[USER_ID],"AUTHENTICATABLE_SALT"]</span>
  <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s2">"warden.user.user.key"</span><span class="p">].</span><span class="nf">present?</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">"warden.user.user.key"</span><span class="p">].</span><span class="nf">dig</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">user_salt</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">"warden.user.user.key"</span><span class="p">].</span><span class="nf">dig</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">elsif</span> <span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="s2">"remember_user_token"</span><span class="p">].</span><span class="nf">present?</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="s2">"remember_user_token"</span><span class="p">].</span><span class="nf">dig</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">user_salt</span> <span class="o">=</span> <span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="s2">"remember_user_token"</span><span class="p">].</span><span class="nf">dig</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="k">unless</span> <span class="n">user_id</span><span class="p">.</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> <span class="n">user_salt</span><span class="p">.</span><span class="nf">present?</span>

  <span class="c1"># Depending on your deploy/rollout strategy ,</span>
  <span class="c1"># you may want need to retain and dual-write both</span>
  <span class="c1"># Devise and new user session values instead of this.</span>
  <span class="n">session</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"warden.user.user.key"</span><span class="p">)</span>
  <span class="n">cookies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"remember_user_token"</span><span class="p">)</span>

  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">user_id</span><span class="p">)</span>
  <span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="p">.</span><span class="nf">devise_authenticatable_salt</span> <span class="o">==</span> <span class="n">user_salt</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="route-helpers">Route helpers</h3>

<p>Devise mixes some nice helper methods into Rails‚Äôs routing DSL like <code class="language-plaintext highlighter-rouge">authenticated</code>; they‚Äôre even <em>necessary</em> if you need to authenticate Rails Engines that can‚Äôt easily access the app‚Äôs ApplicationController methods. Here‚Äôs how to recreate them using <a href="https://guides.rubyonrails.org/routing.html#advanced-constraints">Route Constraints</a> and monkeypatching <code class="language-plaintext highlighter-rouge">ActionDispatch::Routing::Mapper</code> (that‚Äôs <a href="https://github.com/heartcombo/devise/blob/e2242a95f3bb2e68ec0e9a064238ff7af6429545/lib/devise/rails/routes.rb#L28">how Devise does it</a>)</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/constraints/current_user_constraint.rb</span>
<span class="k">class</span> <span class="nc">CurrentUserConstraint</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">matches?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">new</span><span class="p">.</span><span class="nf">matches?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="vi">@block</span> <span class="o">=</span> <span class="n">block</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">matches?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">current_user</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="s2">"current_user"</span><span class="p">)</span>
                      <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"current_user"</span><span class="p">]</span>
                    <span class="k">else</span>
                      <span class="n">user_id</span><span class="p">,</span> <span class="n">password_salt</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">session</span><span class="p">[</span><span class="no">USER_SESSION_KEY</span><span class="p">]</span>
                      <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"current_user"</span><span class="p">]</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_id_and_password_salt</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">password_salt</span><span class="p">)</span> <span class="k">if</span> <span class="n">user_id</span> <span class="o">&amp;&amp;</span> <span class="n">password_salt</span>
                   <span class="k">end</span>

    <span class="k">if</span> <span class="vi">@block</span>
      <span class="vi">@block</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">current_user</span><span class="p">.</span><span class="nf">present?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="c1"># config/routes.rb</span>
<span class="k">module</span> <span class="nn">ActionDispatch</span>
  <span class="k">module</span> <span class="nn">Routing</span>
    <span class="k">class</span> <span class="nc">Mapper</span>
      <span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span><span class="o">&amp;</span><span class="p">)</span>
        <span class="n">scope</span><span class="p">(</span><span class="ss">constraints: </span><span class="no">CurrentUserConstraint</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">unauthenticated</span><span class="p">(</span><span class="o">&amp;</span><span class="p">)</span>
        <span class="n">scope</span><span class="p">(</span><span class="ss">constraints: </span><span class="no">CurrentUserConstraint</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="p">.</span><span class="nf">blank?</span> <span class="p">},</span> <span class="o">&amp;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">admin_only</span><span class="p">(</span><span class="o">&amp;</span><span class="p">)</span>
        <span class="n">scope</span><span class="p">(</span><span class="ss">constraints: </span><span class="no">CurrentUserConstraint</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">admin?</span> <span class="p">},</span> <span class="o">&amp;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">authenticated</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="ss">:special_somethings</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Because routing happens <em>before</em> a controller is initialized, the current user is put into <code class="language-plaintext highlighter-rouge">request.env</code> so that the controller won‚Äôt have to query it a second time from the database. This could also be done in a custom Rack Middleware.</p>

<p>If you want to put stuff into not-the-session cookies, those cookies can be accessed via <code class="language-plaintext highlighter-rouge">request.cookie_jar,</code> e.g., <code class="language-plaintext highlighter-rouge">request.cookie_jar.permanent.encrypted["_my_cookie"]</code>.</p>

<h3 id="closing-thoughts">Closing thoughts</h3>

<p>That was all the interesting bits for me. I also learned quite a bit poking around Dave Kimura‚Äôs <a href="https://github.com/kobaltz/action_auth">ActionAuth</a> (thank you!), and am thankful for the many years of service I‚Äôve gotten from Devise.</p>


  </div>
</article>


<div class="card my-4">
  <div class="card-body">
    <p>
      Discuss this with me on <a href="https://twitter.com/bensheldon"><i class="bi bi-twitter"></i> Twitter</a>
      or suggest a <a href="https://github.com/bensheldon/island94-jekyll/blob/main/_posts/2024-01-27-replacing-devise-with-rails-has_secure_password-and-friends.md"><i class="bi bi-github"></i> change</a>.
    </p>

    <p>Related Posts:</p>
    <ul>
      
        <li><a href="/2024/11/keep-your-secrets-yml-in-rails-7-2">Keep your secrets.yml in Rails 7.2+</a></li>
      
        <li><a href="/2024/10/technical-reflection-on-disaster-relief-assistance-for-immigrants">A mostly technical reflection on Disaster Relief Assistance for Immigrants</a></li>
      
        <li><a href="/2024/09/spectator-sport-a-brief-introduction-to-an-upcoming-rails-plugin">Spectator Sport, a brief introduction to an upcoming Rails plugin</a></li>
      
        <li><a href="/2024/09/seeing-like-a-rails-and-ruby-platform-team">Seeing like a Rails and Ruby platform team</a></li>
      
        <li><a href="/2024/09/secret-to-rails-database-connection-pool-size">The secret to perfectly calculate Rails database connection pool size</a></li>
      
    </ul>
  </div>
</div>


    </div>

    <footer class="site-footer">

</footer>


  </body>

</html>
