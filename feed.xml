<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Island94.org</title>
    <description>A Lost and Found
</description>
    <link>https://island94.org/</link>
    <atom:link href="https://island94.org/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Sat, 27 Jan 2024 16:49:08 +0000</pubDate>
    <lastBuildDate>Sat, 27 Jan 2024 16:49:08 +0000</lastBuildDate>
    <generator>Jekyll v4.3.3</generator>
    
    
      
        




<item>
  <title>Replacing Devise with Rails `has_secure_password` and friends</title>
  <description>&lt;p&gt;I love the &lt;a href=&quot;https://github.com/heartcombo/devise&quot;&gt;Devise user-authentication gem&lt;/a&gt;. I‚Äôve used it for years, and I recently moved off of it in one of my personal apps and replaced it with Rails‚Äôs built-in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;has_secure_password&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;generates_secure_token&lt;/code&gt; and a whole bunch of custom controllers and helpers and code that I now maintain myself. &lt;strong&gt;I do not recommend this! User authentication is hard! Security is hard!&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;And‚Ä¶&lt;/strong&gt; maybe you need to walk the same path too. So I want to share what I learned through the process.&lt;/p&gt;

&lt;p&gt;Ok, so to back up, why did I do this?&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Greater compatibility with Rails &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main&lt;/code&gt;. My &lt;a href=&quot;https://github.blog/2023-04-06-building-github-with-ruby-and-rails/&quot;&gt;day job runs Rails &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main&lt;/code&gt;&lt;/a&gt;, and I‚Äôm more frequently contributing to Rails development; I‚Äôd like to run my personal projects on Rails &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main&lt;/code&gt; too. When I looked back on upgrade-blocking gems, Devise (and its dependencies, like Responders) topped my list.&lt;/li&gt;
  &lt;li&gt;More creative onboarding flows. I‚Äôve twisted Devise quite a bit (it‚Äôs great!) to handle the different ways I want users to be able to register (elaborate onboarding flows, email-only subscriptions, optional passwords, magic logins). I‚Äôve already customized or overloaded nearly every Devise controller and many model methods, so it didn‚Äôt seem like such a big change anyway.&lt;/li&gt;
  &lt;li&gt;Hubris. I‚Äôve built enterprise auth systems from scratch, managed the Bug Bounty program, and worked with security researchers. I have seen and caused and fixed some shit. (Fun fact: I have been paid for reporting auth vulnerabilities on the bug bounty platforms themselves.) I know that even if it‚Äôs not a bad idea &lt;em&gt;for me&lt;/em&gt;, it‚Äôs not a great idea either. Go read &lt;a href=&quot;https://github.com/advisories?query=devise+ecosystem%3Arubygems&quot;&gt;all of the Devise-related CVEs&lt;/a&gt;; seriously, it‚Äôs a responsibility.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That last bit is why this blog post will not be like, ‚ÄúHere‚Äôs everything you need to know and do to ditch Devise.‚Äù Don‚Äôt do it! Instead, here‚Äôs some stuff I learned that I want to remember for the next app I work on.&lt;/p&gt;

&lt;h3 id=&quot;a-test-regime&quot;&gt;A test regime&lt;/h3&gt;

&lt;p&gt;I went back through all of my system tests for auth, and here is a cleaned-up, though not exhaustive list of my scenarios and assertions. It seems like a lot. It is! There are also unit tests for models and controllers and mailers and separate API tests for the iOS and Android apps. Don‚Äôt take this lightly! (Remember, many of these are specific to my custom onboarding flows).&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;When a new user signs up for an account
    &lt;ul&gt;
      &lt;li&gt;Their email is valid, present and stored; password is nil.&lt;/li&gt;
      &lt;li&gt;They are not confirmed&lt;/li&gt;
      &lt;li&gt;They receive a confirmation email&lt;/li&gt;
      &lt;li&gt;If not confirmed, registering again with the same email resends the confirmation email but does not leak account presence&lt;/li&gt;
      &lt;li&gt;If the email associated account already exists and is confirmed, sends a ‚Äúyou already have an account‚Äù email and does not leak account presence.&lt;/li&gt;
      &lt;li&gt;Following the link in the confirmation email confirms the new account and redirects to the account setup page.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user sets up their account
    &lt;ul&gt;
      &lt;li&gt;They can assign a username and password&lt;/li&gt;
      &lt;li&gt;A password cannot be assigned if a password already exists&lt;/li&gt;
      &lt;li&gt;A username cannot be assigned if a username already exists&lt;/li&gt;
      &lt;li&gt;If a username and password already exist, the setup page redirects to the account update page&lt;/li&gt;
      &lt;li&gt;The account update page redirects to the setup page if a username or password does not yet exist&lt;/li&gt;
      &lt;li&gt;Signing in with an unsetup account redirects to setup page&lt;/li&gt;
      &lt;li&gt;Resetting password with an unsetup account redirects to setup page&lt;/li&gt;
      &lt;li&gt;Adding a password invalidates reset-password links.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user updates their account
    &lt;ul&gt;
      &lt;li&gt;The current password is required to update email, username, or password.&lt;/li&gt;
      &lt;li&gt;When the email address is changed, a new confirmation email is sent out to that email address.&lt;/li&gt;
      &lt;li&gt;An email change confirmation can be confirmed with or without an active session.&lt;/li&gt;
      &lt;li&gt;If the email address is already confirmed by a different account, send the ‚Äúyou already have an account‚Äù email and do not leak account presence.&lt;/li&gt;
      &lt;li&gt;Multiple accounts can have the same unconfirmed email address.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user performs a password reset
    &lt;ul&gt;
      &lt;li&gt;Can‚Äôt be accessed with an active session&lt;/li&gt;
      &lt;li&gt;Link is invalidated after 20 minutes, or when email, or password changes.&lt;/li&gt;
      &lt;li&gt;Can be performed on an unsetup account&lt;/li&gt;
      &lt;li&gt;Confirms an email but not an email change&lt;/li&gt;
      &lt;li&gt;Signs in the user&lt;/li&gt;
      &lt;li&gt;Does not leak account presence&lt;/li&gt;
      &lt;li&gt;Is throttled to only send once a minute.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user performs or resends an email confirmation
    &lt;ul&gt;
      &lt;li&gt;Can be accessed with an active session.&lt;/li&gt;
      &lt;li&gt;Cannot resend confirmation of an email change without an active session.&lt;/li&gt;
      &lt;li&gt;Link is invalidated after 20 minutes, or when email, unconfirmed email, confirmed at, or password changes.&lt;/li&gt;
      &lt;li&gt;Signs in the user&lt;/li&gt;
      &lt;li&gt;Does not leak account presence&lt;/li&gt;
      &lt;li&gt;Is throttled to only send once a minute.&lt;/li&gt;
      &lt;li&gt;When user is already confirmed, send them an email with a link to reset their password&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user signs into a session
    &lt;ul&gt;
      &lt;li&gt;Requires a valid email or username, and password&lt;/li&gt;
      &lt;li&gt;Cannot sign in with a nil, blank, or absent password param (unsetup account)&lt;/li&gt;
      &lt;li&gt;Session is invalidated when email or password changes.&lt;/li&gt;
      &lt;li&gt;Does not leak account presence with missing or invalid credentials&lt;/li&gt;
      &lt;li&gt;Redirects to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;session[:return_to]&lt;/code&gt; path if present, otherwise the root path.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;using-has_secure_password&quot;&gt;Using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;has_secure_password&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;This was a fairly simple change. I had to explicitly add &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bcrypt&lt;/code&gt; to the gemfile, and then add to my &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User&lt;/code&gt; model:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;alias_attribute&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:password_digest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:encrypted_password&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;has_secure_password&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:password&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I‚Äôll eventually rename the database column, but this was a zero-migration change.&lt;/p&gt;

&lt;p&gt;Also, you might need to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;validations: false&lt;/code&gt;  on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;has_secure_password&lt;/code&gt; and implement your own validations if you have custom onboarding flows like me. Read &lt;a href=&quot;https://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html&quot;&gt;the docs&lt;/a&gt; and the &lt;a href=&quot;https://github.com/rails/rails/blob/68eade83c87ae309191add6dfa4959d7d7e07464/activemodel/lib/active_model/secure_password.rb#L114&quot;&gt;Rails code&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;When authenticating on sign in, you‚Äôll want to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User.authenticate_by(email:, password:)&lt;/code&gt;, which is intended to avoid timing attacks.&lt;/p&gt;

&lt;h3 id=&quot;using-generates_token_for&quot;&gt;Using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;generates_token_for&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;generates_token_for&lt;/code&gt; methods are new in Rails 7.1 and &lt;a href=&quot;https://github.com/rails/rails/pull/44189&quot;&gt;really nice&lt;/a&gt;. They create a signed token containing the user id and additional matching attributes and it doesn‚Äôt need to be stored in the database:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;generates_token_for&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:email_confirmation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;expires_in: &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;minutes&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;confirmed_at&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unconfirmed_email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;generates_token_for&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:password_reset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;expires_in: &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;minutes&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I‚Äôll explain that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;password_salt&lt;/code&gt; in a bit.&lt;/p&gt;

&lt;p&gt;To verify this, you want to do use something like this: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User.find_by_token_for(:email_confirmation, value_from_the_link)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;btw security: when you put a link in an email message, you can only use a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GET&lt;/code&gt; , because emails can‚Äôt reliably submit web forms (some clients can, but it‚Äôs weird and unreliable). So your link is going to look like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://example.com/account/reset_password?token=blahblahblahblahblah&lt;/code&gt;. If there is any links to 3rd party resources like script tags or off-domain images, you will &lt;a href=&quot;https://portswigger.net/kb/issues/00500400_cross-domain-referer-leakage&quot;&gt;leak the token through the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;referrer&lt;/code&gt;&lt;/a&gt;  when the page is loaded with the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;?token=&lt;/code&gt; in the URL. &lt;a href=&quot;https://github.com/heartcombo/devise/pull/4366&quot;&gt;Devise never fixed it (üò±)&lt;/a&gt; . What you should do is take value out of the query param and put it in the session and redirect back to the same page without the query parameter and use the session value instead. (Fun fact: this is a bug bounty that got me paid.)&lt;/p&gt;
&lt;h3 id=&quot;authenticatable-salts&quot;&gt;Authenticatable salts&lt;/h3&gt;

&lt;p&gt;Here‚Äôs where I explain that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;password_salt&lt;/code&gt; value.&lt;/p&gt;

&lt;p&gt;There‚Äôs several places I‚Äôve mentioned where tokens and sessions should be invalidated when the account password changes. When &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bcrypt&lt;/code&gt; stores the password digest in the database, it also generates and includes a random ‚Äúsalt‚Äù value that changes every time the password changes. Comparing that salt is a proxy for ‚Äúdid the password change?‚Äù and it‚Äôs safer to embed that random salt in cookies and tokens instead of the user‚Äôs hashed password.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/heartcombo/devise/blob/e2242a95f3bb2e68ec0e9a064238ff7af6429545/lib/devise/models/database_authenticatable.rb#L15C6-L158C1&quot;&gt;Devise uses the first 29 characters&lt;/a&gt; of the encrypted password (which is technically the &lt;a href=&quot;https://en.wikipedia.org/wiki/Bcrypt#Description&quot;&gt;algorithm, cost and salt&lt;/a&gt;):&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;authenticatable_salt&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;encrypted_password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;29&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encrypted_password&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But it‚Äôs also possible to simply get the salt. I dunno if the difference matters (tell me!):&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;password_salt&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;BCrypt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;password_digest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_digest&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;a-nice-session&quot;&gt;A nice session&lt;/h3&gt;

&lt;p&gt;There‚Äôs a lot to write about creating sessions and remember-me cookies, that I won‚Äôt be writing here. The main thing to note is that I‚Äôm storing and verifying both the user id &lt;em&gt;and&lt;/em&gt; their password salt in the session; that means all of their session are invalidated when they change their password:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# app/controllers/application_controller.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;UNASSIGNED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;_yoursite_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;freeze&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;super&lt;/span&gt;
  &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;UNASSIGNED&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;sign_in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;current_user&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;unless&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;UNASSIGNED&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# Check if the user was already loaded by route helpers&lt;/span&gt;
  &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;key?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                     &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                     &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                     &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by_id_and_password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In doing this project I learned that Rail‚Äôs cookies will magically serialize/deserialize arrays and hashes. I‚Äôve been manually and laboriously converting them into JSON strings &lt;em&gt;for years&lt;/em&gt; ü•µ&lt;/p&gt;

&lt;p&gt;btw, if that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;UNASSIGNED&lt;/code&gt; stuff is new to you, go read my &lt;a href=&quot;https://island94.org/2023/10/writing-object-shape-friendly-code-in-ruby&quot;&gt;Writing Object Shape friendly code in Ruby&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;rotating-active-sessions&quot;&gt;Rotating active sessions&lt;/h3&gt;

&lt;p&gt;This is a little &lt;em&gt;extra&lt;/em&gt; but I wanted the switchover to be transparent to users. To do so, I read from Devise‚Äôs active sessions and then create a session cookie using the new format. It looks something like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# controllers/application_controller.rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;before_action&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:upgrade_devise_session&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;upgrade_devise_session&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Devise session structure: [[USER_ID],&quot;AUTHENTICATABLE_SALT&quot;]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;signed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;signed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;signed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;unless&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# Depending on your deploy/rollout strategy ,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# you may want need to retain and dual-write both&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Devise and new user session values instead of this.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;id: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;sign_in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;devise_authenticatable_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;route-helpers&quot;&gt;Route helpers&lt;/h3&gt;

&lt;p&gt;Devise mixes some nice helper methods into Rails‚Äôs routing DSL like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;authenticated&lt;/code&gt;; they‚Äôre even &lt;em&gt;necessary&lt;/em&gt; if you need to authenticate Rails Engines that can‚Äôt easily access the app‚Äôs ApplicationController methods. Here‚Äôs how to recreate them using &lt;a href=&quot;https://guides.rubyonrails.org/routing.html#advanced-constraints&quot;&gt;Route Constraints&lt;/a&gt; and monkeypatching &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ActionDispatch::Routing::Mapper&lt;/code&gt; (that‚Äôs &lt;a href=&quot;https://github.com/heartcombo/devise/blob/e2242a95f3bb2e68ec0e9a064238ff7af6429545/lib/devise/rails/routes.rb#L28&quot;&gt;how Devise does it&lt;/a&gt;)&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# app/constraints/current_user_constraint.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;CurrentUserConstraint&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;matches?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;matches?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@block&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;matches?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;key?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                      &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                      &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                      &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by_id_and_password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@block&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;


&lt;span class=&quot;c1&quot;&gt;# config/routes.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;ActionDispatch&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Routing&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Mapper&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;authenticated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;constraints: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CurrentUserConstraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;unauthenticated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;constraints: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CurrentUserConstraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;blank?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;admin_only&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;constraints: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CurrentUserConstraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;admin?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;routes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;draw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;authenticated&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;resources&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:special_somethings&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because routing happens &lt;em&gt;before&lt;/em&gt; a controller is initialized, the current user is put into &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;request.env&lt;/code&gt; so that the controller won‚Äôt have to query it a second time from the database. This could also be done in a custom Rack Middleware.&lt;/p&gt;

&lt;p&gt;If you want to put stuff into not-the-session cookies, those cookies can be accessed via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;request.cookie_jar,&lt;/code&gt; e.g., &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;request.cookie_jar.permanent.encrypted[&quot;_my_cookie&quot;]&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&quot;closing-thoughts&quot;&gt;Closing thoughts&lt;/h3&gt;

&lt;p&gt;That was all the interesting bits for me. I also learned quite a bit poking around Dave Kimura‚Äôs &lt;a href=&quot;https://github.com/kobaltz/action_auth&quot;&gt;ActionAuth&lt;/a&gt; (thank you!), and am thankful for the many years of service I‚Äôve gotten from Devise.&lt;/p&gt;


  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/01/replacing-devise-with-rails-has_secure_password-and-friends&quot;&gt;Replacing Devise with Rails `has_secure_password` and friends&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Sat, 27 Jan 2024 15:43:00 +0000</pubDate>
  <link>https://island94.org/2024/01/replacing-devise-with-rails-has_secure_password-and-friends</link>
  <guid isPermaLink="true">https://island94.org/2024/01/replacing-devise-with-rails-has_secure_password-and-friends</guid>
  
    <category>rails</category>
  
    <category>ruby</category>
  
  
</item>

      
    
      
        




<item>
  <title>Two stories about technical debt, I guess</title>
  <description>&lt;p&gt;One activity I don‚Äôt enjoy very much: griping about ‚Äútechnical debt‚Äù; that label just never seems descriptive enough. And the things people gripe about seem to mostly fall into:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Deferred maintenance: we haven‚Äôt updated to the latest version of X, or it‚Äôs written in A language/framework but now everyone is much more familiar with B, or we know M raises an exception at N when they O while P&lt;/li&gt;
  &lt;li&gt;Just not the quality we expect, &lt;a href=&quot;https://cutlefish.substack.com/p/tbm-267-debt-and-bridge-building&quot;&gt;because &lt;em&gt;reasons&lt;/em&gt;&lt;/a&gt;. It‚Äôs ok, we‚Äôre all winging it.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;‚Ä¶and those categories crowds out the real sweaty palms stuff, the ‚Äúwe did do a good job but we know more now‚Äù that I think is the real deal. I can talk about that.&lt;/p&gt;

&lt;p&gt;I‚Äôve never found the particular post/video/talk? again (I‚Äôve looked!), but it described technical debt as like: the distance between the current understanding of the business domain and the technical implementation‚Äôs modeling of the business domain. It had a chart that has stuck in my mind; it looked something like this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/uploads/2024-01/technical-debt.png&quot;&gt;&lt;img src=&quot;/uploads/2024-01/technical-debt.png&quot; alt=&quot;A chart that shows the coming together and divergence of business and technical domain knowledge&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That definition of ‚Äútechnical debt‚Äù clicked for me. For myself and the high performing teams I‚Äôve worked with, we‚Äôre most productive, pushing value, when we‚Äôre asking ourselves: does this make sense? Given what we know now, and what we know about where we‚Äôre going, do the objects and their interactions conceptually map to how the business is being talked about by the non-technical people? Are we adapting &lt;a href=&quot;https://codeforamerica.org/news/engineering-principles-at-code-for-america/#:~:text=Optimize%20for%20speed%20of%20learning&quot;&gt;at the same rate we‚Äôre learning&lt;/a&gt;? If yes, we‚Äôre golden; if sorta with some tweaks that‚Äôs good; when no‚Ä¶ that‚Äôs bad, disordered, schismatic: carrying a burden of always translating between the language and models in the technical system and the language and concepts in the business domain. That sucks!&lt;/p&gt;

&lt;p&gt;Aside: There‚Äôs a funny/terrifying/random thing this makes me think of: &lt;a href=&quot;https://www.vulture.com/article/an-oral-history-of-disney-the-emperors-new-groove.html&quot;&gt;‚ÄúWe‚Äôll Never Make That Kind of Movie Again‚Äù: An oral history of The Emperor‚Äôs New Groove, a raucous Disney animated film that almost never happened&lt;/a&gt;. One of the screenwriters describes the process of making an animated film:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;In a normal four-year process, you‚Äôve got meetings, you‚Äôve got development people going, ‚ÄúWhat if the girl was a boy? What if the bird was a flower?‚Äù And then you have to run all those ideas.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The software projects I‚Äôve worked on are a conveyor belt of ‚ÄúWhat if the bird was a flower?‚Äù decision making and idea running. Extend that object, repurpose this method, bolt on that, change this, swap that, rename this, better leave a comment on that. When it‚Äôs going well, it doesn‚Äôt matter that it was a bird yesterday and a flower today‚Ä¶ as long as it‚Äôs not retaining so much birdliness that it compromises its flowerability. It‚Äôs when you‚Äôre having to remember and callback ‚Äúhey, well, um, it &lt;em&gt;was&lt;/em&gt; once a bird, fyi, that‚Äôs why it‚Äôs so much trouble to do this flower stuff‚Äù, then you‚Äôre sunk.&lt;/p&gt;

&lt;p&gt;It‚Äôs a bad sign when forward development requires telling stories about the past.&lt;/p&gt;

&lt;p&gt;Here‚Äôs two stories‚Ä¶&lt;/p&gt;

&lt;h3 id=&quot;the-isolated-component&quot;&gt;The isolated component&lt;/h3&gt;

&lt;p&gt;When I was working at a website hosting startup, we had one component that I could just never get the support to integrate into the larger application. It was the form that would create a new website project for the user.  When the startup began, the original technical architecture was a bunch of interlinked but separated components: User Registration, User Account Management, Website Creation, Website Management, Organization Management, Agency/Reseller Management, etc. It made sense early as the business was figuring out what worked as a business, and then during my tenure we brought those components together into a unified application. Well, almost all of them.&lt;/p&gt;

&lt;p&gt;There was a lot of give and take in the product integration; sometimes me and the other engineers would just &lt;em&gt;do it&lt;/em&gt; and other times we‚Äôd defer it until there was a particular feature that necessitated it, and then we‚Äôd include that extra work in our estimates. It frequently took a &lt;a href=&quot;https://speakerdeck.com/bensheldon/real-world-dashboard&quot;&gt;couple passes&lt;/a&gt; of &lt;a href=&quot;https://speakerdeck.com/bensheldon/dashboard-performance-brownbag&quot;&gt;code cleanup&lt;/a&gt; and bringing it onto the design system, and that was ok. That‚Äôs the job!&lt;/p&gt;

&lt;p&gt;That last, last, last component of Website Creation eluded us though, and it was outside our control. At that point, development was transitioning from ‚Äúengineering led‚Äù to ‚Äúproduct management and design led‚Äù and I had been instructed that engineering couldn‚Äôt make any product changes unless they were connected to an active PRD (Product Requirements Document) controlled by the PMs.&lt;/p&gt;

&lt;p&gt;There was plenty of demand to make changes to Website Creation: smooth out the first-time account registration flow into creating a website; allow the user to do some activities in parallel while the website was spinning up like inviting team members or perusing billing levels; decouple the concept of ‚Äúa website is a marketing strategy‚Äù from ‚Äúupload your code and have some containers and a load balancer provisioned‚Äù so that non-developers could still &lt;em&gt;plan&lt;/em&gt; a website without invoking all the technical bits.&lt;/p&gt;

&lt;p&gt;But not enough appetite to get it done.&lt;/p&gt;

&lt;p&gt;Of ‚Äútechnical debt‚Äù: everyone except our little engineering team maintaining the frontend didn‚Äôt think anything special of Website Creation. It wasn‚Äôt obvious unless you carefully watched for the hard-browser refresh, or noticed the navigation bar change slightly. Conceptually it was a unified product (heck, I even remember a product launch called ‚ÄúOne‚Äù), but the work hadn‚Äôt yet been done on the application side and we engineers carried the burden.&lt;/p&gt;

&lt;p&gt;It was funny because every time a product change that touched Website creation was discussed, the same thing happened:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;PM:&lt;/strong&gt; Your effort estimate seems really high. What‚Äôs going on?
&lt;br /&gt;&lt;strong&gt;Me:&lt;/strong&gt; Well, this involves Website Creation and it‚Äôs still its own component and can‚Äôt access any of those other systems that are necessary to build the feature. We‚Äôd need to bring it into the rest of the application. It‚Äôs definitely possible! There‚Äôs a few open questions with product and design implications, so we‚Äôd need to work together on that.
&lt;br /&gt;&lt;strong&gt;PM:&lt;/strong&gt; Oh, well, huh, I didn‚Äôt expect that. Hmm, we don‚Äôt have the bandwidth for all that. Let‚Äôs pass on it for now.&lt;/p&gt;

&lt;p&gt;This happened multiple times! It was weird too because the particular project being planned would be spiked, and then the engineering team would have to wait around while a new project was spun up and that likely took just as long as it would have taken to do the work on the Website Creation component. If I hadn‚Äôt been explicitly told to sit on my hands otherwise, I would have probably just done this as off-the-books, shucks-I-didn‚Äôt-think-it-would-be-a-big-deal, shadow-work.&lt;/p&gt;

&lt;p&gt;It never got done during my tenure; I think they later decided the problem was that the whole thing wasn‚Äôt written in React ü§∑&lt;/p&gt;

&lt;h3 id=&quot;the-campaign-message&quot;&gt;The campaign message&lt;/h3&gt;

&lt;p&gt;When I was a developer on GetCalFresh, the functionality with perpetually unexpected estimations was ‚ÄúCampaign Messages‚Äù.&lt;/p&gt;

&lt;p&gt;GetCalFresh would help people apply for their initial food stamp application, at which point it would be sent to the applicant‚Äôs county for processing. Over the next 14 to 28 days the county would schedule an in-person or telephone interview, and request various documents like pay stubs and rental leases, and the applicant would have to navigate all of that. (The administrative state &lt;a href=&quot;https://daveguarino.substack.com/p/state-snap-agencies-are-overloaded&quot;&gt;suuuuucks&lt;/a&gt;!) To help, GetCalFresh would send a sequence of email and/or SMS messages to the applicant over this time period explaining what was needed and what to expect next. A messaging campaign, y‚Äôknow, of ‚Äúcampaign messages‚Äù&lt;/p&gt;

&lt;p&gt;When GetCalFresh was first laid down in code, there were two ‚Äútypes‚Äù of campaign messages: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;General&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Expedited&lt;/code&gt;. Under a couple of different circumstances, if an applicant is homeless or at risk of being homeless, or has no cash-on-hand to purchase food, their application is eligible for expedited processing and thus we‚Äôd send them a message sequence over ~14 days; everyone else would receive a message sequence over ~28 days. We were sending the same messages, just on a different schedule.&lt;/p&gt;

&lt;p&gt;So when we engineers were then asked to customize a message, like ‚Äúif the applicant is a student, add this description about their special eligibility‚Äù‚Ä¶ we just &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;if/elsed&lt;/code&gt; it on in there. Oh, now this county is piloting a special process, let‚Äôs make a little carve out for them too and swap this message. Still, same sequence, just tweaks, right? Well, all those small tweaks and carve-outs build up, and all of a sudden we‚Äôre having to ask ‚Äúok, so you want us to rewrite this one itty bitty message, well we also need you to specify what it should be for students, who do and don‚Äôt qualify for County X‚Äôs special process too‚Äù. It got twistier and twistier. And when requests like ‚Äúdon‚Äôt send that message in this special circumstance‚Äù or ‚Äúadd a totally new message but just as this one-off‚Äù came in, we‚Äôd be like ‚Äútotally possible! and that‚Äôs gonna take more work than you think!‚Äù&lt;/p&gt;

&lt;p&gt;GetCalFresh had the best Product Managers I have ever worked with in my life, and we still got locked into a similar loop as the last story: we‚Äôd do our estimation with the PMs, it exposed the fruit hung more high than low, and the change would be deprioritized. I think the PMs got it, but the challenge was that the other folks, client support and the folks coordinating with the counties and the datascience team, would be like ‚Äúwe heard that Engineering doesn‚Äôt want to build it.‚Äù So weird! Not engineering‚Äôs call! (Aside: I spent so much time coaching non-technical stakeholders on how to work in a PM-led system, but always more coaching to do.)&lt;/p&gt;

&lt;p&gt;I remember making a Google Doc to analyze why and explain how the system we initially designed for (same sequence of messages with different schedules) didn‚Äôt match our understanding of the problem today. The doc listed out all of the different reasons we knew of why we might customize the message. It was at least 10 bullet points. And there were a lot of other learnings too: initially we designed around customizing for just 3 major county systems (State Automated Welfare Systems - SAWS), but later found ourselves doing county-by-county customizations (California has 52 counties). I advocated for configuring each county in its own object despite the &lt;em&gt;scale&lt;/em&gt; brainworms demanding a singular and infinitely abstracted model (I call these things ‚Äúspreadsheet problems‚Äù when you can simply list the entire domain in a spreadsheet).&lt;/p&gt;

&lt;p&gt;Of ‚Äútechnical debt‚Äù, I still can replay in my brain the deliberate mental spatial shift of imagining the campaign model as a 2-column array (General and Expedited) with 10+ rows of logic shifts and then flopping it onto its side to make a change. All that mental context has a huge carrying cost that all of us had to budget for when making a change.&lt;/p&gt;

&lt;p&gt;During my tenure, we never did the significant reworking to how campaign messages were implemented, though some bold colleagues did their best to make changes as safe and simple as possible with DSLs and test macros. Thank you! üôè&lt;/p&gt;

&lt;h3 id=&quot;thats-it&quot;&gt;That‚Äôs it&lt;/h3&gt;

&lt;p&gt;Sorry, no great lessons here. Just stories to share (&lt;a href=&quot;https://island94.org/2024/01/recently#:~:text=try%20to%20see%20it%20as%20a%20funny%20story&quot;&gt;‚Äúideally you‚Äôd try to see it as a funny story you can tell friends rather than a hurtful snub that needs to bother you‚Äù&lt;/a&gt;) I mentioned coaching folks on working with PMs, and I think the frequent advice I gave non-technical folks probably holds true for engineers too when asking:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Always have your top 3 ranked work items ready to go when talking to decision makers (the PM?). Don‚Äôt bring new stuff unless it changes those top 3.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;(I mean sure, share context and adapt, but allow yourself no doubt that you‚Äôve‚Äô clearly and consistently communicated what your top priorities are before they get dumped in with everyone else‚Äôs.)&lt;/p&gt;

&lt;p&gt;(But also, if you‚Äôre an engineer and you can and no one is breathing down your neck, simply get it done and celebrate. The PM doesn‚Äôt have to lead everything. You can do it! üëç)&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/01/two-stories-about-technical-debt-i-guess&quot;&gt;Two stories about technical debt, I guess&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Thu, 18 Jan 2024 17:37:00 +0000</pubDate>
  <link>https://island94.org/2024/01/two-stories-about-technical-debt-i-guess</link>
  <guid isPermaLink="true">https://island94.org/2024/01/two-stories-about-technical-debt-i-guess</guid>
  
  
</item>

      
    
      
        




<item>
  <title>The answer is in your heap: debugging a big memory increase in Ruby on Rails</title>
  <description>&lt;p&gt;I recently participated in an &lt;a href=&quot;https://github.com/sciencehistory/scihist_digicoll/issues/2449&quot;&gt;interesting series of debugging sessions&lt;/a&gt; tracking down the source of a large increase in memory when upgrading a Rails application. We ultimately tracked down the cause using John Hawthorn‚Äôs &lt;a href=&quot;https://github.com/jhawthorn/sheap&quot;&gt;Sheap heap analyzer&lt;/a&gt; and successfully submitted a &lt;a href=&quot;https://github.com/rails/rails/pull/50298&quot;&gt;patch to Rails&lt;/a&gt;. I thought it was interesting enough to write up because maybe the general approach to debugging memory issues would be helpful (and this is the kind of stuff that I very quickly forget unless I write it down).&lt;/p&gt;

&lt;h3 id=&quot;how-it-started-reddit&quot;&gt;How it started: Reddit&lt;/h3&gt;

&lt;p&gt;Lots of people ask for help on r/rails, and it can be difficult to debug at a distance. &lt;a href=&quot;https://www.reddit.com/r/rails/comments/185b2wr/comment/kb1toyp/&quot;&gt;This time it was a little different&lt;/a&gt;. I recognized the username‚Äôs owner, &lt;a href=&quot;https://bibwild.wordpress.com&quot;&gt;Jonathan Rochkind&lt;/a&gt;, because he‚Äôs been a familiar and helpful face in GoodJob‚Äôs discussions and I‚Äôve sponsored his aggregator &lt;a href=&quot;https://rubyland.news/&quot;&gt;Rubyland News&lt;/a&gt;. The observed problem was that after upgrading from Rails 7.0 to Rails 7.1, their application‚Äôs memory footprint increased by about 25%. Weird!&lt;/p&gt;

&lt;h3 id=&quot;working-the-problem&quot;&gt;Working the problem&lt;/h3&gt;

&lt;p&gt;We worked through a bunch of questions:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Was the memory increase at startup or over time? Not at boot, but memory increased very quickly.&lt;/li&gt;
  &lt;li&gt;Did anything change with Puma configuration?  Nope.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Get set up with &lt;a href=&quot;https://github.com/zombocom/derailed_benchmarks&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;derailed_benchmarks&lt;/code&gt;&lt;/a&gt;, and create a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bin/profile&lt;/code&gt; Rails binstub to make it easy to boot into a production-like configuration for profiling. Here‚Äôs what my very polished one looks like:&lt;/p&gt;

    &lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;#!/usr/bin/env ruby&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This file is a wrapper around the rails and derailed executables&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# to make it easier to boot in PRODUCTION mode.&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Usage: bin/profile [rails|derailed] [command]&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;RAILS_ENV&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;RAILS_ENV&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;production&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;RACK_ENV&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;production&quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;RAILS_LOG_TO_STDOUT&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;RAILS_SERVE_STATIC_FILES&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;FORCE_SSL&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;false&quot;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;## ^^ Put ENV to boot in production mode here ^^&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;executable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ARGV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;shift&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;executable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rails&quot;&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;load&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dirname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;__FILE__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rails&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;executable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;derailed&quot;&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;bundler/setup&apos;&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;load&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Gem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;bin_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;derailed_benchmarks&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;derailed&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;puts&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ERROR: &apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;executable&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&apos; is not a valid command.&quot;&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;puts&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Usage: bin/profile [rails|derailed]&quot;&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We flailed around with Derailed Benchmarks, as well as John Hawthorn‚Äôs &lt;a href=&quot;https://github.com/jhawthorn/vernier?tab=readme-ov-file#retained-memory&quot;&gt;Vernier profiler‚Äôs memory mode&lt;/a&gt; (aside: John Hawthorn is doing amazing stuff with Ruby).&lt;/p&gt;

&lt;p&gt;At this point, we had a general understanding of the application memory footprint, which involved a large number of model instances (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Work&lt;/code&gt;), many of which contained a big blob of json. For some reason they were sticking around longer than a single web request, but we weren‚Äôt able to find any smoking guns of like, memoized class instance variables that were holding onto references. So we kept digging.&lt;/p&gt;

&lt;p&gt;You can read along to all of this here: https://github.com/sciencehistory/scihist_digicoll/issues/2449&lt;/p&gt;

&lt;h3 id=&quot;analyzing-memory-with-sheap&quot;&gt;Analyzing memory with Sheap&lt;/h3&gt;

&lt;p&gt;I used Derailed Benchmark‚Äôs &lt;a href=&quot;https://github.com/zombocom/derailed_benchmarks/blob/main/README.md#i-want-more-heap-dumps&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;perf:heap&lt;/code&gt;&lt;/a&gt; to generate heap dumps (also possible using &lt;a href=&quot;https://github.com/tmm1/rbtrace&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rbtrace --heapdump&lt;/code&gt;&lt;/a&gt;), and then plugged those into Sheap. Sheap is a relatively new tool, and where it shines is being &lt;em&gt;interactive&lt;/em&gt;. Instead of outputting a static report, Sheap allows for exploring a heap dump (or diff: to identify retained objects), and ask questions of the dump. In our case: &lt;em&gt;what objects are referencing this object and why is it being retained?&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# $ irb&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;./lib/sheap.rb

diff = Sheap::Diff.new(&quot;/Users/bensheldon/Repositories/sciencehistory/scihist_digicoll/tmp/2023-12-07T13:24:15-08:00-heap-1.ndjson&quot;, &quot;/Users/bensheldon/Repositories/sciencehistory/scihist_digicoll/tmp/2023-12-07T13:24:15-08:00-heap-2.ndjson&quot;)

# Find one of the Work records that&apos;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;been&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retained&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;model&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class_named&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Work&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;instances&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;OBJECT&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x117cf5c98&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Work&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Find the path to the (default) root&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ROOT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2984&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;IMEMO&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x126c9ab68&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;callcache&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;IMEMO&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x126c9acf8&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ment&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CLASS&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x12197c080&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;anonymous&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;OBJECT&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x122ddba08&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mh&quot;&gt;0x12197c080&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;OBJECT&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x117cfc458&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;WorksController&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;13&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;OBJECT&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x117cf7318&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;WorkImageShowComponent&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;OBJECT&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x117cf5c98&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Work&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# What is that initial callcache being referenced by the ROOT?&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x126c9ab68&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;data&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x126c9ab68&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;IMEMO&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;shape_id&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;slot_size&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;imemo_type&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;callcache&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;references&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x126c9acf8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/Users/bensheldon/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/actionpack-7.1.2/lib/action_dispatch/routing/routes_proxy.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;line&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;method&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;public_send&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;generation&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;288&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;memsize&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;flags&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;wb_protected&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;old&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;uncollectible&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;marked&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# And then a method entry&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;irb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;&lt;span class=&quot;mo&quot;&gt;015&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x126c9acf8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;data&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x126c9acf8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;IMEMO&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;shape_id&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;slot_size&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;imemo_type&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;ment&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;references&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x12197c080&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0x12197c080&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0x126c9ade8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0x126c9b4a0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;/Users/bensheldon/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/actionpack-7.1.2/lib/action_dispatch/routing/routes_proxy.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;line&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;method&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;method_missing&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;generation&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;288&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;memsize&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;flags&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;wb_protected&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;old&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;uncollectible&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;marked&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Aha, and a singleton for RoutesProxy!&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x12197c080&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;data&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;address&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x12197c080&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;CLASS&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;shape_id&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;slot_size&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;160&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;class&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x12211c308&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;variation_count&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;superclass&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x12211c3a8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;real_class_name&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;ActionDispatch::Routing::RoutesProxy&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;singleton&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;references&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;/Users/bensheldon/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/actionpack-7.1.2/lib/action_dispatch/routing/routes_proxy.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;line&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;method&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;method_missing&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;generation&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;288&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;memsize&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;656&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s2&quot;&gt;&quot;flags&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;wb_protected&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;old&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;uncollectible&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;marked&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# I expect the next object to be the RoutesProxy instance&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0x122ddba08&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;klass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;real_class_name&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ActionDispatch::Routing::RoutesProxy&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sheap is pretty great! In the above example, we were able to find a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Work&lt;/code&gt; model instance in the heap, and then using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;find_path&lt;/code&gt; identify what was referencing it all the way back to the heap‚Äôs root, which is what causes the object to be ‚Äúretained‚Äù; if there was no path to the root, the object would be garbage collected.&lt;/p&gt;

&lt;p&gt;(I have the huge benefit of having John as a colleague at GitHub and he helped me out &lt;em&gt;a lot&lt;/em&gt; with this. Thank you, John!)&lt;/p&gt;

&lt;p&gt;What we‚Äôre looking at is something in Rails‚Äô &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RoutesProxy&lt;/code&gt; holding onto a reference to that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Work&lt;/code&gt; object, via a callcache, a method entry (&lt;a href=&quot;https://tenderlovemaking.com/2018/01/23/reducing-memory-usage-in-ruby.html&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ment&lt;/code&gt;&lt;/a&gt;), a singleton class, a RouteSet, and then a Controller. What the heck?!&lt;/p&gt;

&lt;h3 id=&quot;the-explanation&quot;&gt;The explanation&lt;/h3&gt;

&lt;p&gt;Using Rails‚Äô git history, we were able to find that a &lt;a href=&quot;https://github.com/rails/rails/pull/46974&quot;&gt;change&lt;/a&gt; had been made to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RoutesProxy&lt;/code&gt; ‚Äôs behavior of dynamically creating a new method: a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;class_eval&lt;/code&gt;  had been changed to an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;instance_eval&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Calling &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;instance_eval &quot;def method....&quot;&lt;/code&gt; is what introduced a new singleton class, because that new method is only defined on that one object instance. Singleton classes can be cached by the Ruby VM (they‚Äôll be purged when the cache fills up), and that‚Äôs what, through that chain of objects, was causing the model instances to stick around longer than expected and bloat up the memory! It‚Äôs not that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;instance_eval&lt;/code&gt;ing new methods is itself inherently problematic, but when those singleton methods are defined on an object that references an instance of an Action Controller, which has many instance variables that contained big Active Record objects‚Ä¶. that‚Äôs a problem.&lt;/p&gt;

&lt;p&gt;(Big props, again, to John Hawthorn who connected these dots.)&lt;/p&gt;

&lt;p&gt;Having tracked down the problem, we submitted a &lt;a href=&quot;https://github.com/rails/rails/pull/50298&quot;&gt;patch to Rails&lt;/a&gt; to change the behavior and remove the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;instance_eval&lt;/code&gt; -defined methods. It‚Äôs been accepted and &lt;del&gt;it should be released in the next Rails patch (probably v7.1.3); the project temporarily &lt;a href=&quot;https://github.com/sciencehistory/scihist_digicoll/pull/2466&quot;&gt;monkey-patched in that change&lt;/a&gt; too&lt;/del&gt; has been released &lt;a href=&quot;https://github.com/rails/rails/blob/36c1591bcb5e0ee3084759c7f42a706fe5bb7ca7/actionpack/lib/action_dispatch/routing/routes_proxy.rb#L30-L47&quot;&gt;as part of Rails 7.1.3&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;I realize that‚Äôs all a big technical mouthful, but the takeaway should be: &lt;a href=&quot;https://github.com/jhawthorn/sheap&quot;&gt;Sheap&lt;/a&gt; is a really great tool, and exploring your Ruby heap can be very satisfying.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Update:&lt;/strong&gt; Jean Boussier pointed me to the fix in Ruby 3.3 for &lt;a href=&quot;https://bugs.ruby-lang.org/issues/19436&quot;&gt;call Cache for singleton methods can lead to ‚Äúmemory leaks‚Äù&lt;/a&gt; üéâ And suggested looking at &lt;a href=&quot;https://github.com/csfrancis/harb&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;harb&lt;/code&gt;&lt;/a&gt; too as a Sheap-like.&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/01/the-answer-is-in-your-heap-debugging-big-rails-memory&quot;&gt;The answer is in your heap: debugging a big memory increase in Ruby on Rails&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Tue, 16 Jan 2024 22:41:00 +0000</pubDate>
  <link>https://island94.org/2024/01/the-answer-is-in-your-heap-debugging-big-rails-memory</link>
  <guid isPermaLink="true">https://island94.org/2024/01/the-answer-is-in-your-heap-debugging-big-rails-memory</guid>
  
    <category>ruby</category>
  
    <category>rails</category>
  
  
</item>

      
    
      
        




<item>
  <title>Trigger GitHub Actions workflows with inputs from Apple Shortcuts</title>
  <description>&lt;p&gt;I‚Äôve been using Apple Shortcuts to invoke GitHub Actions workflows to create webpage bookmarks. It‚Äôs been great! (disclosure: I do work at GitHub)&lt;/p&gt;

&lt;p&gt;My use case: I‚Äôve been wanting to quit Pinboard.in, so I needed an alternative way to create and host my web bookmarks, some of which date back to ~2005 del.icio.us vintage. It‚Äôs been easy enough for me to export of all my bookmarks (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;settings -&amp;gt; backup -&amp;gt; JSON&lt;/code&gt;) and &lt;a href=&quot;https://github.com/bensheldon/bookmarks/blob/bc85a68ea61844ad0b11b823bef355a1879b0462/script/import_pinboard.rb#L7-L20&quot;&gt;convert them to YAML files&lt;/a&gt; to be served by Jekyll and GitHub Pages. But I also needed an easy way to create new bookmarks that would work on all my Apple devices. I ended up with:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Bookmarks are organized as individual yaml files, in this &lt;a href=&quot;https://github.com/bensheldon/island94-jekyll/tree/a524b8fce50bb315d1a1f1e9c27e572a7af31ccc/_bookmarks&quot;&gt;blog‚Äôs repository&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;A &lt;a href=&quot;https://github.com/bensheldon/island94-jekyll/blob/a524b8fce50bb315d1a1f1e9c27e572a7af31ccc/scripts/bookmark.rb&quot;&gt;Ruby script&lt;/a&gt; to take some simple inputs (url, title, notes), generate a new yaml file, and commit it to the repo using Octokit.&lt;/li&gt;
  &lt;li&gt;A GitHub Actions &lt;a href=&quot;https://github.com/bensheldon/island94-jekyll/blob/a524b8fce50bb315d1a1f1e9c27e572a7af31ccc/.github/workflows/bookmark.yml#L3-L20&quot;&gt;workflow that accepts those same inputs&lt;/a&gt;  and can be manually triggered, that runs the script. One thing to note is that I echo the inputs to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$GITHUB_STEP_SUMMARY&lt;/code&gt; early in the workflow in case a later step errors, so I won‚Äôt lose the bookmark details and can go back later and manually fix it up.&lt;/li&gt;
  &lt;li&gt;An Apple Shortcut that asks for those inputs (either implicitly via the Share Sheet or via text inputs) and then manually triggers the GitHub Actions workflow via the GitHub API.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The only difficult part for me was getting Apple Shortcuts to work nicely with the GitHub REST API. Here‚Äôs what worked for me:&lt;/p&gt;

&lt;p&gt;Use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Get Contents of URL&lt;/code&gt; Action:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;URL: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://api.github.com/repos/USER/REPOSITORY/actions/workflows/WORKFLOW.yml/dispatches&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Method: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;POST&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Headers:
    &lt;ul&gt;
      &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Accept: application/vnd.github.v3+jsonp&lt;/code&gt;&lt;/li&gt;
      &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Authorization: Bearer GITHUB_ACCESS_TOKEN&lt;/code&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Request Body: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;JSON&lt;/code&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ref: main&lt;/code&gt; (or whatever branch you‚Äôre using)&lt;/li&gt;
      &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;inputs (Dictionary):&lt;/code&gt;
        &lt;ul&gt;
          &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;INPUT: VALUE&lt;/code&gt;&lt;/li&gt;
          &lt;li&gt;‚Ä¶ and your other GitHub Actions workflow inputs&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here‚Äôs what it looks like all together (btw, &lt;a href=&quot;https://www.reddit.com/r/shortcuts/comments/zlhva2/dictionaries_broken_in_162/&quot;&gt;Dictionary-type inputs were broken in iOS 16 / Mac 13&lt;/a&gt; üò®) :&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/uploads/2024-01/apple-shortcut.png&quot;&gt;&lt;img src=&quot;/uploads/2024-01/apple-shortcut.png&quot; alt=&quot;Screenshot of Apple Shortcut with the previous configuration&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/01/trigger-github-actions-workflows-from-apple-shortcuts&quot;&gt;Trigger GitHub Actions workflows with inputs from Apple Shortcuts&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Mon, 08 Jan 2024 23:18:00 +0000</pubDate>
  <link>https://island94.org/2024/01/trigger-github-actions-workflows-from-apple-shortcuts</link>
  <guid isPermaLink="true">https://island94.org/2024/01/trigger-github-actions-workflows-from-apple-shortcuts</guid>
  
  
</item>

      
    
      
        




<item>
  <title>Recently, January 3, 2023</title>
  <description>&lt;ul&gt;
  &lt;li&gt;I‚Äôve now watched the Taylor Swift Eras movie twice, once at home, and a second time over the holidays with niece (completely) and nephew (partly). My most burning question is whether Taylor menaces the same dancer every show‚Äôs ‚ÄúTolerate it‚Äù, or if they share rhetorical pain. My &lt;a href=&quot;https://joe-steel.com/2023-11-28-Apple-Music-Replays-Broken-Record.html&quot;&gt;Apple Music Replay&lt;/a&gt; also ranked highly with Taylor Swift, though also apparently Andrew McMahon; unexpected.&lt;/li&gt;
  &lt;li&gt;I started playing Talos Principle 1 after beating 2, though it‚Äôs a lot more intense with guns and exploding things and so many timing-based puzzles. I‚Äôve almost beaten it‚Ä¶ but also took a break to play Super Mario Wonder which is much more fun fun (especially, again, with niece and nephew).&lt;/li&gt;
  &lt;li&gt;I finished reading ‚ÄúBabel‚Äù, started then stopped reading ‚ÄúWolf Hall‚Äù, and am picking my way through ‚ÄúLess‚Äù. There‚Äôs several nonfiction books in there that I‚Äôve read about chapter of, but nothing so memorable to note here. Prior to that I read ‚ÄúTranslation State‚Äù, and realizing I didn‚Äôt remember half of what was happening, re-read the previous 4 Imperial Radch books, which only now makes me think I should read-read Translation State again for the clean sweep. And I guess I finished the latest Bruno book,  ‚ÄúA Chateau Under Siege‚Äù, and it was fine (there‚Äôs only so many times one can describe Kir Royale, and I think we‚Äôre past it).&lt;/li&gt;
  &lt;li&gt;I believe the Crumpler Soupansalad Son-o is the perfect jacket-and-book-and-water-bottle-and-also-half-gallon-of-milk-and-greek-yogurt bag. It also hasn‚Äôt been made in like 15 years so I bought another one on eBay (I attempted to do this via Poshmark 6 months ago but it failed to deliver). Now I own two: my longtime bag in brown, the new one in black.&lt;/li&gt;
  &lt;li&gt;After 7 years of service, I‚Äôve stepped down from my church‚Äôs Property Committee. The buildings are being sold. As Boenhoeffer wrote, albeit about Germany‚Äôs embrace of fascism and not a congregational vote on the role of real-estate within a small church‚Äôs modest investment portfolio: ‚ÄúIf you board the wrong train, it is no use running along the corridor in the other direction.‚Äù  I‚Äôm currently serving on zero committees anywhere; a special moment.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Reflecting on my past year at GitHub, I‚Äôll just &lt;a href=&quot;https://rachelandrew.co.uk/archives/2024/01/01/2023-in-review/&quot;&gt;directly quote Rachel Andrew‚Äôs blog&lt;/a&gt;; search and replace as necessary:&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;The layoffs at Google at the beginning of 2023, didn‚Äôt impact me or my writing team directly, however they cast a shadow over the year. I try to look at difficult situations through a lens of what I can actually do to change things or improve the situation. At my level of management I‚Äôm not privy to layoff decisions, but I can be there to support my team and make space to talk about their concerns. I can strive to make sure our work and the impact of it is visible, and I can make sensible business decisions to make the most of resources in a more constrained environment. And so, after the initial shock of it all, that‚Äôs how I‚Äôve approached this year.&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;I‚Äôm slowly trending towards GoodJob v4.0. It‚Äôs looking like it will be a noop: a chance for me to clean up all of the migrations and deprecation warnings and probably stop support for Ruby &amp;lt; 3.0, but nothing noticeable otherwise. I want to have everything ready for anyone to opt into &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FOR UPDATE SKIP LOCK&lt;/code&gt; from Advisory Locks, but as a &lt;em&gt;feature&lt;/em&gt; that won‚Äôt be part of four-point-zero. We‚Äôve managed to get to 3.22 (that‚Äôs 22 minor releases!) without a breaking change.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I‚Äôm not big on setting yearly goals, but I liked this &lt;a href=&quot;https://www.askamanager.org/2024/01/coworker-made-it-obvious-she-didnt-want-the-gifts-i-gave-her-employees-husband-hangs-around-and-more.html&quot;&gt;evergreen advice from Ask a Manager&lt;/a&gt;, so I‚Äôm gonna continue aspiring to that:&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;ideally you‚Äôd try to see it as a funny story you can tell friends rather than a hurtful snub that needs to bother you&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
&lt;/ul&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/01/recently&quot;&gt;Recently, January 3, 2023&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Thu, 04 Jan 2024 02:40:00 +0000</pubDate>
  <link>https://island94.org/2024/01/recently</link>
  <guid isPermaLink="true">https://island94.org/2024/01/recently</guid>
  
    <category>weeknotes</category>
  
  
</item>

      
    
      
        




<item>
  <title>Solid Queue first impressions: Nice!</title>
  <description>&lt;p&gt;&lt;a href=&quot;https://github.com/basecamp/solid_queue&quot;&gt;Solid Queue&lt;/a&gt; was &lt;a href=&quot;https://dev.37signals.com/introducing-solid-queue/&quot;&gt;released yesterday&lt;/a&gt;, a new relational-database backend for Active Job.&lt;/p&gt;

&lt;p&gt;I‚Äôm the author of &lt;a href=&quot;https://github.com/bensheldon/good_job&quot;&gt;GoodJob&lt;/a&gt; and I‚Äôve been &lt;a href=&quot;https://island94.org/2023/10/reflections-on-good-job-for-solid-queue&quot;&gt;following along&lt;/a&gt; and am very interested and excited about Solid Queue. These are some things I noticed when first going through it.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;tl;dr;&lt;/strong&gt; It‚Äôs nice! I learned some things. It makes a few different choices than GoodJob and I‚Äôm very curious how they turn out (in a good way!).&lt;/p&gt;

&lt;p&gt;I admit, I didn‚Äôt run Solid Queue in production. I poked through the code, got the development environment set up (spent the majority of my time trying to get &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mysql2&lt;/code&gt; to compile, which is no surprise for me; &lt;a href=&quot;https://github.blog/2022-08-25-introducing-trilogy-a-new-database-adapter-for-ruby-on-rails/&quot;&gt;Trilogy is my day job&lt;/a&gt;), ran the test suite and tried TDDing a new feature for it: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;perform_all_later&lt;/code&gt; support. These are just my notes, something to refer back to.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Lots of database tables:&lt;/strong&gt; Solid Queue has many database tables. There is a ‚Äúhot‚Äù table (my terminology) in which job records are queued/dequeued/locked from by all the workers, and then several other tables where job records are staged (e.g. they‚Äôre scheduled in the future, so don‚Äôt insert them into the hot table yet) or archived after they complete/error.  This seems smart because that hot table and its indexes stays compact and single purpose, which is good for performance. Compare that to GoodJob in which the jobs table has like 8 indexes to cover both queue/dequeue and Dashboard listings and everything else, which &lt;em&gt;does&lt;/em&gt; slow down inserts and updates. I‚Äôve had the impression with GoodJob that orchestrating across multiple tables would be more difficult (everything is tradeoffs!), so I‚Äôm very curious to see an alternative implementation in Solid Queue.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note: I wasn‚Äôt successfully able to implement &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;perform_all_later&lt;/code&gt; in my 1 hour timebox because it was more complicated than an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;insert_all&lt;/code&gt; because of the necessity of writing to multiple tables.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Aside: One of the very first comments I got when I launched GoodJob 3 years ago was like ‚Äúyour design assumptions are less than ideal‚Äù and then they never replied to any of my follow-ups. That sucked! This is not that. Nothing in Solid Queue is particularly concerning, just different (sometimes better!). Kudos to Rosa Guti√©rrez and the Solid Queue developers; you‚Äôre doing great work! üíñ&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Again, lots of database tables:&lt;/strong&gt; GoodJob is easy mode just targeting Postgres, because there are Advisory Locks and lots of Postgres-only niceties. I do not envy Solid Queue being multi-database, because it has to implement a bunch of stuff with a coarser toolbox. For example, there is a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;semaphores&lt;/code&gt; table, which is used for the Concurrency Controls feature (üéâ). I think the ‚ÄúSOLID‚Äù libraries (also Solid Cache) are interesting because they have to implement behavior in a relational database that come for free in in-memory databases (example: TTL/record expiration/purging).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Puma Plugin:&lt;/strong&gt; TIL. Looks nicer and more explicit than GoodJob trying to transparently detect it‚Äôs in the webserver to run asynchronously&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Multiprocess.&lt;/strong&gt; A nice surprise to me, Solid Queue has a multiprocess supervisor. It does seem like even the Puma plugin forks off another process though; that could have implications for memory constrained environments (e.g. Heroku dynos). I‚Äôm nearly 4 years into GoodJob and haven‚Äôt tackled multiprocess yet, so exciting to see this in Solid Queue‚Äôs first release.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Queue priority:&lt;/strong&gt; Nice! I have &lt;em&gt;opinions&lt;/em&gt; about how people set up their application‚Äôs queues, along the lines of: many people do it wrong, imo. Solid Queue looks like it provides a lot of good flexibility to let people easily migrate and configure their queues initially (though wrongly, by dependency, imo), but then reorient them more performantly (by latency, again imo). A single thread-pool/worker can pull from multiple queues.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Care&lt;/strong&gt;. I notice lots of little things that are nice in Solid Queue. The code is clean. The indexes are named for their purpose/usage rather than just like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index_table_column_column&lt;/code&gt;.  The Puma Plugin is nice. There are things in GoodJob that I dream about what a clean-room, lessons-learned reimplementation would look like, but it‚Äôs never top of my priorities, and some things are never going back in the stable (table names are basically forever). Reading the Solid Queue code was a vicarious-nice! experience.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Differences.&lt;/strong&gt; Do they even matter? I dunno:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;No Dashboard yet. Waiting on Mission Control. GoodJob definitely got more twisty as I learned all of the things of ‚Äúyou want a button to do what now with those jobs? ‚Ä¶oh, I guess that makes sense. hmm.‚Äù&lt;/li&gt;
  &lt;li&gt;No LISTEN/NOTIFY (yet?). Seems possible, but would be Postgres only so maybe not. That means latency will never be less than the polling frequency, though an example shows &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0.1&lt;/code&gt; seconds which seems good to me.&lt;/li&gt;
  &lt;li&gt;&lt;del&gt;No cron-like functionality. It took me a minute to &lt;a href=&quot;https://github.com/bensheldon/good_job/issues/255&quot;&gt;come around to the the necessity of this&lt;/a&gt;, maybe Solid Queue will too.&lt;/del&gt; ü§¶ I missed this on first read through: ‚ÄúUnique jobs and recurring, cron-like tasks are coming very soon.‚Äù üôå&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Final thoughts:&lt;/strong&gt; Path dependency is hard, so I don‚Äôt imagine lots of people should swap out their job backend just because there is something new (please, don‚Äôt let me ever read a ‚Äú3 job backends in 4 years‚Äù blog post). New projects and applications will be more likely making these choices (and they shouldn‚Äôt be valueless choices, hence my excitement for Solid Queue becoming first party to Rails) and I‚Äôm really excited to see how Solid Queue grows up with them, and alongside other options like GoodJob and Sidekiq and Delayed et al.&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2023/12/solid-queue-first-impressions&quot;&gt;Solid Queue first impressions: Nice!&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Tue, 19 Dec 2023 16:24:00 +0000</pubDate>
  <link>https://island94.org/2023/12/solid-queue-first-impressions</link>
  <guid isPermaLink="true">https://island94.org/2023/12/solid-queue-first-impressions</guid>
  
    <category>Rails</category>
  
    <category>GoodJob</category>
  
  
</item>

      
    
      
        




<item>
  <title>Recently</title>
  <description>&lt;ul&gt;
  &lt;li&gt;One of my coworkers said this week ‚ÄúYou‚Äôve been an engineering director and in leadership before, right? I appreciate your perspective; any advice and resources you‚Äôd recommend?‚Äù So that set my mind racing. I dunno. On one hand, it‚Äôs like, well, first, you grind out 10 years of 1-year of experience 10 times, but do it &lt;a href=&quot;https://transmissionproject.org/projects.html&quot;&gt;50 times a year&lt;/a&gt;.  On the other, &lt;a href=&quot;https://medium.com/@livlab/dont-work-with-psychopaths-b1a848914455&quot;&gt;keep a delta file&lt;/a&gt; and I also think about &lt;a href=&quot;https://www.goodreads.com/en/book/show/566213&quot;&gt;Secrets of Consulting&lt;/a&gt; quite a lot (content warning: I haven‚Äôt re-read it in a long time; I tried reading the same author‚Äôs &lt;em&gt;The Psychology of Computer Programming&lt;/em&gt; more recently and couldn‚Äôt do it).&lt;/li&gt;
  &lt;li&gt;Work otherwise is in the final marathon of promo packets and performance reviews and quarterly planning and a reorg and oh, the next version of Ruby is released in 3 weeks and it‚Äôs go time. Then we do it all again. I love my team so much.&lt;/li&gt;
  &lt;li&gt;I finished reading &lt;a href=&quot;https://www.goodreads.com/series/305076-the-final-architecture&quot;&gt;The Final Architecture&lt;/a&gt; series. I didn‚Äôt enjoy it as much as Children of Time (‚Äúthe octopus books‚Äù). After reading all the Gateway books and 3-body problem books, I‚Äôm a bit over the idea that there‚Äôs a malicious (or at least self-interested) group of people who are unhappy with the current value of the Planck constant &lt;em&gt;and are doing something about it&lt;/em&gt;. I was into the subplot of alien criminality.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I finished Talos Principle 2, but I screwed up the golden gates thing, so I have to beat it again just to get the special special ending. I‚Äôve been playing it in parallel with a friend and appreciate our back and forth:&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;Me: I‚Äôm personally more worried about environmental catastrophe than AI, but i guess they‚Äôre intertwined. Material conditions that are unfit for life. Like some of the talos robots seem to touch on my philosophical question which is like: how do we maximize individual agency+satisfaction while also avoiding collective/systemic fucking-around-and-finding-out.&lt;/p&gt;

      &lt;p&gt;Friend: we can see from the game the answer lies somewhere on the spectrum between having 1000 robits around a crumbling power source vs having a magic 3D printing pyramid for use to conquer the stars&lt;/p&gt;
    &lt;/blockquote&gt;

    &lt;p&gt;I also started playing Talos 1 and it‚Äôs much less chill than the 2nd game. I may not finish it.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;For GoodJob, all of the things I want have been labeled &lt;a href=&quot;https://github.com/bensheldon/good_job/issues?q=is%3Aissue+is%3Aopen+label%3A%22help+wanted%22&quot;&gt;‚ÄúHelp Wanted‚Äù&lt;/a&gt;. I do want to get the row-locking foundations in place myself, though I think the safe upgrade path for it might take a little while to straighten out. I think I have finally &lt;a href=&quot;https://github.com/bensheldon/good_job/discussions/831#discussioncomment-7283545&quot;&gt;mastered advisory locks&lt;/a&gt;, so, of course, that means change it all up.&lt;/li&gt;
  &lt;li&gt;I ran &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bundle update&lt;/code&gt; on Day of the Shirt, which means I also upgraded to Shakapacker, which means that I have, once again, spent an entire weekend fumbling with Webpack configuration to get &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;window.$&lt;/code&gt; working. I also got a nice email from the owner of a t-shirt website that validated my &lt;a href=&quot;https://dayoftheshirt.com/news/state-of-the-shirt-2020&quot;&gt;thesis&lt;/a&gt; that no one visits websites anymore, let alone to buy t-shirts: the website owner got a (different) full-time job.&lt;/li&gt;
&lt;/ul&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2023/12/recently&quot;&gt;Recently&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Sun, 10 Dec 2023 15:44:00 +0000</pubDate>
  <link>https://island94.org/2023/12/recently</link>
  <guid isPermaLink="true">https://island94.org/2023/12/recently</guid>
  
    <category>recently</category>
  
    <category>weeknotes</category>
  
  
</item>

      
    
      
        




<item>
  <title>The Rails Executor: increasingly everywhere</title>
  <description>&lt;p&gt;&lt;em&gt;The Rails Executor rules everything around &lt;del&gt;you&lt;/del&gt; your code.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;If you write multithreaded-Rails code‚Äîlike me, author of &lt;a href=&quot;https://github.com/bensheldon/good_job&quot;&gt;GoodJob&lt;/a&gt;‚Äîyou‚Äôre probably familiar with the Rails Executor which is described in the &lt;a href=&quot;https://guides.rubyonrails.org/v7.1/threading_and_code_execution.html&quot;&gt;Rails Multithreading Guide&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If you‚Äôre new to the Rails Executor: it sets up and tears down a lot of Rails‚Äô framework magic. Code wrapped with a Rails Executor or its sibling, the Reloader, pick up a lot of powerful behavior:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Constant autoloading and reloading&lt;/li&gt;
  &lt;li&gt;Database connection/connection-pool management and query retries&lt;/li&gt;
  &lt;li&gt;Query Cache&lt;/li&gt;
  &lt;li&gt;Query Logging&lt;/li&gt;
  &lt;li&gt;CurrentAttributes&lt;/li&gt;
  &lt;li&gt;Error reporting&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You usually won‚Äôt think about it. The Rails framework already wraps every Controller Action and Active Job with an Executor. Recently, as of Rails v7.1, it‚Äôs showing up everywhere within the Rails codebase:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rails/rails/pull/44999&quot;&gt;Rails runner scripts are now wrapped with an Executor&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rails/rails/pull/43550&quot;&gt;Minitest test cases are now wrapped with an Executor&lt;/a&gt; (I‚Äôm working on getting &lt;a href=&quot;https://github.com/rspec/rspec-rails/issues/2713&quot;&gt;parity in rspec-rails&lt;/a&gt;). It has a nice little explanation why ‚ÄúThis helps to better simulate request or job local state being reset around tests and prevent state to leak from one test to another.‚Äù&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The effect of these small changes could be surprising:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;I came to write this blog post because I saw a Rails Discussion asking how &lt;a href=&quot;https://discuss.rubyonrails.org/t/rails-7-1-uses-query-cache-for-runner-scripts/84275&quot;&gt;‚ÄúRails 7.1 uses query cache for runner scripts‚Äù&lt;/a&gt; and aha, I knew the answer: the Executor.&lt;/li&gt;
  &lt;li&gt;I recently &lt;a href=&quot;https://github.com/bensheldon/good_job/pull/1124&quot;&gt;fixed a bunch of flaky GoodJob unit tests&lt;/a&gt; by wrapping each RSpec example in a Rails Executor. This is a problem specific to GoodJob, which uses connection-based Advisory Locks, but I discovered that if an Executor context was passed through (for example, executing an Active Job inline), the current database connection would be returned to the pool, sometimes breaking the Advisory Locks when a different connection was checked back out to continue the test. This was only a fluke of the tests, but was a longtime annoyance. I‚Äôve previously had to &lt;a href=&quot;https://github.com/bensheldon/good_job/blob/c6d3aa4906783498ed6296060666d350ac2e288c/lib/good_job/current_thread.rb#L6-L7&quot;&gt;work around a similar reset of CurrentAttributes&lt;/a&gt; that occurs too.&lt;/li&gt;
  &lt;li&gt;At my day job, GitHub, we‚Äôve also been double-checking that all of our Rails-invoking scripts and daemons are wrapped with Rails Executors. Doing so has fixed flukey constant lookups, reduced our database connection error rate and increased successful query retries, and necessitated updating a bunch of tests that counted queries that now hit the query cache.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The Rails Executor is great! Your code is probably already wrapped by the Rails framework, but anytime you start writing scripts or daemons that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;require_relative &quot;./config/environment.rb&quot;&lt;/code&gt; you should double-check, and &lt;em&gt;definitely&lt;/em&gt; if you‚Äôre using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Thread.new&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Concurrent::Future&lt;/code&gt; or anything that runs in a background thread.&lt;/p&gt;

&lt;p&gt;I used the following code in GoodJob to debug that database connection checkout occurs in a Rails Executor, maybe you could adopt something similar too:&lt;/p&gt;

&lt;div class=&quot;language-rb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# config/initializers/debug_executors.rb&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;on_load&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:active_record&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ConnectionAdapters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;AbstractAdapter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;set_callback&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:checkout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:before&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;lambda&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;unless&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Executor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;active?&lt;/span&gt;
      &lt;span class=&quot;vg&quot;&gt;$stdout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;puts&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;WARNING: Connection pool checkout occurred outside of a Rails Executor&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One last thing about Executors, you want to make sure that you‚Äôre &lt;a href=&quot;https://guides.rubyonrails.org/v7.1/threading_and_code_execution.html#wrapping-application-code&quot;&gt;wrapping individual units of work&lt;/a&gt;, so the execution context has a chance to reset itself (check-in database connections, unload and reload code, etc.):&lt;/p&gt;

&lt;div class=&quot;language-rb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# scripts/do_all_the_things.rb&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# bad&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;executor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;wrap&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kp&quot;&gt;loop&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyModel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;do_something&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# good&lt;/span&gt;
&lt;span class=&quot;kp&quot;&gt;loop&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;executor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;wrap&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyModel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;do_something&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Update:&lt;/strong&gt; I offered a &lt;a href=&quot;https://github.com/rails/rails/pull/50223&quot;&gt;Rails PR to make the script runner‚Äôs Executor conditional&lt;/a&gt; because the introduction of an Executor around &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bin/rails runner script.rb&lt;/code&gt; could introduce problems if the script is long-running/looping/daemon-like; developers would still need to use an Executor, but to wrap individual units of work in their longrunning script.&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2023/11/rails-executor-increasingly-everywhere&quot;&gt;The Rails Executor: increasingly everywhere&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Thu, 30 Nov 2023 05:37:00 +0000</pubDate>
  <link>https://island94.org/2023/11/rails-executor-increasingly-everywhere</link>
  <guid isPermaLink="true">https://island94.org/2023/11/rails-executor-increasingly-everywhere</guid>
  
    <category>Rails</category>
  
    <category>Ruby</category>
  
  
</item>

      
    
      
        




<item>
  <title>Reflections on GoodJob for Solid Queue</title>
  <description>&lt;p&gt;&lt;a href=&quot;/uploads/2023-10/rails_world_solid_queue.jpg&quot;&gt;&lt;img src=&quot;/uploads/2023-10/rails_world_solid_queue.jpg&quot; alt=&quot;Rails World presents Solid Queue and Mission Control&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;GoodJob, via its &lt;a href=&quot;https://island94.org/2020/07/introducing-goodjob-1-0&quot;&gt;introductory blog post&lt;/a&gt;, was highlighted last week at Rails World. A new Active Job queue backend, &lt;a href=&quot;https://rubygems.org/gems/solid_queue&quot;&gt;Solid Queue&lt;/a&gt;, was announced, and I‚Äôm excited to see where it goes!&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I attended Rails World in Amsterdam this past week. During the conference, a new Active Job backend was announced: Solid Queue (&lt;a href=&quot;https://www.youtube.com/watch?v=iqXjGiQ_D-A&amp;amp;t=3121s&quot;&gt;video&lt;/a&gt;), which has the potential to become first, first-party backend in Rails. Solid Queue, like my GoodJob, is backed by a relational database. I‚Äôm very excited about this! I had a chance to talk to Rosa Gutierrez, who is leading the effort at 37signals, and I‚Äôm hopeful that I‚Äôll be able to contribute to Solid Queue and who knows, maybe it could even become a successor to GoodJob.&lt;/p&gt;

&lt;p&gt;With that thought in mind, I reflected on some of the design and motivations that became GoodJob, and that I believe are important regardless of the Active Job backend under development. These are not intended to be design documents but more a list of things that I have learned or come across during my 3 years working on GoodJob. It would be nice to keep these in mind when designing a potential successor to GoodJob. And I hope they can be the seed to further conversations, rather than a fully realized proposal or argument. Let‚Äôs go:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;SIGKILL Safety&lt;/strong&gt;. Recovering from a SIGKILL (or someone unplugging the power cord) is always number one in my mind when thinking of GoodJob. That informed my desire to use Advisory Locks (which are automatically released on disconnect), and my future thinking about heartbeats if GoodJob switched over to using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FOR UPDATE SKIP LOCK&lt;/code&gt; instead of Advisory Locks. I do not think jobs should be limited to a specific timeout (as Delayed Job‚Äôs design uses) as that also creates significant retry latency when resumed, and jobs definitely shouldn‚Äôt be wrapped with a transaction either.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;(Human) Exception and Retry Workflows&lt;/strong&gt;. Everybody has a different workflow for how they deal with errors, and I believe that a backend needs to track, report (e.g. send to Sentry or Bugsnag) and expose the various reasons an error appears: retried, retry stopped, explicitly discarded, SIGKILLed/interrupted, unhandled error, etc. I still am dialing this in on GoodJob because there is wide variability of how people and teams manage their error workflows. I‚Äôm always learning something new. For example, there are very different answers on ‚Äúwhen using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;retry_on SpecialError, attempts: 3&lt;/code&gt; should the 4th error be reported to the exception tracker? What about an explicit &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;discard_on&lt;/code&gt;? Should a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;discard_on&lt;/code&gt; error be reviewed and reenqueued or not?‚Äù If a job is SIGKILLed/interrupted, should it be automatically restarted or held for manual review? Everyone seems to do it differently! I haven‚Äôt cracked the code on what is ‚Äúideal‚Äù or reasonable to say ‚Äúnope, don‚Äôt do it &lt;em&gt;that&lt;/em&gt; way.‚Äù Active Job‚Äôs error handling isn‚Äôt clear cut either, so maybe we can make that better and come around to a more opinionated (but still inclusive) design. Maybe!&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Process Harnesses&lt;/strong&gt;. I think it‚Äôs interesting that Rails might ship with a 1st party queue backend before it ships with a 1st party webserver: there is a lot of operational overlap. Signal handling, timeouts, daemonization, liveness and healthcheck probes, monitoring and scaling instrumentation. There‚Äôs quite a lot of ground to cover, and a lot different systems and tooling: Kubernetes,  systemd, rc.d, Heroku, Judoscale, to name just a few of the various operational targets that I‚Äôve spent considerable time supporting.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Repeating Jobs / Clock Process&lt;/strong&gt;. It took me &lt;a href=&quot;https://github.com/bensheldon/good_job/issues/255&quot;&gt;a while to come around to this&lt;/a&gt; in GoodJob, but I believe that performing work &lt;em&gt;repetitively on a schedule&lt;/em&gt; (‚Äúcron-like‚Äù) is very much in the same problem-domain as background jobs. There‚Äôs lots of different ways to design it that I don‚Äôt feel strongly about, for example GoodJob minimizes autoloading by keeping schedules separate from job classes, but I do think it is necessary to plan for scheduled jobs in a well-architected Rails application.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Unique Jobs, Throttles, Fuses and other Concurrency Controls&lt;/strong&gt;,. Similarly to Repeating Jobs, demand is high for everything I‚Äôd bucket under ‚Äúconcurrency controls‚Äù, which I‚Äôll say covers both enqueue and dequeue complexity. And these features are tough because they sit in counterbalance to overall performance: do you want to run jobs faster or smarter? And these are the features that I think are legit because there are other features below under Queue Design that I think are bunk. There‚Äôs a lot of discernment to do!&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Queue design and multi-queue execution pools&lt;/strong&gt;. I do think queue design is a place where lots of people do it wrong. I believe queues should be organized by maximum total latency SLO (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;latency_15s&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;latency_15m&lt;/code&gt; , &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;latency_8h&lt;/code&gt;) and &lt;em&gt;not&lt;/em&gt; by their purpose or dependencies  (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mailers&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;billing&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;api&lt;/code&gt;). &lt;a href=&quot;https://www.railsspeed.com/&quot;&gt;Nate Berkopec believes similarly.&lt;/a&gt; And I think that informs that &lt;strong&gt;execution pools (e.g. thread pools) should be able to work from multiple queues and have independent concurrency configuration (e.g. number of threads)&lt;/strong&gt;, both to ease transition from the latter to the former, but also because it allows sharing resources as optimally as possible (having 3 separate pools that pull from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;latency_15s&quot;&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;latency_15m, latency_15s&quot;&lt;/code&gt;, and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;latency_8h,*&quot;&lt;/code&gt; in GoodJob‚Äôs syntax). I personally think concepts like priority or ordered-queues lead to bad queue design, so I wouldn‚Äôt sweat that. Any ordering regime more complex than first-in-first-out (FIFO) prioritizes capacity (or lack thereof) over latency. This might sound strange coming from me who champions running workloads in the webbrowser on tiny dynos, but it‚Äôs different in my mind: I don‚Äôt think it‚Äôs possible to meet a latency target through prioritization when there is a fundamental lack of capacity.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Labels&lt;/strong&gt;. Per the previous point, though I have yet to implement this in GoodJob (soon!), I think that giving developers the option to label their jobs might break their bad habit of using queue names as functional labels, instead of what I believe queues should be appropriately used for: latency and quality-of-service thresholds. I mention it here just in case that informs Solid Queue‚Äôs design.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Observability&lt;/strong&gt;. GoodJob maintains a lot of bookkeeping, keeping job and granular execution data around after execution so it can be inspected. People seem to like that, and it‚Äôs necessary to keep them around for calculating accurate latency metrics, though it all is a trade-off against performance. It makes for a fun Web Dashboard too.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Performance Envelope.&lt;/strong&gt; I dunno, I mention this just because I think people spend an inordinate amount of time comparing queue backend performance and asking ‚Äúdo the jobs go brrrrr?‚Äù GoodJob targets the small and medium end of projects (though some big ones use it too) and prioritizes operational simplicity over performance. That works for me (and a lot of others!) but also isn‚Äôt really reflective of the scale of companies leading Rails development. There‚Äôs a tension here.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Making better mistakes tomorrow&lt;/strong&gt;. I‚Äôm really proud of having a reputation for being helpful and responsive and curious in the GoodJob issue queue and discussions and various support Slacks (like &lt;a href=&quot;https://www.rubyonrails.link&quot;&gt;Rails Link&lt;/a&gt;). I think there is a lot to the queue backend domain that won‚Äôt be learned by upfront analysis, and that can‚Äôt be easily bucketed into either ‚Äúthe library is doing it wrong‚Äù or ‚Äúthe developer is doing it wrong‚Äù There‚Äôs a lot of variation! (not to mention across JRuby,etc. and various database versions). I‚Äôm able to do things with GoodJob that I think is unlikely on a 1st party Rails queue backend (like cutting a new release after every patch and fix), and I‚Äôm able to stay oriented to the people and the problem they‚Äôre trying to solve over the technological solution itself. I hope all that can be preserved as these things move upstream.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That‚Äôs it! I‚Äôm probably forgetting stuff, so I‚Äôll reserve the right to keep adding to this list. I‚Äôd love to keep talking about this and hope that Solid Queue will be fantastic!&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Oh, and Solid Queue isn‚Äôt released yet, so if this seems compelling, &lt;a href=&quot;https://github.com/bensheldon/good_job&quot;&gt;use GoodJob&lt;/a&gt; in the meantime.&lt;/em&gt;&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2023/10/reflections-on-good-job-for-solid-queue&quot;&gt;Reflections on GoodJob for Solid Queue&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Tue, 10 Oct 2023 16:05:00 +0000</pubDate>
  <link>https://island94.org/2023/10/reflections-on-good-job-for-solid-queue</link>
  <guid isPermaLink="true">https://island94.org/2023/10/reflections-on-good-job-for-solid-queue</guid>
  
    <category>GoodJob</category>
  
    <category>Ruby</category>
  
  
</item>

      
    
      
        




<item>
  <title>Writing Object Shape friendly code in Ruby</title>
  <description>&lt;p&gt;Ruby 3.2 includes a performance optimization called Object Shapes, that changes how the Ruby VM stores, looks up, and caches instances variables (the variables that look like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@ivar&lt;/code&gt;) . YJIT also takes advantage of Object Shapes, and the upcoming Ruby 3.3 has further improvements that improve the performance of Object Shapes.&lt;/p&gt;

&lt;p&gt;This is a brief blog post about how to write your own Ruby application code that is optimized for Object Shapes. If instead you‚Äôd like to learn more about how Object Shapes is implemented in Ruby, watch &lt;a href=&quot;https://www.youtube.com/watch?v=R0oxlyVUpDw&quot;&gt;Aaron Patterson‚Äôs RubyConf 2022 video&lt;/a&gt; or read this &lt;a href=&quot;https://poddarayush.com/posts/object-shapes-improve-ruby-code-performance/&quot;&gt;explanation from Ayush Poddar&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Big thank you to my colleagues John Hawthorn and Matthew Draper for feedback on the coding strategies described here. And John Bachir, Nate Matykiewicz, Josh Nichols, and Jean Boussier whose conversation in &lt;a href=&quot;https://www.speedshop.co/rails-performance-workshop.html&quot;&gt;Rails Performance Slack&lt;/a&gt; inspired it.&lt;/em&gt;&lt;/p&gt;

&lt;h3 id=&quot;the-general-rule-define-your-instance-variables-in-the-same-order-every-time&quot;&gt;The general rule: define your instance variables in the same order every time&lt;/h3&gt;

&lt;p&gt;To take advantage of Object Shape optimizations in your own Ruby Code, the goal is to minimize the number of different shapes of objects that are created and minimize the number of object shape transitions that occur while your application is running:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Ensure that instances of the same class share the same object shape&lt;/li&gt;
  &lt;li&gt;Ensure that objects do not frequently or unnecessarily transition or change their shape&lt;/li&gt;
  &lt;li&gt;Help objects that &lt;em&gt;could&lt;/em&gt; share the same object shape (e.g. substitutable child classes) to do so, with reasonable effort and without compromising readability and maintainability.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This succinct explanation is from &lt;a href=&quot;https://poddarayush.com/posts/object-shapes-improve-ruby-code-performance/&quot;&gt;Ayush Poddar&lt;/a&gt;, and explains the conditions that allow objects to share a shape:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;New objects with the same [instance variable] transitions will end up with the same shape. This is independent of the class of the object. This also includes the child classes since they, too, can re-use the shape transitions of the parent class. But, &lt;strong&gt;two objects can share the same shape only if the order in which their instance variables are set is the same.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;That‚Äôs it, that‚Äôs what you have to do: if you want to ensure that two objects share the same shape, make sure they define their instance variables in the same order. Let‚Äôs start with a counterexample:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Bad: Object Shape unfriendly&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;GroceryStore&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fruit&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;apple&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;vegetable&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@vegetable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;broccoli&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# The &quot;Application&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;alpha_store&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;GroceryStore&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;alpha_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fruit&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# defines @fruit first&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;alpha_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;vegetable&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# defines @vegetable second&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;beta_store&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;GroceryStore&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;beta_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;vegetable&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# defines @vegetable first&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;beta_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fruit&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# defines #fruit second &lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this example, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alpha_store&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;beta_store&lt;/code&gt; do not share the same object shape because the order in which their instance variables are defined depends on the order the application calls their methods. This code is not Object Shape friendly.&lt;/p&gt;

&lt;h3 id=&quot;pattern-define-your-instance-variables-in-initialize&quot;&gt;Pattern: Define your instance variables in initialize&lt;/h3&gt;

&lt;p&gt;The simplest way to ensure instance variables are defined in the same order every time is to define the instance variables in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#initialize&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Good: Object Shape friendly&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;GroceryStore&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;apple&quot;&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@vegetable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# declare but assign later&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fruit&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;vegetable&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@vegetable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||=&lt;/span&gt;  &lt;span class=&quot;s2&quot;&gt;&quot;broccoli&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;del&gt;It‚Äôs also ok to define instance variables implicitly with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;attr_*&lt;/code&gt; methods in the class body, which has the same outcome of always defining the instance variables in the same order.&lt;/del&gt; &lt;strong&gt;Update&lt;/strong&gt;: Ufuk Kayserilioglu informed me that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;attr_*&lt;/code&gt; do not define the instance variable until they are first called, meaning that these methods or their associated instance variables should also be declared with a value in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#initialize&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Now I realize this is a very simplistic example, but that‚Äôs really all there is to it. If it makes you feel better, at GitHub where I work, we have classes with upwards of 200 instance variables. In hot code, where we have profiled, we go to a negligible effort of making sure those instance variables are defined in the same order; it‚Äôs really not that bad!&lt;/p&gt;

&lt;h3 id=&quot;pattern-null-memoization&quot;&gt;Pattern: Null memoization&lt;/h3&gt;

&lt;p&gt;Using instance variables to memoize values in your code may present a challenge when nil is a valid memoized value. This is a common pattern in Ruby that is not Object Shape friendly:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Bad: Object Shape unfriendly&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;GroceryStore&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fruit&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;defined?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;an_expensive_operation&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Rewrite this by creating a unique &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NULL&lt;/code&gt; constant and check for its presence instead:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Good: Object Shape friendly&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;GroceryStore&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;freeze&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# not strictly necessary, but makes it Ractor-safe&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;NULL&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fruit&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;unless&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;NULL&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@fruit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;an_expensive_operation&lt;/span&gt; 
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Alternatively, if you‚Äôre doing a lot of meta or variable programming and you need an arbitrary number of memoized values, use a hash and key check instead:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Good: Object Shape friendly&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;GroceryStore&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@produce&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;produce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@produce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@produce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;key?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@produce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;an_expensive_operation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;thats-it&quot;&gt;That‚Äôs it&lt;/h3&gt;

&lt;p&gt;Creating Object Shape friendly code is not very complicated!&lt;/p&gt;

&lt;p&gt;Please reach out if there‚Äôs other patterns I‚Äôm missing: bensheldon@gmail.com / &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;twitter.com/@bensheldon&lt;/a&gt; / &lt;a href=&quot;https://ruby.social/@bensheldon&quot;&gt;ruby.social/@bensheldon&lt;/a&gt;&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2023/10/writing-object-shape-friendly-code-in-ruby&quot;&gt;Writing Object Shape friendly code in Ruby&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Sun, 01 Oct 2023 15:05:00 +0000</pubDate>
  <link>https://island94.org/2023/10/writing-object-shape-friendly-code-in-ruby</link>
  <guid isPermaLink="true">https://island94.org/2023/10/writing-object-shape-friendly-code-in-ruby</guid>
  
    <category>Ruby</category>
  
  
</item>

      
    
  </channel>
</rss>
