<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Island94.org</title>
    <description>A Lost and Found
</description>
    <link>https://island94.org/</link>
    <atom:link href="https://island94.org/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Tue, 09 Jul 2024 07:06:26 +0000</pubDate>
    <lastBuildDate>Tue, 09 Jul 2024 07:06:26 +0000</lastBuildDate>
    <generator>Jekyll v4.3.3</generator>
    
    
      
        




<item>
  <title>On the importance of Rails code reloading and autoloading</title>
  <description>&lt;p&gt;I‚Äôve elevated to ‚Äústrongly held belief‚Äù that &lt;a href=&quot;https://island94.org/2024/04/a-ruby-meetup-and-3-podcasts&quot;&gt;code reloading and autoloading is &lt;em&gt;the&lt;/em&gt; most important design constraint&lt;/a&gt; when designing or architecting for Ruby on Rails.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Code reloading is what powers the ‚Äúmake a code change, refresh the browser, see the result‚Äù development loop.&lt;/li&gt;
  &lt;li&gt;Code autoloading is what allows Rails to boot in milliseconds (if you‚Äôve designed for it!) to run generators and application scripts and a single targeted test for tight test-driven-development loops.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;When &lt;a href=&quot;https://guides.rubyonrails.org/autoloading_and_reloading_constants.html&quot;&gt;autoloading and reloading&lt;/a&gt; just works, it probably isn‚Äôt something you think about. When code autoloading and reloading doesn‚Äôt work or works poorly, as it has on numerous apps across my career and consulting, it can be maddening:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Spending hours ‚Äúdebugging‚Äù some code only to realize that your changes were never being run at all.&lt;/li&gt;
  &lt;li&gt;Waiting tens of excruciatingly boring seconds to run a simple test or watching the browser churn away while it slowly waits for a response from the development server.&lt;/li&gt;
  &lt;li&gt;Feeling like you can write the code yourself each time faster than running a scaffold/template generator, repetitively over and over again.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Code reloading and autoloading not working correctly is a huge pain. It‚Äôs not great, at all!&lt;/p&gt;

&lt;p&gt;The history of code reloading and autoloading came up recently in the &lt;a href=&quot;https://www.railsspeed.com&quot;&gt;Rails Performance Slack&lt;/a&gt;. A  developer working on an old Rails application asked what Spork was (a forking preloader), and whether it was necessary (not necessarily). As a Rails Developer who is increasingly aware of my ~age~ experience (I started working with Rails in 2012, long after it first launched in 2004, but it‚Äôs still been a minute), I realized I had something to share.&lt;/p&gt;

&lt;p&gt;Over history, various strategies have been taken to make the development loop faster because that‚Äôs so important. Those strategies usually boil down to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Separating the (static) framework code from the (changing, developed) application code and only loading, just in time, what‚Äôs needed for the part of the application that‚Äôs currently running.&lt;/li&gt;
  &lt;li&gt;Loading/booting the framework code that is unlikely to change, and then only (re-)load the application code when invoking a command or running a test.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There have been various approaches to doing this:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Forking Preloaders (Spork, though Spring is the more contemporary version): load up the framework code in a process once, then fork into a subprocess when you invoke a command and reload just the application code. Sometimes, things can get out of sync (some application code or state pollutes the primary process), and things get weird/confusing. This is why you‚Äôll hear of people hating on Spring or complaining, ‚ÄúI wasted all day on a development bug, and it turns out I just needed to restart Spring‚Äù (the analogous ‚Äúit was DNS all along‚Äù of the Rails world).&lt;/li&gt;
  &lt;li&gt;Bootsnap, though operating on a cache strategy rather than a process-forker, serves a similar purpose of trying to speed up an application‚Äôs code loading time. The adoption of Bootsnap, and much, much faster CPUs in general, has largely replaced the usage of Spring in applications (though it‚Äôs still okay!).&lt;/li&gt;
  &lt;li&gt;Zeitwerk autoloader also plays a role in this history because it, too, is trying to ‚Äúsolve‚Äù the necessity of separating the framework code (which changes infrequently) from the application code during development (which is actively being changed) to produce faster development feedback cycles. Zeitwerk replaced the previous autoloader built into Rails, whose lineage seems to date all the way back to &lt;a href=&quot;https://github.com/bensheldon/rails/commit/ee014ef95ae9746b4228f3bc7c85ac0df28ba1df&quot;&gt;Rails 2.0 circa 2005&lt;/a&gt;. Tell me the history / raison d‚Äô√™tre of the original autoloader if you know it!&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Look, a lot of labor has gone into this stuff. It‚Äôs important! And it‚Äôs easy to get wrong and produce a slow and disordered application where development is a pain. It happens! A lot!&lt;/p&gt;

&lt;p&gt;I wish I could easily leave this post with some kind of &lt;em&gt;nugget&lt;/em&gt; of something actionable to do, but it‚Äôs really more like: &lt;strong&gt;please take care&lt;/strong&gt;. Some rules of thumb:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Don‚Äôt touch any constants in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;app/&lt;/code&gt;, or allow it to be touched (looking at you, custom Rack Middleware) unless you‚Äôre doing so from something in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;app/&lt;/code&gt; (or you &lt;em&gt;know&lt;/em&gt; is &lt;a href=&quot;https://island94.org/2023/05/whatever-you-do-don-t-autoload-rails-lib&quot;&gt;autoloaded&lt;/a&gt;).&lt;/li&gt;
  &lt;li&gt;Take care with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;config/initializers/&lt;/code&gt; and ensure you‚Äôre making the most of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ActiveSupport.on_load&lt;/code&gt; hooks. Rails may even be missing &lt;a href=&quot;https://guides.rubyonrails.org/engines.html#available-load-hooks&quot;&gt;some load hooks&lt;/a&gt;, so make an upstream PR if you need to configure an autoloaded object and you can‚Äôt. It‚Äôs super common to run into trouble; in writing this blog post alone, I discovered a &lt;a href=&quot;https://github.com/textacular/textacular/pull/159&quot;&gt;problem with a gem I use&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;If you‚Äôre writing library code, become familiar with the configuration-class-initializer-attribute-pattern dance (my name for it), which is how you‚Äôll get something like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;config.action_view.something = :the_thing&lt;/code&gt; lifted and constantized into &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ActionView::Base.something #=&amp;gt; TheThing&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You might find luck with this &lt;a href=&quot;https://gist.github.com/bensheldon/ba6532c4216c11dd9ba03487c5a06ee4&quot;&gt;bin/autoload-check script&lt;/a&gt;, that I adapted from something &lt;a href=&quot;https://www.johnhawthorn.com/&quot;&gt;John Hawthorn&lt;/a&gt; originally wrote, giving output like:&lt;/p&gt;

&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;‚ùå Autoloaded constants were referenced during during boot.
These files/constants were autoloaded during the boot process,
which will result in inconsistent behavior and will slow down and
may break development mode. Remove references to these constants
from code loaded at boot.

üö® ActionView::Base (action_view) referenced by config/initializers/field_error.rb:3:in `&amp;lt;main&amp;gt;&apos;
üö® ActiveJob::Base (active_job)   referenced by config/initializers/good_job.rb:7:in `block in &amp;lt;main&amp;gt;&apos;
üö® ActiveRecord::Base (active_record)
                                         /Users/bensheldon/.rbenv/versions/3.3.3/lib/ruby/gems/3.3.0/gems/activerecord-7.1.3.4/lib/active_record/base.rb:338:in `&amp;lt;module:ActiveRecord&amp;gt;&apos;
                                         /Users/bensheldon/.rbenv/versions/3.3.3/lib/ruby/gems/3.3.0/gems/activerecord-7.1.3.4/lib/active_record/base.rb:15:in `&amp;lt;main&amp;gt;&apos;
                                         .....
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/07/on-the-importance-of-rails-code-reloading&quot;&gt;On the importance of Rails code reloading and autoloading&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Sun, 07 Jul 2024 14:44:00 +0000</pubDate>
  <link>https://island94.org/2024/07/on-the-importance-of-rails-code-reloading</link>
  <guid isPermaLink="true">https://island94.org/2024/07/on-the-importance-of-rails-code-reloading</guid>
  
  
</item>

      
    
      
        




<item>
  <title>Introducing GoodJob v4</title>
  <description>&lt;p&gt;GoodJob version 4.0 has been released! üéâ GoodJob¬†v4 has breaking changes that should be addressed through a transitionary¬†v3.99¬†release, but if you‚Äôve kept up with v3.x releases and migrations, you‚Äôre likely ready to upgrade üöÄ&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://github.com/bensheldon/good_job?tab=readme-ov-file#upgrading-v3-to-v4&quot;&gt;README has an upgrade guide&lt;/a&gt;. If you‚Äôd like to leave feedback about this release, please comment on the &lt;a href=&quot;https://github.com/bensheldon/good_job/discussions/1396&quot;&gt;GitHub Discussions post üì£&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you‚Äôre not familiar with GoodJob, you can read the &lt;a href=&quot;https://island94.org/2020/07/introducing-goodjob-1-0&quot;&gt;introductory blog post&lt;/a&gt; from four years ago. We‚Äôve come pretty far.&lt;/p&gt;

&lt;h3 id=&quot;breaking-changes-to-job-schema&quot;&gt;Breaking changes to job schema&lt;/h3&gt;

&lt;p&gt;GoodJob v4 changes how job and job execution records are stored in the database; moving from job and executions being commingled in the¬†&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;good_jobs&lt;/code&gt;¬†table to Jobs (still in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;good_jobs&lt;/code&gt;) having many discrete Execution records in¬†the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;good_job_executions&lt;/code&gt; table.&lt;/p&gt;

&lt;p&gt;To safely upgrade, all unfinished jobs must use the new schema relationship, tracked in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;good_jobs.is_discrete&lt;/code&gt; column. This change was transparently introduced in GoodJob¬†&lt;a href=&quot;https://github.com/bensheldon/good_job/releases/tag/v3.15.4&quot;&gt;v3.15.4 (April 2023)&lt;/a&gt;, so your application is likely ready-to-upgrade already if you have kept up with GoodJob updates and migrations. You can check by running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;v3.99&lt;/code&gt;‚Äôs &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GoodJob.v4_ready?&lt;/code&gt; in production or run the following SQL query on the production database and check it returns zero: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SELECT COUNT(*) FROM &quot;good_jobs&quot; WHERE finished_at IS NULL AND is_discrete IS NOT TRUE&lt;/code&gt;. If not all unfinished jobs are stored in the new format, either wait to upgrade until those jobs finish or discard them. If you upgrade prematurely to v4 without allowing those jobs to finish, they may never be performed.&lt;/p&gt;

&lt;h3 id=&quot;other-notable-changes&quot;&gt;Other notable changes&lt;/h3&gt;

&lt;p&gt;GoodJob v4:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Only supports Rails 6.1+, CRuby 3.0+ and JRuby 9.4+, Postgres 12+. Rails 6.0 is no longer supported. CRuby 2.6 and 2.7 are no longer supported. JRuby 9.3 is no longer supported.&lt;/li&gt;
  &lt;li&gt;Changes job¬†priority¬†to give smaller numbers higher priority (default:¬†0), in accordance with Active Job‚Äôs definition of priority.&lt;/li&gt;
  &lt;li&gt;Enqueues and executes jobs via the¬†&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GoodJob::Job&lt;/code&gt;¬†model instead of¬†&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GoodJob::Execution&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Changes the behavior of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;config.good_job.cleanup_interval_jobs&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GOOD_JOB_CLEANUP_INTERVAL_JOBS&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;config.good_job.cleanup_interval_seconds&lt;/code&gt;, or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GOOD_JOB_CLEANUP_INTERVAL_SECONDS&lt;/code&gt; set to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nil&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;‚Äù &lt;/code&gt; to no longer disable count- or time-based cleanups. Instead, now set to¬†&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;false&lt;/code&gt;¬†to disable, or¬†&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-1&lt;/code&gt;¬†to run a cleanup after every job execution.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;new-features&quot;&gt;New Features&lt;/h3&gt;

&lt;p&gt;GoodJob v4 does not introduce any new features on its own. In the 110 releases since GoodJob v3.0 was released (June, 2022), these new features and improvements have been introduced:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/bensheldon/good_job#batches&quot;&gt;Batches&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Bulk enqueueing including support for Active Job‚Äôs &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;perform_all_later&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/bensheldon/good_job?tab=readme-ov-file#labelled-jobs&quot;&gt;Labelled jobs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Throttling added to &lt;a href=&quot;https://github.com/bensheldon/good_job?tab=readme-ov-file#concurrency-controls&quot;&gt;Concurrency Controls&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Improvements to the &lt;a href=&quot;https://goodjob-demo.herokuapp.com/good_job/jobs&quot;&gt;Web Dashboard&lt;/a&gt;, including Dark Mode, performance dashboard, and improved UI,  and customizable templates.&lt;/li&gt;
  &lt;li&gt;Storage of error backtraces. Improved handling of job error conditions, including signal interruptions. Added &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GoodJob.current_thread_running?&lt;/code&gt;¬†and¬†&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GoodJob.current_thread_shutting_down?&lt;/code&gt; to support job iteration.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/bensheldon/good_job/pull/665&quot;&gt;Ordered Queues&lt;/a&gt;, &lt;a href=&quot;https://github.com/bensheldon/good_job/pull/727&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;queue_select_limit&lt;/code&gt;&lt;/a&gt; and further options for configuring queue order and performance.&lt;/li&gt;
  &lt;li&gt;Improvements to Cron / Repeating Jobs.&lt;/li&gt;
  &lt;li&gt;Operational improvements including &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemd&lt;/code&gt; integration, improved health checks.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;A huge thank you to 88 (!) GoodJob v3.x contributors üôáüèª&lt;/strong&gt; @afn, @ain2108, @aisayo, @Ajmal, @aki77, @alec-c4, @AndersGM, @andyatkinson, @andynu, @arnaudlevy, @baka-san, @benoittgt, @bforma, @BilalBudhani, @binarygit, @bkeepers, @blafri, @blumhardts, @ckdake, @cmcinnes-mdsol, @coreyaus, @DanielHeath, @defkode, @dixpac, @Earlopain, @eric-christian, @erick-tmr, @esasse, @francois-ferrandis, @frans-k, @gap777, @grncdr, @hahwul, @hidenba, @hss-mateus, @Intrepidd, @isaac, @jgrau, @jklina, @jmarsh24, @jpcamara, @jrochkind, @julienanne, @julik, @LucasKendi, @luizkowalski, @maestromac, @marckohlbrugge, @maxim, @mec, @metalelf0, @michaelglass, @mitchellhenke, @mkrfowler, @morgoth, @Mr0grog, @mthadley, @namiwang, @nickcampbell18, @padde, @patriciomacadden, @paul, @Pauloparakleto, @pgvsalamander, @remy727, @rrunyon, @saksham-jain, @sam1el, @sasha-id, @SebouChu, @segiddins, @SemihCag, @shouichi, @simi, @sparshalc, @stas, @steveroot, @TAGraves, @tagrudev, @thepry, @ur5us, @WailanTirajoh, @yenshirak, @ylansegal, @yshmarov, @zarqman&lt;/p&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/07/introducing-goodjob-v4&quot;&gt;Introducing GoodJob v4&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Sun, 07 Jul 2024 04:44:00 +0000</pubDate>
  <link>https://island94.org/2024/07/introducing-goodjob-v4</link>
  <guid isPermaLink="true">https://island94.org/2024/07/introducing-goodjob-v4</guid>
  
    <category>GoodJob</category>
  
    <category>Rails</category>
  
  
</item>

      
    
      
        




<item>
  <title>Rails Strict Locals, undefined `local_assigns`, and reserved keywords</title>
  <description>&lt;p&gt;&lt;strong&gt;Update: This has been mostly fixed upstream in Rails (Rails 8.0, I think) and &lt;a href=&quot;https://github.com/rails/rails/pull/52209&quot;&gt;documented in the Rails Guides&lt;/a&gt;.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Huge thank you to Vojta Drbohlav in the &lt;a href=&quot;https://www.railsspeed.com/&quot;&gt;Rails Performance Slack&lt;/a&gt; for helping me figure this out! üôá&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Things I learned today about a new-to-me Ruby on Rails feature:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Rail 7.1 added a feature called &lt;a href=&quot;https://blog.kiprosh.com/allow-template-to-set-strict-locals/&quot;&gt;‚ÄúStrict Locals‚Äù&lt;/a&gt; that uses a magic comment in ERB templates to declare required and optional local variables. It looks like this: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;%# locals: (shirts:, class: nil) %&amp;gt;&lt;/code&gt; which in this example means when rendering the partial, it must be provided a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;shirts&lt;/code&gt; parameter and optional &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;class&lt;/code&gt; parameter. Having ERB templates act more like callable functions with explicit signatures is a nice feature.&lt;/li&gt;
  &lt;li&gt;When using Rails Strict Locals, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_assigns&lt;/code&gt; variable &lt;a href=&quot;https://github.com/rails/rails/blob/4bb73233413f30fd7217bd7f08af44963f5832b1/actionview/lib/action_view/template.rb#L439-L444&quot;&gt;&lt;em&gt;is not defined&lt;/em&gt;&lt;/a&gt;. You can‚Äôt use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_assigns&lt;/code&gt;. You‚Äôll see an error that looks like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ActionView::Template::Error (undefined local variable or method &apos;local_assigns&apos; for an instance of #&amp;lt;Class:0x0000000130536cc8&amp;gt;)&lt;/code&gt;. &lt;strong&gt;This has been &lt;a href=&quot;https://github.com/rails/rails/pull/52209&quot;&gt;fixed&lt;/a&gt; üéâ though &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_assigns&lt;/code&gt; doesn‚Äôt expose default values.&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;This is a problem if your template has locals that are also Ruby reserved keywords like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;class&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;if&lt;/code&gt;, which can be accessed with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_assigns[:class]&lt;/code&gt; &lt;em&gt;unless you start using Strict Locals&lt;/em&gt;.
To access local variables named with reserved keywords in your ERB template when using Strict Locals, you can use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;binding.local_variable_get(:the_variable_name)&lt;/code&gt;, e.g., &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;binding.local_variable_get(:class)&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;binding.local_variable_get(:if)&lt;/code&gt;. &lt;strong&gt;This is still necessary if you want to access reserved keywords &lt;em&gt;with defaults&lt;/em&gt; because the defaults don‚Äôt show up in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_assigns&lt;/code&gt;.&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/06/rails-strict-locals-local_assigns-and-reserved-keywords&quot;&gt;Rails Strict Locals, undefined `local_assigns`, and reserved keywords&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Wed, 19 Jun 2024 22:21:00 +0000</pubDate>
  <link>https://island94.org/2024/06/rails-strict-locals-local_assigns-and-reserved-keywords</link>
  <guid isPermaLink="true">https://island94.org/2024/06/rails-strict-locals-local_assigns-and-reserved-keywords</guid>
  
  
</item>

      
    
      
        




<item>
  <title>Recently, June, 2024</title>
  <description>&lt;ul&gt;
  &lt;li&gt;I finished reading the &lt;a href=&quot;https://www.goodreads.com/series/243623-the-poppy-war&quot;&gt;Poppy Wars trilogy&lt;/a&gt;. It got tiresome by the end. I liked &lt;em&gt;Babel&lt;/em&gt; much more, and I‚Äôm probably reading &lt;em&gt;Yellowface&lt;/em&gt; next. I also read &lt;em&gt;Exit Interview&lt;/em&gt;, which was another thrilling entry to the canon of ‚Äúfantastically brilliant not-men who work in tech for whom it really should go better but unfortunately and predictably doesn‚Äôt‚Äù.&lt;/li&gt;
  &lt;li&gt;We saw &lt;a href=&quot;https://www.imdb.com/title/tt31520076/&quot;&gt;‚ÄúFilm is dead. Long live film!‚Äù&lt;/a&gt; at the Roxie. It was enjoyable, reminded me of my big-Cable-Access-TV-energy days, and also gave far too little screen time to hearing from the film collectors wives (yes, exactly) and children. I thought this was my first movie theater since Covid, but Angelina reminded me we saw the Barbie Movie in a theater.&lt;/li&gt;
  &lt;li&gt;I played Animal Well until the credits roll, and then I read the spoilers and have been going for completionism. Though I don‚Äôt imagine I‚Äôll get there before fully losing interest.&lt;/li&gt;
  &lt;li&gt;I joined the Program Committee for RubyConf in Chicago in November. We‚Äôre trying to get the Call for Papers/Speakers released this week. Should be a good one.&lt;/li&gt;
  &lt;li&gt;I started working on the GoodJob major version 4 release. It‚Äôs simply doing all the breaking changes that were previously warned about. A deprecation-warning made is debt unpaid. It‚Äôs not so bad.&lt;/li&gt;
  &lt;li&gt;With my friend Rob, I started volunteering on the backend of &lt;a href=&quot;https://www.knockfordemocracy.org&quot;&gt;Knock for Democracy&lt;/a&gt;. I occasionally see people try to make a Tolstoy-inspired statement like ‚ÄúHealthy applications are all the same, but unhealthy ones are each unhealthy in their own way‚Äù. But that‚Äôs not true! All the apps that need some TLC have the exact same problems as all the others. Surprise me for once!&lt;/li&gt;
  &lt;li&gt;At work I‚Äôm nearly, nearly done with performance feedback and promotion packets and calibrations and all that. It‚Äôs the stuff that I truly enjoy as a manager, and also is terrible because of everything that‚Äôs outside my control. I also got asked to draw up a Ruby sponsorship budget for the year, which is the most normal administrative thing I think I‚Äôve ever been asked in my (checks watch) 12 years of working in Bay Area tech.&lt;/li&gt;
  &lt;li&gt;I think the days of mobile apps for Day of the Shirt are numbered. I haven‚Äôt updated them ever since Apple rejected an update for the olde ‚ÄúSection 4.2: Minimum Functionality‚Äù thing, after like 8 freaking years in the App Store already. I did the olde ‚Äútalk to someone on the phone at Apple who unhelpfully can‚Äôt tell me what would be &lt;em&gt;enough&lt;/em&gt; functionality.‚Äù And so they‚Äôve just been sitting and recently I got an email from a user that it won‚Äôt install on their new Android phone. So that sucks. It was a pain (when I was doing it) to develop 3 separate versions of Day of the Shirt: web, iOS, and Android, so maybe this is a sign to probably just commit to the web.&lt;/li&gt;
  &lt;li&gt;A triple &lt;a href=&quot;https://www.epicurious.com/recipes/food/views/bolognese-meat-sauce-hazan&quot;&gt;recipe of bolognese&lt;/a&gt; is too much for my pot to handle.&lt;/li&gt;
&lt;/ul&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/06/recently-june-2024&quot;&gt;Recently, June, 2024&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Mon, 03 Jun 2024 03:56:00 +0000</pubDate>
  <link>https://island94.org/2024/06/recently-june-2024</link>
  <guid isPermaLink="true">https://island94.org/2024/06/recently-june-2024</guid>
  
  
</item>

      
    
      
        




<item>
  <title>A comment on Second Systems</title>
  <description>&lt;p&gt;I recently left this comment on a Pragmatic Engineer review of Fred Brook‚Äôs &lt;em&gt;Mythical Man Month&lt;/em&gt; in &lt;a href=&quot;https://newsletter.pragmaticengineer.com/p/what-changed-in-50-years-of-computing-8d0&quot;&gt;‚ÄúWhat Changed in 50 Years of Computing: Part 2‚Äù&lt;/a&gt;. This was what I reacted to:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;&lt;strong&gt;Software design and ‚Äúthe second-system effect‚Äù&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Brooks covers an interesting phenomenon in Chapter 5: ‚ÄúThe Second-System Effect.‚Äù He states that architects tend to design their first system well, but they over-engineer the second one, and carry this over-engineering habit on to future systems.&lt;/p&gt;

  &lt;blockquote&gt;
    &lt;p&gt;‚ÄúThis second system is the most dangerous system a [person] ever designs. When [they] do this and [their] third and later ones, [their] prior experiences will confirm each other as to the general characteristics of such systems, and their differences will identify those parts of [their] experience that are particular and not generalizable.‚Äù&lt;/p&gt;

    &lt;p&gt;The general tendency is to over-design the second system, using all the ideas and frills that were sidetracked on the first one.‚Äù&lt;/p&gt;
  &lt;/blockquote&gt;

  &lt;p&gt;I can see this observation making sense at a time when:&lt;/p&gt;

  &lt;ul&gt;
    &lt;li&gt;Designing a system took nearly a year&lt;/li&gt;
    &lt;li&gt;System designs were not circulated, pre-internet&lt;/li&gt;
    &lt;li&gt;Architects were separated from ‚Äúimplementers‚Äù&lt;/li&gt;
  &lt;/ul&gt;

  &lt;p&gt;Today, all these assumptions are wrong:&lt;/p&gt;

  &lt;ul&gt;
    &lt;li&gt;Designing systems takes weeks, not years&lt;/li&gt;
    &lt;li&gt;System designs are commonly written down and critiqued by others. We cover more in the article, Engineering Planning with RFCs, Design Documents and ADRs&lt;/li&gt;
    &lt;li&gt;‚ÄúHands-off architects‚Äù are increasingly rare at startups, scaleups, and Big Tech&lt;/li&gt;
  &lt;/ul&gt;

  &lt;p&gt;As a result, engineers design more than one or two systems in a year and get more feedback, so this ‚Äúsecond-system effect‚Äù is likely nonexistent.&lt;/p&gt;

&lt;/blockquote&gt;

&lt;p&gt;And this was my comment/reaction:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;I think the Second-System Effect is still very present.&lt;/p&gt;

  &lt;p&gt;I would say it most frequently manifests as a result of not recognizing Gall‚Äôs Law: ‚Äúall complex systems that work evolved from simpler systems that worked.‚Äù&lt;/p&gt;

  &lt;p&gt;What trips people up is usually that they start from a place of ‚ÄúX feature is hard to achieve in the current system‚Äù and then they start designing/architecting &lt;em&gt;for&lt;/em&gt; that feature and not recognizing all of the other table-stakes necessities and Chesterton Fences of the current system, which only are recognized and bolted on late in the implementation when it is more difficult and complicated.&lt;/p&gt;

  &lt;p&gt;The phrase ‚Äú10 years of experience, or 1 year of experience 10 times‚Äù comes to mind when thinking of people who only have the experience of implementing a new system once and trivially, and do not have the experience of growing and supporting and maintaining a system they designed over a meaningful lifecycle.&lt;/p&gt;

&lt;/blockquote&gt;

&lt;p&gt;Which also reminds me of a &lt;a href=&quot;https://www.simplermachines.com/exploration-tidying-ecto/&quot;&gt;recent callback&lt;/a&gt; to a &lt;a href=&quot;https://lethain.com/notes-on-tidy-first/&quot;&gt;Will Larson review of Kent Beck‚Äôs &lt;em&gt;Tidy First&lt;/em&gt;&lt;/a&gt; about growing software:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;I really enjoyed this book, and reading it I flipped between three predominant thoughts:&lt;/p&gt;

  &lt;ul&gt;
    &lt;li&gt;I‚Äôve never seen a team that works this way‚Äìdo any teams work this way?&lt;/li&gt;
    &lt;li&gt;Most of the ways I‚Äôve seen teams work fall into the ‚Äúnever tidy‚Äù camp, which is sort of an implicit belief that software can‚Äôt get much better except by replacing it entirely. Which is a bit depressing, if you really think about it&lt;/li&gt;
    &lt;li&gt;Wouldn‚Äôt it be inspiring to live in a world where your team believes that software can actually improve without replacing it entirely?&lt;/li&gt;
  &lt;/ul&gt;

&lt;/blockquote&gt;


  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/04/a-comment-on-second-systems&quot;&gt;A comment on Second Systems&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Tue, 09 Apr 2024 20:33:00 +0000</pubDate>
  <link>https://island94.org/2024/04/a-comment-on-second-systems</link>
  <guid isPermaLink="true">https://island94.org/2024/04/a-comment-on-second-systems</guid>
  
  
</item>

      
    
      
        




<item>
  <title>A Ruby Meetup and 3 Podcasts</title>
  <description>&lt;p&gt;&lt;img src=&quot;/uploads/2024/ruby-meetup-ben.jpg&quot; alt=&quot;Me standing on a small stage in front of a slide with 2 adoptable cats and the GitHub logo&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Last week I spoke at the &lt;a href=&quot;https://evilmartians.com/events/sf-bay-area-ruby-meetup&quot;&gt;SF Bay Area Ruby Meetup&lt;/a&gt;, which was hosted at GitHub HQ, which made for an easy commute for me. Here‚Äôs &lt;a href=&quot;https://www.youtube.com/watch?v=9-PWz9nbrT8&amp;amp;t=275s&quot;&gt;the video&lt;/a&gt; and &lt;a href=&quot;https://speakerdeck.com/bensheldon/an-ok-compromise-faster-development-by-designing-for-the-rails-autoloader&quot;&gt;the slides&lt;/a&gt;. My talk was entitled ‚ÄúAn OK compromise: Faster development by designing for the Rails autoloader‚Äù&lt;/p&gt;

&lt;p&gt;Also, I haven‚Äôt shared here the 3 podcasts I did over the past few years. Here they are:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.therubyonrailspodcast.com/383&quot;&gt;The Ruby on Rails Podcast&lt;/a&gt; from September, 2021.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=DJ9HIjLla_U&quot;&gt;GemRuby Show&lt;/a&gt; from September, 2023.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://topenddevs.com/podcasts/ruby-rogues/episodes/examining-goodjob-solidq-and-more-ruby-623&quot;&gt;The Ruby Rogues&lt;/a&gt; from January, 2024.&lt;/li&gt;
&lt;/ul&gt;


  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/04/a-ruby-meetup-and-3-podcasts&quot;&gt;A Ruby Meetup and 3 Podcasts&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Fri, 05 Apr 2024 23:44:00 +0000</pubDate>
  <link>https://island94.org/2024/04/a-ruby-meetup-and-3-podcasts</link>
  <guid isPermaLink="true">https://island94.org/2024/04/a-ruby-meetup-and-3-podcasts</guid>
  
    <category>Ruby</category>
  
    <category>media</category>
  
  
</item>

      
    
      
        




<item>
  <title>Rails Active Record: Will it bind?</title>
  <description>&lt;p&gt;Active Record, Ruby on Rail‚Äôs ORM, has support for Prepared Statements that work &lt;em&gt;if you structure your query for it&lt;/em&gt;. Because of my work on GoodJob, which can make a lot of nearly identical database queries every second to pop its job queue, I‚Äôve invested a lot of time trying to make those queries as efficient as possible.&lt;/p&gt;

&lt;p&gt;Prepared Statements are a database feature that allow the database to reuse query parsing and planning when queries are structurally the same. Prepared statements, at least in Postgres, are linked to the database connection/session and stored in memory in the database. This implies some things:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;There can be a &lt;strong&gt;performance benefit&lt;/strong&gt; to making queries ‚Äúpreparable‚Äù for Prepared Statements which Active Record will decide for you based on how a query is structured.&lt;/li&gt;
  &lt;li&gt;There can be a &lt;strong&gt;performance harm&lt;/strong&gt; (or at least non-useful database processing and &lt;a href=&quot;https://github.com/rails/rails/issues/14645&quot;&gt;memory growth&lt;/a&gt;) if your application produces a lot of preparable queries that are never reused again.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;By default, Rails will have the database store 1,000 queries (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;statement_limit: 1000&lt;/code&gt;). Many huge Rails monoliths (like GitHub, where I work) disable prepared statements (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;prepared_statements: false&lt;/code&gt;) because there is too much query heterogeneity to get a performance benefit and the database spends extra and unnecessary cycles storing and evicting unused prepared statements.  But that‚Äôs maybe not your application!&lt;/p&gt;

&lt;p&gt;Structurally similar queries can still have variable values inside of them: these are called &lt;strong&gt;bind parameters&lt;/strong&gt;. For example, in GoodJob, I want pop jobs that are scheduled to run right now. In SQL that might look like:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;good_jobs&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scheduled_at&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;2024-03-31 16:44:11.047499`
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That query has the downside of the timestamp changing multiple times a second as new queries are emitted. What I want to do is extract out the timestamp into a bind parameter (a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;?&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$1&lt;/code&gt; depending on the database adapter) instead of embedded in the query:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;good_jobs&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scheduled_at&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That‚Äôs the good stuff! That‚Äôs ideal and preparable üëç&lt;/p&gt;

&lt;p&gt;But that‚Äôs raw SQL, now how to do that in Active Record? In the following exploration, I‚Äôm using the private &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;to_sql_and_binds&lt;/code&gt; method in Active Record; I‚Äôm also using the private Arel API. This is all private and subject to change, so be sure to write some tests around this behavior if you do choose to use it.  Here‚Äôs some &lt;a href=&quot;https://github.com/bensheldon/rails_tricks/blob/6c686c987ee9996bbad8a6ade1f92184c5a9ebf6/bind_params.rb&quot;&gt;quick experiments&lt;/a&gt; I‚Äôve done:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;job&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;scheduled_at: &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;minutes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;ago&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Experiment 1: string with ?&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;scheduled_at &amp;lt; ?&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# =&amp;gt;  Job Load (0.1ms)  SELECT &quot;good_jobs&quot;.* FROM &quot;good_jobs&quot; WHERE (scheduled_at &amp;lt; &apos;2024-03-31 16:34:11.064614&apos;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:to_sql_and_binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;arel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Not a bind parameter&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Not preparable&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Experiment 2: Arel query with value&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;arel_table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;scheduled_at&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;lt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# =&amp;gt;  Job Load (0.1ms)  SELECT &quot;good_jobs&quot;.* FROM &quot;good_jobs&quot; WHERE scheduled_at &amp;lt; &apos;2024-03-31 16:34:11.064614&apos;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:to_sql_and_binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;arel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Not a bind parameter&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Yikes ü•µ&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Experiment 3: Arel query with QueryAttribute&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;arel_table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;scheduled_at&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;lt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Relation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;QueryAttribute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;scheduled_at&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;DateTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# =&amp;gt;  Job Load (0.1ms)  SELECT &quot;good_jobs&quot;.* FROM &quot;good_jobs&quot; WHERE scheduled_at &amp;lt; $1  [[&quot;scheduled_at&quot;, &quot;2024-03-31 16:34:11.064614&quot;]]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:to_sql_and_binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;arel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Looking good! üôå&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Yes! üëè&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That very last option is the good one because it has the bind parameter (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$1&lt;/code&gt;) and then the Active Record logger will show the values in the nested array next to the query. The successful combination uses:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Arel comparable syntax&lt;/li&gt;
  &lt;li&gt;Wrapping the value in an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ActiveRecord::Relation::QueryAttribute&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Note that many Active Record queries will automatically do this for you, but &lt;em&gt;not all of them&lt;/em&gt;. In this particular case, it‚Äôs because I use the ‚Äúless than‚Äù operator, whereas equality does make it preparable. &lt;strong&gt;You‚Äôll have to inspect each query yourself.&lt;/strong&gt; For example, it‚Äôs also necessary with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Arel#matches&lt;/code&gt;/&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ILIKE&lt;/code&gt;. It‚Äôs also possible to temporarily disable prepared statements within a block in the &lt;a href=&quot;https://github.com/rails/rails/blob/6f0d1ad14b92b9f5906e44740fce8b4f1c7075dc/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb#L368-L373&quot;&gt;undocumented&lt;/a&gt; (!) &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Model.connection.unprepared_statement { your_query }&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;The above code is true as of Rails 7.1. &lt;a href=&quot;https://github.com/rails/rails/pull/51139&quot;&gt;Jean Boussier has improved Active Record&lt;/a&gt; in newer (currently unreleased) Rails to also properly bind &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Job.where(&quot;scheduled_at &amp;lt; ?&quot;, Time.current)&lt;/code&gt; query syntax too üôá&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Update: I realized I didn‚Äôt try beginless/endless range values. Good news: they create bind parameters üéâ&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Experiment 4: beginless range&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;scheduled_at: &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# =&amp;gt;  Job Load (0.1ms)  SELECT &quot;good_jobs&quot;.* FROM &quot;good_jobs&quot; WHERE scheduled_at &amp;lt; $1  [[&quot;scheduled_at&quot;, &quot;2024-03-31 16:34:11.064614&quot;]]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Job&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:to_sql_and_binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;relation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;arel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;binds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Looking good! üôå&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;prepared&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eq&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# &amp;lt;-- Yes! üëè&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/03/rails-active-record-will-it-bind&quot;&gt;Rails Active Record: Will it bind?&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Sun, 31 Mar 2024 17:15:00 +0000</pubDate>
  <link>https://island94.org/2024/03/rails-active-record-will-it-bind</link>
  <guid isPermaLink="true">https://island94.org/2024/03/rails-active-record-will-it-bind</guid>
  
  
</item>

      
    
      
        




<item>
  <title>Low-effort prototyping</title>
  <description>&lt;p&gt;From Bunnie Hung‚Äôs blog about &lt;a href=&quot;https://www.bunniestudios.com/blog/?p=7035&quot;&gt;exploring and designing an infrared chip imaging rig&lt;/a&gt;. I thought this is an interesting distinction between ‚Äúlow-effort‚Äù and ‚Äúrapid‚Äù prototypes. I think the analogy in software would be a &lt;a href=&quot;https://wiki.c2.com/?WalkingSkeleton&amp;quot;&quot;&gt;‚ÄúWalking Skeleton&lt;/a&gt; that is production-like in architecture and deployment but does very little, versus building a demo using lightweight scripting and static site generators. (bolded text mine)&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;&lt;strong&gt;Sidebar: Iterate Through Low-Effort Prototypes (and not Rapid Prototypes)&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;With a rough idea of the problem I‚Äôm trying to solve, the next step is build some low-effort prototypes and learn why my ideas are flawed.&lt;/p&gt;

  &lt;p&gt;I purposely call this ‚Äúlow-effort‚Äù instead of ‚Äúrapid‚Äù prototypes. ‚ÄúRapid prototyping‚Äù sets the expectation that we should invest in tooling so that we can think of an idea in the morning and have it on the lab bench by the afternoon, under the theory that faster iterations means faster progress.&lt;/p&gt;

  &lt;p&gt;The problem with rapid prototyping is that it differs significantly from production processes. &lt;strong&gt;When you iterate using a tool that doesn‚Äôt mimic your production process, what you get is a solution that works in the lab, but is not suitable for production.&lt;/strong&gt; This conclusion shouldn‚Äôt be too surprising ‚Äì evolutionary processes respond to all selective pressures in the environment, not just the abstract goals of a project. For example, parts optimized for 3D printing consider factors like scaffolding, but have no concern for undercuts and cavities that are impossible to produce with CNC processes. Meanwhile CNC parts will gravitate toward base dimensions that match bar stock, while minimizing the number of reference changes necessary during processing.&lt;/p&gt;

  &lt;p&gt;So, I try to prototype using production processes ‚Äì but with low-effort. ‚ÄúLow-effort‚Äù means reducing the designer‚Äôs total cognitive load, even if it comes at the cost of a longer processing time. Low effort prototyping may require more patience, but also requires less attention. It turns out that prototyping-in-production is feasible, and is actually the standard practice in vibrant hardware ecosystems like Shenzhen. The main trade-off is that instead of having an idea that morning and a prototype on your desk by the afternoon, it might take a few days. And yes ‚Äì of course there ways to shave those few days down (already anticipating the comments informing me of this cool trick to speed things up) ‚Äì but &lt;strong&gt;the whole point is to not be distracted by the obsession of shortening cycle times, and spend more attention on the design. Increasing the time between generations by an order of magnitude might seem fatally slow for a convergent process, but the direction of convergence matters as much as the speed of convergence.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;More importantly, if I were driving a PCB printer, CNC, or pick-and-place machine by myself, I‚Äôd be spending all morning getting that prototype on my desk. &lt;strong&gt;By ordering my prototypes from third party service providers, I can spend my time on something else. It also forces me to generate better documentation at each iteration, making it easier to retrace my footsteps when I mess up.&lt;/strong&gt; Generally, I shoot for an iteration to take 2-4 weeks ‚Äì an eternity, I suppose, by Silicon Valley metrics ‚Äì but the two-week mark is nice because I can achieve it with almost no cognitive burden, and no expedite fees.&lt;/p&gt;

  &lt;p&gt;I then spend at least several days to weeks characterizing the results of each iteration. It usually takes about 3-4 iterations for me to converge on a workable solution ‚Äì about a few months in total. I know, people are often shocked when I admit to them that I think it will take me some years to finish this project.&lt;/p&gt;

  &lt;p&gt;A manager charged with optimizing innovation would point out that if I could cut the weeks out where I‚Äôm waiting to get the prototype back, I could improve the time constant on an exponential and therefore I‚Äôd be so much more productive: the compounding gains are so compelling that we should drop everything and invest heavily in rapid prototyping.&lt;/p&gt;

  &lt;p&gt;However, this calculus misses the point that I should be spending a good chunk of time evaluating and improving each iteration. &lt;strong&gt;If I‚Äôm able to think of the next improvement within a few minutes of receiving the prototype, then I wasn‚Äôt imaginative enough in designing that iteration.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;That‚Äôs the other failure of rapid prototyping: when there‚Äôs near zero cost to iterate, it doesn‚Äôt pay to put anything more than near zero effort into coming up with the next iteration. Rapid-prototyping iterations are faster, but in much smaller steps. In contrast, with low-effort prototyping, I feel less pressure to rush. My deliberative process is no longer the limiting factor for progress; I can ponder without stress, and take the time to document. This means I can make more progress every step, and so I need to take fewer steps.&lt;/p&gt;

&lt;/blockquote&gt;

  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/03/low-effort-prototyping&quot;&gt;Low-effort prototyping&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Tue, 26 Mar 2024 13:28:00 +0000</pubDate>
  <link>https://island94.org/2024/03/low-effort-prototyping</link>
  <guid isPermaLink="true">https://island94.org/2024/03/low-effort-prototyping</guid>
  
  
</item>

      
    
      
        




<item>
  <title>Farewell Brompt</title>
  <description>&lt;p&gt;I‚Äôm planning to shut down Brompt, which I previously wrote about in &lt;a href=&quot;https://island94.org/2008/04/Brompt-is-a-blog-reminder.html&quot;&gt;2008&lt;/a&gt;, &lt;a href=&quot;https://island94.org/2011/03/A-form-from-my-favorites.html&quot;&gt;2011&lt;/a&gt;, and &lt;a href=&quot;https://island94.org/2022/09/reflections-on-brompt-2022&quot;&gt;2022&lt;/a&gt;. I &lt;a href=&quot;https://github.com/bensheldon/brompt-archive&quot;&gt;archived the code&lt;/a&gt; on GitHub.&lt;/p&gt;

&lt;p&gt;Let‚Äôs do a final &lt;a href=&quot;#&quot; onclick=&quot;event.preventDefault(); c = Confetti(); c.initialize(); c.drop();&quot;&gt;confetti drop üéâ&lt;/a&gt; together.&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;Farewell üëã Brompt is shutting down&lt;/p&gt;

  &lt;p&gt;I have some sad news to share: I‚Äôm planning to shut down this service, Brompt, at the end of the month (February, 2024).&lt;/p&gt;

  &lt;p&gt;Shutting down Brompt means that you‚Äôll no longer receive these automated reminders for your blog or writing. I‚Äôve been running Brompt since 2008 and unfortunately, I haven‚Äôt been able to make it sustainable. You‚Äôre one of about 80 people who are still using the service, though I‚Äôm never sure if you or anyone ever opens the emails regularly.&lt;/p&gt;

  &lt;p&gt;Regardless of Brompt shutting down, I hope you‚Äôre doing well and I‚Äôd love to stay in touch. Send me an email at bensheldon@gmail.com or read my own blog at https://island94.org&lt;/p&gt;

  &lt;p&gt;All the best,&lt;/p&gt;

  &lt;p&gt;Ben (the person who made Brompt)&lt;/p&gt;

&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;/uploads/2024-02/brompt.jpg&quot;&gt;&lt;img src=&quot;/uploads/2024-02/brompt.jpg&quot; alt=&quot;Screenshots from Brompt&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;canvas id=&quot;canvas&quot; style=&quot;
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    pointer-events: none;
&quot;&gt;&lt;/canvas&gt;

&lt;script&gt;
// https://jsfiddle.net/hcxabsgh/
// Usage: window.confetti.drop();
window.Confetti = function () {
  // globals
  var canvas;
  var ctx;
  var W;
  var H;
  var mp = 150; //max particles
  var particles = [];
  var angle = 0;
  var tiltAngle = 0;
  var confettiActive = true;
  var animationComplete = true;
  var deactivationTimerHandler;
  var reactivationTimerHandler;
  var animationHandler;

  // objects

  var particleColors = {
    colorOptions: [&quot;DodgerBlue&quot;, &quot;OliveDrab&quot;, &quot;Gold&quot;, &quot;pink&quot;, &quot;SlateBlue&quot;, &quot;lightblue&quot;, &quot;Violet&quot;, &quot;PaleGreen&quot;, &quot;SteelBlue&quot;, &quot;SandyBrown&quot;, &quot;Chocolate&quot;, &quot;Crimson&quot;],
    colorIndex: 0,
    colorIncrementer: 0,
    colorThreshold: 10,
    getColor: function () {
      if (this.colorIncrementer &gt;= 10) {
        this.colorIncrementer = 0;
        this.colorIndex++;
        if (this.colorIndex &gt;= this.colorOptions.length) {
          this.colorIndex = 0;
        }
      }
      this.colorIncrementer++;
      return this.colorOptions[this.colorIndex];
    }
  }

  function confettiParticle(color) {
    this.x = Math.random() * W; // x-coordinate
    this.y = (Math.random() * H) - H; //y-coordinate
    this.r = RandomFromTo(10, 30); //radius;
    this.d = (Math.random() * mp) + 10; //density;
    this.color = color;
    this.tilt = Math.floor(Math.random() * 10) - 10;
    this.tiltAngleIncremental = (Math.random() * 0.07) + .05;
    this.tiltAngle = 0;

    this.draw = function () {
      ctx.beginPath();
      ctx.lineWidth = this.r / 2;
      ctx.strokeStyle = this.color;
      ctx.moveTo(this.x + this.tilt + (this.r / 4), this.y);
      ctx.lineTo(this.x + this.tilt, this.y + this.tilt + (this.r / 4));
      return ctx.stroke();
    }
  }

  // $(document).ready(function () {
  //   SetGlobals();
  //   InitializeConfetti();
  //
  //   $(window).resize(function () {
  //     W = window.innerWidth;
  //     H = window.innerHeight;
  //     canvas.width = W;
  //     canvas.height = H;
  //   });
  // });

  function SetGlobals() {
    canvas = document.getElementById(&quot;canvas&quot;);
    ctx = canvas.getContext(&quot;2d&quot;);
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
  }

  function InitializeConfetti() {
    particles = [];
    animationComplete = false;
    for (var i = 0; i &lt; mp; i++) {
      var particleColor = particleColors.getColor();
      particles.push(new confettiParticle(particleColor));
    }
    StartConfetti();
  }

  function Draw() {
    ctx.clearRect(0, 0, W, H);
    var results = [];
    for (var i = 0; i &lt; mp; i++) {
      (function (j) {
        results.push(particles[j].draw());
      })(i);
    }
    Update();

    return results;
  }

  function RandomFromTo(from, to) {
    return Math.floor(Math.random() * (to - from + 1) + from);
  }


  function Update() {
    var remainingFlakes = 0;
    var particle;
    angle += 0.01;
    tiltAngle += 0.1;

    for (var i = 0; i &lt; mp; i++) {
      particle = particles[i];
      if (animationComplete) return;

      if (!confettiActive &amp;&amp; particle.y &lt; -15) {
        particle.y = H + 100;
        continue;
      }

      stepParticle(particle, i);

      if (particle.y &lt;= H) {
        remainingFlakes++;
      }
      CheckForReposition(particle, i);
    }

    if (remainingFlakes === 0) {
      StopConfetti();
    }
  }

  function CheckForReposition(particle, index) {
    if ((particle.x &gt; W + 20 || particle.x &lt; -20 || particle.y &gt; H) &amp;&amp; confettiActive) {
      if (index % 5 &gt; 0 || index % 2 == 0) //66.67% of the flakes
      {
        repositionParticle(particle, Math.random() * W, -10, Math.floor(Math.random() * 10) - 20);
      } else {
        if (Math.sin(angle) &gt; 0) {
          //Enter from the left
          repositionParticle(particle, -20, Math.random() * H, Math.floor(Math.random() * 10) - 20);
        } else {
          //Enter from the right
          repositionParticle(particle, W + 20, Math.random() * H, Math.floor(Math.random() * 10) - 20);
        }
      }
    }
  }
  function stepParticle(particle, particleIndex) {
    particle.tiltAngle += particle.tiltAngleIncremental;
    particle.y += (Math.cos(angle + particle.d) + 3 + particle.r / 2) / 2;
    particle.x += Math.sin(angle);
    particle.tilt = (Math.sin(particle.tiltAngle - (particleIndex / 3))) * 15;
  }

  function repositionParticle(particle, xCoordinate, yCoordinate, tilt) {
    particle.x = xCoordinate;
    particle.y = yCoordinate;
    particle.tilt = tilt;
  }

  function StartConfetti() {
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
    (function animloop() {
      if (animationComplete) return null;
      animationHandler = requestAnimFrame(animloop);
      return Draw();
    })();
  }

  function ClearTimers() {
    clearTimeout(reactivationTimerHandler);
    clearTimeout(animationHandler);
  }

  function DeactivateConfetti() {
    confettiActive = false;
    ClearTimers();
  }

  function StopConfetti() {
    animationComplete = true;
    if (ctx == undefined) return;
    ctx.clearRect(0, 0, W, H);
  }

  function RestartConfetti() {
    ClearTimers();
    StopConfetti();
    reactivationTimerHandler = setTimeout(function () {
      confettiActive = true;
      animationComplete = false;
      InitializeConfetti();
    }, 100);

  }

  window.requestAnimFrame = (function () {
    return window.requestAnimationFrame ||
      window.webkitRequestAnimationFrame ||
      window.mozRequestAnimationFrame ||
      window.oRequestAnimationFrame ||
      window.msRequestAnimationFrame ||
      function (callback) {
        return window.setTimeout(callback, 1000 / 60);
      };
  })();

  return {
    initialize: function() {
      SetGlobals();
      InitializeConfetti();

      // $(window).resize(function () {
      //   W = window.innerWidth;
      //   H = window.innerHeight;
      //   canvas.width = W;
      //   canvas.height = H;
      // });
    },
    start: function() {
      RestartConfetti();
    },
    stop: function() {
      DeactivateConfetti();
    },
    drop: function(duration) {
      RestartConfetti();
      window.setTimeout(function() {
        DeactivateConfetti();
      }, duration || 1500);
    },
  }
};
&lt;/script&gt;


  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/02/farewell-brompt&quot;&gt;Farewell Brompt&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Wed, 14 Feb 2024 01:49:00 +0000</pubDate>
  <link>https://island94.org/2024/02/farewell-brompt</link>
  <guid isPermaLink="true">https://island94.org/2024/02/farewell-brompt</guid>
  
    <category>Brompt</category>
  
  
</item>

      
    
      
        




<item>
  <title>Replacing Devise with Rails `has_secure_password` and friends</title>
  <description>&lt;p&gt;I love the &lt;a href=&quot;https://github.com/heartcombo/devise&quot;&gt;Devise user-authentication gem&lt;/a&gt;. I‚Äôve used it for years, and I recently moved off of it in one of my personal apps and replaced it with Rails‚Äôs built-in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;has_secure_password&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;generates_secure_token&lt;/code&gt; and a whole bunch of custom controllers and helpers and code that I now maintain myself. &lt;strong&gt;I do not recommend this! User authentication is hard! Security is hard!&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;And‚Ä¶&lt;/strong&gt; maybe you need to walk the same path too. So I want to share what I learned through the process.&lt;/p&gt;

&lt;p&gt;Ok, so to back up, why did I do this?&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Greater compatibility with Rails &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main&lt;/code&gt;. My &lt;a href=&quot;https://github.blog/2023-04-06-building-github-with-ruby-and-rails/&quot;&gt;day job runs Rails &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main&lt;/code&gt;&lt;/a&gt;, and I‚Äôm more frequently contributing to Rails development; I‚Äôd like to run my personal projects on Rails &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;main&lt;/code&gt; too. When I looked back on upgrade-blocking gems, Devise (and its dependencies, like Responders) topped my list.&lt;/li&gt;
  &lt;li&gt;More creative onboarding flows. I‚Äôve twisted Devise quite a bit (it‚Äôs great!) to handle the different ways I want users to be able to register (elaborate onboarding flows, email-only subscriptions, optional passwords, magic logins). I‚Äôve already customized or overloaded nearly every Devise controller and many model methods, so it didn‚Äôt seem like such a big change anyway.&lt;/li&gt;
  &lt;li&gt;Hubris. I‚Äôve built enterprise auth systems from scratch, managed the Bug Bounty program, and worked with security researchers. I have seen and caused and fixed some shit. (Fun fact: I have been paid for reporting auth vulnerabilities on the bug bounty platforms themselves.) I know that even if it‚Äôs not a bad idea &lt;em&gt;for me&lt;/em&gt;, it‚Äôs not a great idea either. Go read &lt;a href=&quot;https://github.com/advisories?query=devise+ecosystem%3Arubygems&quot;&gt;all of the Devise-related CVEs&lt;/a&gt;; seriously, it‚Äôs a responsibility.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That last bit is why this blog post will not be like, ‚ÄúHere‚Äôs everything you need to know and do to ditch Devise.‚Äù Don‚Äôt do it! Instead, here‚Äôs some stuff I learned that I want to remember for the next app I work on.&lt;/p&gt;

&lt;h3 id=&quot;a-test-regime&quot;&gt;A test regime&lt;/h3&gt;

&lt;p&gt;I went back through all of my system tests for auth, and here is a cleaned-up, though not exhaustive list of my scenarios and assertions. It seems like a lot. It is! There are also unit tests for models and controllers and mailers and separate API tests for the iOS and Android apps. Don‚Äôt take this lightly! (Remember, many of these are specific to my custom onboarding flows).&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;When a new user signs up for an account
    &lt;ul&gt;
      &lt;li&gt;Their email is valid, present and stored; password is nil.&lt;/li&gt;
      &lt;li&gt;They are not confirmed&lt;/li&gt;
      &lt;li&gt;They receive a confirmation email&lt;/li&gt;
      &lt;li&gt;If not confirmed, registering again with the same email resends the confirmation email but does not leak account presence&lt;/li&gt;
      &lt;li&gt;If the email associated account already exists and is confirmed, sends a ‚Äúyou already have an account‚Äù email and does not leak account presence.&lt;/li&gt;
      &lt;li&gt;Following the link in the confirmation email confirms the new account and redirects to the account setup page.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user sets up their account
    &lt;ul&gt;
      &lt;li&gt;They can assign a username and password&lt;/li&gt;
      &lt;li&gt;A password cannot be assigned if a password already exists&lt;/li&gt;
      &lt;li&gt;A username cannot be assigned if a username already exists&lt;/li&gt;
      &lt;li&gt;If a username and password already exist, the setup page redirects to the account update page&lt;/li&gt;
      &lt;li&gt;The account update page redirects to the setup page if a username or password does not yet exist&lt;/li&gt;
      &lt;li&gt;Signing in with an unsetup account redirects to setup page&lt;/li&gt;
      &lt;li&gt;Resetting password with an unsetup account redirects to setup page&lt;/li&gt;
      &lt;li&gt;Adding a password invalidates reset-password links.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user updates their account
    &lt;ul&gt;
      &lt;li&gt;The current password is required to update email, username, or password.&lt;/li&gt;
      &lt;li&gt;When the email address is changed, a new confirmation email is sent out to that email address.&lt;/li&gt;
      &lt;li&gt;An email change confirmation can be confirmed with or without an active session.&lt;/li&gt;
      &lt;li&gt;If the email address is already confirmed by a different account, send the ‚Äúyou already have an account‚Äù email and do not leak account presence.&lt;/li&gt;
      &lt;li&gt;Multiple accounts can have the same unconfirmed email address.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user performs a password reset
    &lt;ul&gt;
      &lt;li&gt;Can‚Äôt be accessed with an active session&lt;/li&gt;
      &lt;li&gt;Link is invalidated after 20 minutes, or when email, or password changes.&lt;/li&gt;
      &lt;li&gt;Can be performed on an unsetup account&lt;/li&gt;
      &lt;li&gt;Confirms an email but not an email change&lt;/li&gt;
      &lt;li&gt;Signs in the user&lt;/li&gt;
      &lt;li&gt;Does not leak account presence&lt;/li&gt;
      &lt;li&gt;Is throttled to only send once a minute.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user performs or resends an email confirmation
    &lt;ul&gt;
      &lt;li&gt;Can be accessed with an active session.&lt;/li&gt;
      &lt;li&gt;Cannot resend confirmation of an email change without an active session.&lt;/li&gt;
      &lt;li&gt;Link is invalidated after 20 minutes, or when email, unconfirmed email, confirmed at, or password changes.&lt;/li&gt;
      &lt;li&gt;Signs in the user&lt;/li&gt;
      &lt;li&gt;Does not leak account presence&lt;/li&gt;
      &lt;li&gt;Is throttled to only send once a minute.&lt;/li&gt;
      &lt;li&gt;When user is already confirmed, send them an email with a link to reset their password&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;When a user signs into a session
    &lt;ul&gt;
      &lt;li&gt;Requires a valid email or username, and password&lt;/li&gt;
      &lt;li&gt;Cannot sign in with a nil, blank, or absent password param (unsetup account)&lt;/li&gt;
      &lt;li&gt;Session is invalidated when email or password changes.&lt;/li&gt;
      &lt;li&gt;Does not leak account presence with missing or invalid credentials&lt;/li&gt;
      &lt;li&gt;Redirects to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;session[:return_to]&lt;/code&gt; path if present, otherwise the root path.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;using-has_secure_password&quot;&gt;Using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;has_secure_password&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;This was a fairly simple change. I had to explicitly add &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bcrypt&lt;/code&gt; to the gemfile, and then add to my &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User&lt;/code&gt; model:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;alias_attribute&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:password_digest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:encrypted_password&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;has_secure_password&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:password&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I‚Äôll eventually rename the database column, but this was a zero-migration change.&lt;/p&gt;

&lt;p&gt;Also, you might need to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;validations: false&lt;/code&gt;  on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;has_secure_password&lt;/code&gt; and implement your own validations if you have custom onboarding flows like me. Read &lt;a href=&quot;https://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html&quot;&gt;the docs&lt;/a&gt; and the &lt;a href=&quot;https://github.com/rails/rails/blob/68eade83c87ae309191add6dfa4959d7d7e07464/activemodel/lib/active_model/secure_password.rb#L114&quot;&gt;Rails code&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;When authenticating on sign in, you‚Äôll want to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User.authenticate_by(email:, password:)&lt;/code&gt;, which is intended to avoid timing attacks.&lt;/p&gt;

&lt;h3 id=&quot;using-generates_token_for&quot;&gt;Using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;generates_token_for&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;generates_token_for&lt;/code&gt; methods are new in Rails 7.1 and &lt;a href=&quot;https://github.com/rails/rails/pull/44189&quot;&gt;really nice&lt;/a&gt;. They create a signed token containing the user id and additional matching attributes and it doesn‚Äôt need to be stored in the database:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;generates_token_for&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:email_confirmation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;expires_in: &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;minutes&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;confirmed_at&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unconfirmed_email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;generates_token_for&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:password_reset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;expires_in: &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;minutes&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I‚Äôll explain that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;password_salt&lt;/code&gt; in a bit.&lt;/p&gt;

&lt;p&gt;To verify this, you want to do use something like this: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User.find_by_token_for(:email_confirmation, value_from_the_link)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;btw security: when you put a link in an email message, you can only use a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GET&lt;/code&gt; , because emails can‚Äôt reliably submit web forms (some clients can, but it‚Äôs weird and unreliable). So your link is going to look like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://example.com/account/reset_password?token=blahblahblahblahblah&lt;/code&gt;. If there is any links to 3rd party resources like script tags or off-domain images, you will &lt;a href=&quot;https://portswigger.net/kb/issues/00500400_cross-domain-referer-leakage&quot;&gt;leak the token through the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;referrer&lt;/code&gt;&lt;/a&gt;  when the page is loaded with the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;?token=&lt;/code&gt; in the URL. &lt;a href=&quot;https://github.com/heartcombo/devise/pull/4366&quot;&gt;Devise never fixed it (üò±)&lt;/a&gt; . What you should do is take value out of the query param and put it in the session and redirect back to the same page without the query parameter and use the session value instead. (Fun fact: this is a bug bounty that got me paid.)&lt;/p&gt;
&lt;h3 id=&quot;authenticatable-salts&quot;&gt;Authenticatable salts&lt;/h3&gt;

&lt;p&gt;Here‚Äôs where I explain that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;password_salt&lt;/code&gt; value.&lt;/p&gt;

&lt;p&gt;There‚Äôs several places I‚Äôve mentioned where tokens and sessions should be invalidated when the account password changes. When &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bcrypt&lt;/code&gt; stores the password digest in the database, it also generates and includes a random ‚Äúsalt‚Äù value that changes every time the password changes. Comparing that salt is a proxy for ‚Äúdid the password change?‚Äù and it‚Äôs safer to embed that random salt in cookies and tokens instead of the user‚Äôs hashed password.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/heartcombo/devise/blob/e2242a95f3bb2e68ec0e9a064238ff7af6429545/lib/devise/models/database_authenticatable.rb#L15C6-L158C1&quot;&gt;Devise uses the first 29 characters&lt;/a&gt; of the encrypted password (which is technically the &lt;a href=&quot;https://en.wikipedia.org/wiki/Bcrypt#Description&quot;&gt;algorithm, cost and salt&lt;/a&gt;):&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;authenticatable_salt&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;encrypted_password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;29&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encrypted_password&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But it‚Äôs also possible to simply get the salt. I dunno if the difference matters (tell me!):&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# models/user.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;password_salt&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;BCrypt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;password_digest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_digest&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;a-nice-session&quot;&gt;A nice session&lt;/h3&gt;

&lt;p&gt;There‚Äôs a lot to write about creating sessions and remember-me cookies, that I won‚Äôt be writing here. The main thing to note is that I‚Äôm storing and verifying both the user id &lt;em&gt;and&lt;/em&gt; their password salt in the session; that means all of their session are invalidated when they change their password:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# app/controllers/application_controller.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;UNASSIGNED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;_yoursite_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;freeze&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;super&lt;/span&gt;
  &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;UNASSIGNED&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;sign_in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;current_user&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;unless&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;UNASSIGNED&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# Check if the user was already loaded by route helpers&lt;/span&gt;
  &lt;span class=&quot;vi&quot;&gt;@_current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;key?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                     &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                     &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                     &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by_id_and_password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In doing this project I learned that Rail‚Äôs cookies will magically serialize/deserialize arrays and hashes. I‚Äôve been manually and laboriously converting them into JSON strings &lt;em&gt;for years&lt;/em&gt; ü•µ&lt;/p&gt;

&lt;p&gt;btw, if that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;UNASSIGNED&lt;/code&gt; stuff is new to you, go read my &lt;a href=&quot;https://island94.org/2023/10/writing-object-shape-friendly-code-in-ruby&quot;&gt;Writing Object Shape friendly code in Ruby&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;rotating-active-sessions&quot;&gt;Rotating active sessions&lt;/h3&gt;

&lt;p&gt;This is a little &lt;em&gt;extra&lt;/em&gt; but I wanted the switchover to be transparent to users. To do so, I read from Devise‚Äôs active sessions and then create a session cookie using the new format. It looks something like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# controllers/application_controller.rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;before_action&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:upgrade_devise_session&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;upgrade_devise_session&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Devise session structure: [[USER_ID],&quot;AUTHENTICATABLE_SALT&quot;]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;signed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;signed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;signed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;unless&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# Depending on your deploy/rollout strategy ,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# you may want need to retain and dual-write both&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Devise and new user session values instead of this.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;cookies&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remember_user_token&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;id: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;sign_in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;devise_authenticatable_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_salt&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;route-helpers&quot;&gt;Route helpers&lt;/h3&gt;

&lt;p&gt;Devise mixes some nice helper methods into Rails‚Äôs routing DSL like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;authenticated&lt;/code&gt;; they‚Äôre even &lt;em&gt;necessary&lt;/em&gt; if you need to authenticate Rails Engines that can‚Äôt easily access the app‚Äôs ApplicationController methods. Here‚Äôs how to recreate them using &lt;a href=&quot;https://guides.rubyonrails.org/routing.html#advanced-constraints&quot;&gt;Route Constraints&lt;/a&gt; and monkeypatching &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ActionDispatch::Routing::Mapper&lt;/code&gt; (that‚Äôs &lt;a href=&quot;https://github.com/heartcombo/devise/blob/e2242a95f3bb2e68ec0e9a064238ff7af6429545/lib/devise/rails/routes.rb#L28&quot;&gt;how Devise does it&lt;/a&gt;)&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# app/constraints/current_user_constraint.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;CurrentUserConstraint&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;matches?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;matches?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@block&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;matches?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;key?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                      &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                      &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;USER_SESSION_KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                      &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;current_user&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by_id_and_password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password_salt&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@block&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;


&lt;span class=&quot;c1&quot;&gt;# config/routes.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;ActionDispatch&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Routing&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Mapper&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;authenticated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;constraints: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CurrentUserConstraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;unauthenticated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;constraints: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CurrentUserConstraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;blank?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;admin_only&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;constraints: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;CurrentUserConstraint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;admin?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;routes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;draw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;authenticated&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;resources&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:special_somethings&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because routing happens &lt;em&gt;before&lt;/em&gt; a controller is initialized, the current user is put into &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;request.env&lt;/code&gt; so that the controller won‚Äôt have to query it a second time from the database. This could also be done in a custom Rack Middleware.&lt;/p&gt;

&lt;p&gt;If you want to put stuff into not-the-session cookies, those cookies can be accessed via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;request.cookie_jar,&lt;/code&gt; e.g., &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;request.cookie_jar.permanent.encrypted[&quot;_my_cookie&quot;]&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&quot;closing-thoughts&quot;&gt;Closing thoughts&lt;/h3&gt;

&lt;p&gt;That was all the interesting bits for me. I also learned quite a bit poking around Dave Kimura‚Äôs &lt;a href=&quot;https://github.com/kobaltz/action_auth&quot;&gt;ActionAuth&lt;/a&gt; (thank you!), and am thankful for the many years of service I‚Äôve gotten from Devise.&lt;/p&gt;


  &lt;br&gt;&lt;br&gt;
  &lt;hr&gt;
  &lt;p&gt;
    This post, &lt;em&gt;&lt;a href=&quot;https://island94.org/2024/01/replacing-devise-with-rails-has_secure_password-and-friends&quot;&gt;Replacing Devise with Rails `has_secure_password` and friends&lt;/a&gt;&lt;/em&gt;, is published on &lt;a href=&quot;https://island94.org&quot;&gt;Island94.org&lt;/a&gt;.
    Tweet me at &lt;a href=&quot;https://twitter.com/bensheldon&quot;&gt;@bensheldon&lt;/a&gt; to discuss it.
  &lt;/p&gt;
</description>
  <pubDate>Sat, 27 Jan 2024 15:43:00 +0000</pubDate>
  <link>https://island94.org/2024/01/replacing-devise-with-rails-has_secure_password-and-friends</link>
  <guid isPermaLink="true">https://island94.org/2024/01/replacing-devise-with-rails-has_secure_password-and-friends</guid>
  
    <category>rails</category>
  
    <category>ruby</category>
  
  
</item>

      
    
  </channel>
</rss>
